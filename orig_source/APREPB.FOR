      SUBROUTINE APREPB
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 3, MODIFICATION 0 ***
C
      IMPLICIT REAL*8(A-H,O-Z)
      COMMON/AVST/VST(7200)
      DIMENSION DEFTAB(1000)
      EQUIVALENCE(VST(7200),DEFTAB(1000))
      DIMENSION D(1000)
      EQUIVALENCE (DEFTAB(1),D(1))
C               *          *          *          *          *
C***********************************************************************
C     DEFINE FUNCTIONS
      CRV(Q000FL)=50.0*(Q000FL-CENTER)/CURVRG+51.50001
      CRVA(Q001FL,Q002FL,Q003FL)=-(4.0*Q001FL+2.0*Q002FL)/(Q003FL*DSQRT(
     1(1.0+Q001FL**2)**3))
      SMAL(Q004FL)=DSIGN( DMAX1(DABS(Q004FL),1.D-9),Q004FL)
      TAN1(Q005FL,Q006FL)=(Q005FL-Q006FL)/(1.0+Q005FL*Q006FL)
      TAN2(Q007FL,Q008FL)=(Q007FL+Q008FL)/SMAL(1.0-Q007FL*Q008FL)
      DERV(Q009FL)=DSQRT((1.0+Q009FL*Q009FL)*(1.0+Q009FL*Q009FL)*(1.0+Q0
     109FL*Q009FL))
      CURV(Q010FL,Q011FL,Q012FL,Q013FL,Q014FL,Q015FL)=-(4.0*Q012FL+2.0*Q
     1013FL)/(Q015FL*                 DERV(Q012FL))-(2.0*Q010FL+4.0*Q011
     2FL)/(Q014FL*DERV(Q011FL))
      SLOPE(Q016FL,Q017FL,Q018FL,Q019FL,Q020FL,Q021FL)=(((Q018FL-Q016FL)
     1**2+(Q019FL-Q017FL)**2)                *(Q021FL-Q017FL)-((Q020FL-Q
     2016FL)**2+(Q021FL-Q017FL)**2)*(Q019FL-Q017FL))/SMAL(((Q018FL-Q016F
     3L)**2+      (Q019FL-Q017FL)**2)*(Q020FL-Q016FL)-((Q020FL-Q016FL)**
     42+(Q021FL-Q017FL)**2)*(Q018FL-Q016FL))
      SQRT(Q050FL) = DSQRT(Q050FL)
      ABS(Q) = DABS(Q)
C
C...  DEFINE TANF SO THAT ITS MAXIMUM MAGNITUDE IS 10**9
C
      TAN(Q022FL)=SIN(Q022FL)/(SIGN(AMAX1(ABS(COS(Q022FL)),1.D-9),COS(Q0
     122FL)))
C
C...  SPLINE FIT
C...  L=1,NO SLOPES
C...  L=2,SLOPE GIVEN AT FIRST POINT ONLY
C...  L=3,SLOPE GIVEN AT LAST POINT ONLY
C...  L=4,SLOPE GIVEN AT FIRST AND LAST POINTS
C
C
 8008 K=7*IDEFTB(11)-1
      SL1SQ = 0.
      MN=0
      IF(IDEFTB(22)+1)2,3,2
    2 IF(IDEFTB(K+9)+1)7,4,7
    4 L=2
      GO TO 991
    7 L=4
      GO TO 991
    3 IF(IDEFTB(K+9)+1)9,998,9
  998 L=1
      GO TO 991
    9 L=3
  991 N=20
C
C...  PASS CIRCLE THRU 3 PTS TO GET FIRST
C...  APPROXIMATION FOR SLOPES.
    8 DX2=SMAL(D(N+7)-D(N))
      DY2=D(N+8)-D(N+1)
      SL2SQ=DX2*DX2+DY2*DY2
   11 D(N+4)=SQRT(SL2SQ)
      D(N+3)=DY2/DX2
   13 N=N+7
   14 IF(L-5)15,17,15
   15 IF(N-27)16,17,16
   16 D(N-5)=(SL1SQ*DY2+SL2SQ*DY1)/SMAL(SL1SQ*DX2+SL2SQ*DX1)
   17 IF(N-K-7)18,24,24
   18 X2=X3
   19 Y2=Y3
      DX1=DX2
      DY1=DY2
      SL1SQ=SL2SQ
      GOTO8
   24 N=27
   25 B1=TAN1(D(N+2),D(N-4))
   26 IF(L-1)27,28,27
   27 IF(L-3)31,28,31
C
C...  FIND SLOPE AT FIRST PT BY REFLECTING ANGLE FROMSECOND PT
C
   28 A1=-B1
   29 D(22)=TAN2(D(23),A1)
   30 GOTO32
   31 A1=TAN1(D(N-5),D(N-4))
   32 A2=TAN1(D(N+2),D(N+3))
   33 IF(N-K)36,34,36
   34 IF(L-3)38,36,36
   36 B2=TAN1(D(N+9),D(N+3))
   37 GOTO40
   38 B2=-A2
   39 D(K+9)=TAN2(D(N+3),B2)
C
C...  CALCULATE DELTA CURVATURE AT EACH PT
C
   40 D(N+5)=CURV(A1,B1,A2,B2,D(N-3),D(N+4))
   41 N=N+7
   42 IF(N-K-7)43,46,46
   43 A1=A2
   44 B1=B2
   45 GOTO32
C
C...  FIND MAX. DELTA CURVATURE
C
   46 DCMAXP=0.0
   47 DCMAX=0.0
      DCL=.001
   48 N=27
   49 DCMAX=ABS(D(N+5))
   50 IF(DCMAX-DCMAXP)53,53,51
   51 DCMAXP=DCMAX
   52 J=N
   53 N=N+7
   54 IF(N-K-7)49,55,55
C
C...  CHECK MAX.D.C. WITH LIMIT(DCL),CHECK NO. OF
C...    ITERATIONS(MN) WITH LIMIT(4*K)
C
   55 IF(DCMAXP-DCL)8004,8004,56
   56 IF (MN-4*K) 57,8004,8004
C
C...  ADJUST SLOPE AT POINT(D(J),D(J-1)) OF MAX.D.C.
C...    ALSO,AT POINT(D(J-7),D(J-6)),AND POINT(D(J+7),D(D+8))
C
   57 A1=TAN1(D(J-5),D(J-4))
   58 B2=TAN1(D(J+9),D(J+3))
   59 A2=TAN1(D(J+2),D(J+3))
C
C... DCP = APPROXIMATION FOR FIRST DERIVATIVE OF DELTA CURVATURE
C... TO USE WITH NEWTONS METHOD FOR FINDING THE SLOPE WHICH MAKES
C... DELTA CURVATURE APPROXIMATELY ZERO
C
   60 DCP=-4.0*(D(J-3)+D(J+4))/(D(J-3)*D(J+4))
   61 I=1
   62 A2=A2-D(J+5)/DCP
   63 D(J+2)=TAN2(A2,D(J+3))
   64 B1=TAN1(D(J+2),D(J-4))
   65 D(J+5)=CURV(A1,B1,A2,B2,D(J-3),D(J+4))
   66 IF(ABS(D(J+5))-DCL)70,70,67
   67 IF(I-5)68,70,70
   68 I=I+1
   69 GOTO62
   70 N=J-7
   71 X2=A2
   72 Y2=B2
   73 X3=A1
   74 Y3=B1
C
C...  INCREASE COUNTER
C
   75 MN=MN+1
   76 IF(N-20)83,83,77
   77 A2=A1
   78 B2=B1
   79 A1=TAN1(D(N-5),D(N-4))
   80 B1=TAN1(D(N+2),D(N-4))
   81 D(N+5)=CURV(A1,B1,A2,B2,D(N-3),D(N+4))
   82 GOTO88
   83 IF(L-1)84,85,84
   84 IF(L-3)88,85,88
   85 A1=-B1
   86 D(22)=TAN2(D(23),A1)
   87 D(J+5)=CURV(A1,B1,A2,B2,D(J-3),D(J+4))
   88 N=J+7
   89 IF(N-K-7)90,96,96
   90 A1=X2
   91 B1=Y2
   92 A2=TAN1(D(N+2),D(N+3))
   93 B2=TAN1(D(N+9),D(N+3))
   94 D(N+5)=CURV(A1,B1,A2,B2,D(N-3),D(N+4))
   95 GOTO46
   96 IF(L-2)97,97,46
   97 A1=X3
   98 B1=Y3
   99 A2=X2
  100 B2=-A2
  101 D(K+9)=TAN2(D(J+3),B2)
  102 D(N+5)=CURV(A1,B1,A2,B2,D(J-3),D(J+4))
  103 GOTO46
 8004 RETURN
      END

