      SUBROUTINE ACANPT
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4,MODIFICATION 4 ***
      IMPLICIT REAL*8(A-H,O-Z)
       DIMENSION DEFANS(82)
       DIMENSION PTPP(7200),CANON(7200)
       COMMON/A1COM/REFSYS,NAME,NAME1,JSUBER,JSV,NAMSUB,KDBUG,INDXPT,
     1 LOOP,IFINI
       REAL*8 PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,TAPES2,
     1 TAPES3,TAPES4,PPNAME
       INTEGER PUNTAP
       INTEGER*2 NAMS2(2)
       INTEGER*4 VST4(14400)
       COMMON/ATAPTB/PROTAP,DUMTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,
     1 TAPES1,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
       EQUIVALENCE (CANTAP,SRFTAP)
      COMMON/AMXTAB/MAXTAB,MAXVS1,MAXVS2,MAXPTP,MAXSCL,MAXVS,
     1MAXVST,MXPTPP,MXCAN,MXSRCN,MAXSLR,MAXELM,MAXPOT
      COMMON/AVST/VST(7200)
      DIMENSION DEFTAB(1000)
       DIMENSION IDFSTO(170)
      EQUIVALENCE(VST(1),PTPP(1),CANON(1))
      EQUIVALENCE(VST(7200),DEFTAB(1000))
       EQUIVALENCE (VST(1),VST4(1))
      COMMON/A1PAS2/I,J,K,L,MOVLGE,KANMAX,ICANST,IOVREC,KANPTR,MDFTAB,
     1KANCNT,KAUX,KDFCNT,IDEFP,KPRCNT,MDFPRE,IPREP,KOVFLP,KSRFCT,KOVCNT,
     2LSCAN,IOVFLO,MAXCAN,IREF,ICANSC,NAMSTA,KANGO,LASPTP,ISUB,
     3LCOMP,LGEREC,IRECN,JREC,JNUM,KANCUR,KANCOT,KDFENT,KANPAR,LGELOC,
     4IDTMOV,ISPPRG,INDEXS,KPTP,KPTPCT,KLASTP,KLASCT,KPRNT
      COMMON/ADFSTO/DEFSTO(85),PARTNO(11)
      EQUIVALENCE(DEFSTO(4),DEFANS(1))
       EQUIVALENCE (DEFSTO(1),IDFSTO(1))
       EQUIVALENCE (NAMS2(1),NAMSUB)
      COMMON/ADEBUG/IDEBUG(3),KCANDF
      COMMON/ASCALR/SCALR(30),SURFTB(150),ISCWS,NSURF,LOCTEM,IARGTP
       DATA A/8HACANPUT /
C**   THIS ROUTINE PLACES A SURFACE DEFINITION INTO THE CANON TABLE. THE
C     DEFTAB AND TABCYL DEFPRE OVERLAY AREAS ARE USED AS AUXILIARY CANON
C     STORAGE AFTER THE LAST REFERENCE TO A LARGE SURFACE IN THE PART
C     PROGRAM. THE INPUT TO THE ROUTINE IS THE DEFSTO TABLE FOR A NORMAL
C     SURFACE, THE DEFTAB TABLE FOR A LARGE SURFACE AND THE DEFSTO TABLE
C     , THE SURFACE NAME IN THE VARIABLE NAME, AND THE SUBSCRIPT VALUE
C     IN THE VARIABLE NAMSUB.
C
C**** FLAGS USED BY THE ROUTINE****
C*    MAXTAB-MAXIMUM TABLE SIZE OF VST, PTPP, AND CANON.
C*    MOVLGE-0 IF LARGE SURFACE NOT PROCESSED THIS TIME.
C*    ICANST-INDEX TO START OF CANON=MAXVS+MAXPTP+1
C*    KANPTR-INDEX TO LAST CANON ENTRY+1
C*    KANMAX-MAXIMUM SIZE OF PRIMARY CANON AREA=MAXTAB-ICANST-199.
C     KANMAX=KANCNT IF CANON OVERFLOW IS USED.
C*    IOVFLO-SIZE OF CANON OVERFLOW AREA, ORIGINALLY=200. IF OVERFLOW
C     OCCURS  IOVFLO=MAXTAB-KANCNT-MAXVS-MAXPTP
C*    KANCNT-NUMBER OF ENTRIES IN CANON OR NUMBER OF ENTRIES IN CANON
C     OVERFLOW WHEN USED.
C*    MDFTAB-MAXIMUM SIZE OF DEFTAB AREA, =1000
C*    KDFCNT-NUMBER OF ENTRIES IN DEFTAB AUXILIARY CANON.
C*    IDEFP-INDEX TO LAST DEFTAB AUXILIARY CANON ENTRY+1, ORIGINALLY=39
C*    MDFPRE-SIZE OF TABCYL DEFPRE AUXILIARY CANON.
C*    IPREP-INDEX TO NEXT AVAILABLE LOCATION IN TABCYL DEFPRE AUXILIARY
C     CANON.
C*    KOVFLP-INDEX TO START OF CANON OVER FLOW AREA.
C*    KSRFCT-NO. OF SURFACES IN CANON OVERFLOW AREA.
C*    IOVREC- CURRENT RECORD NO. IN CANON OVERFLOW AREA.
C*    LSCAN-NO. OF LAST RECORD PLACED IN CANTAP FILE.
C*    KLREF-NO. OF TIMES LARGE SURFACE HAS BEEN PROCESSED BY PHASE 2.
C*    LASPTP-NO. OF TIMES LARGE SURFACE IS USED IN PART PROGRAM.
C
C...     TEST FOR WRITING OUT PRESENT RECORD TO MAKE ROOM FOR OLD ONE
         IF ( KANGO.NE.0 ) GO TO 225
C
       MOVLGE = 0
C...     GET LENGTH OF CANONICAL DEFINITION
       L = IDFSTO(2)
C...     CHECK FOR LARGE SURFACE OR PATTERN
            IF(IDFSTO(1).EQ.18) GO TO 1
            IF(IDFSTO(1).LT.50) GO TO 30
C
C...     THIS IS A LARGE SURFACE
    1  MOVLGE = 1
C
C...     TEST FOR NEXT RECORD NO. ALREADY ASSIGNED TO MATERIAL IN
C...     CANON OVERFLOW AREA
            IF(IOVREC.EQ.0) GO TO 20
            IF(KANCNT.EQ.0) GO TO 20
C...     YES - SET FLAG TO RETURN HERE AFTER CLEARING OVERFLOW BUFFER
       KANGO = -1
       GO TO 225
C
C...     WRITE LARGE SURFACE CANONICAL FORM ONTO FILE
   20  CALL ALSFPT
       KANGO = 0
            IF(JSUBER.NE.0) RETURN
C...  TEST FOR UNNAMED SURFACE
   30 IF (IDFSTO(5).EQ.0) GO TO 300
C...  CHECK STATUS OF VARIABLE SYMBOL
      CALL AVS2CK(J)
      NAME2 = 2*NAME - 1
C...  HAS SURFACE BEEN PREVIOUSLY DEFINED, STORED IN CANON
      IF(J.NE.1) GO TO 40
C
       KURNT = VST4(NAME2+1)
            IF(DEFSTO(1).NE.CANON(KURNT)) GO TO 45
       DO 35  I = 2,L
      CANON(KURNT+1) = DEFSTO(I)
   35  KURNT = KURNT + 1
      GO TO 265
C
C...     IS VARIABLE A SURFACE IN OVERFLOW FILE
   40       IF(J.EQ.6) GO TO 210
C...     NO - TEST FOR NOT YET PROCESSED IN PASS 2
            IF(J.EQ.7) GO TO 60
C
C     VARIABLE ILL-DEFINED
      JSUBER=139
      RETURN
   45  JSUBER = 1006
      RETURN
C
C     UPDATE NO. ENTRIES IN ALL CANON STORAGE
   60  MAXCAN = MAXCAN + L
C     CAN THIS SURFACE BE PLACED IN PRIMARY CANON
            IF(MAXCAN.GT.KANMAX) GO TO 190
C  80 YES, THIS SURFACE CAN BE PLACED IN PRIMARY CANON. SET NAMSUB=
C     CURRENT CANON INDEX.
   80 NAMSUB=KANPTR
C     UPDATE NUMBER OF ENTRIES IN CANON
      KANCNT=KANCNT+L
C     SET J TO INDICATE CANON FOR VST ENTRY
       J = 1
       IDEBUG(1) = 4
      IDEBUG( 2)=NAMSUB
      GO TO 240
C
C     CANON OVERFLOW PROCESSING IS NECESSARY
C 190 IS THIS THE FIRST TIME FOR CANON OVERFLOW PROCESSING
  190    IF ( IOVREC.NE.0 ) GO TO 210
C
C 200 THIS IS THE FIRST TIME FOR CANON OVERFLOW PROCESSING
  200 KANMAX = KANCNT
      KANCNT = 0
      IOVFLO = MAXTAB - KANPTR + 1
      KSRFCT = 0
      KANCUR= 1
      IOVREC = 1
C     SET INDEX FOR FIRST LOCATION IN OVERFLOW AREA
      KOVFLP=KANPTR
C
C 210 SET RELATIVE INDEX IN CANON OVERFLOW
  210 NAMSUB = KANPTR-KOVFLP
C     SET J TO INDICATE CANTAP IN VST ENTRY
       J = 6
       IDEBUG(1) = 4
C     UPDATE ENTRIES IN OVERFLOW STORAGE
      KANCNT=KANCNT+L
C     DOES THIS ENTRY CAUSE CANON OVERFLOW  SIZE  TO BE EXCEEDED
      IF(KANCNT.LE.IOVFLO)GO TO 230
C 220 THIS ENTRY CAUSES CANON OVERFLOW SIZE TO BE EXCEEDED. PLACE CANON
C     OVERFLOW AREA IN CANTAP FILE AND SET CANTAP RECORD NUMBER.
  220 CONTINUE
C     UPDATE RECORD NUMBER IN OVERFLOW AREA.
      KANCNT = KANCNT - L
C
C...     POSITION FILE FOR WRITING OF NEXT RECORD
  225  LGEREC = LGEREC + 1
       CALL ASERCH ( CANTAP,LGEREC,NAMSTA)
       CALL ATAPWT ( CANTAP,IERR,4,LGEREC,1,KSRFCT,1,KANCNT,1,CANON(KOVF
     1LP),KANCNT)
      IF(IERR.GE.0)  JSUBER = 177
      KANPTR=KOVFLP
      KANCNT = 0
       KSRFCT = 0
C...     BRANCH ON FLAG INDICATING REASON FOR CLEARING OF BUFFER
            IF(KANGO)  20, 228, 280
C
  228  KANCNT = L
      NAMSUB = 0
C 230 PLACE THIS SURFACE IN CANON OVERFLOW
  230  KSRFCT = KSRFCT + 1
      IDEBUG( 2)=KANPTR
C 240 MOVE SURFACE FROM DEFSTO TO CANON
  240 DO 250 I=1,L
      CANON(KANPTR)=DEFSTO(I)
  250  KANPTR = KANPTR + 1
C
C...     IS SURFACE ON OVERFLOW FILE
            IF(J.NE.6) GO TO 262
C...     YES - MUST PACK INDEX WITHIN OVERFLOW RECORD, AND RECORD
C...     NO., AS 2-BYTE ENTRIES TO GO INTO LOW-ORDER 4 BYTES OF
C...     VST CODE WORD FOR SURFACE
       NAMS2(1) = NAMSUB
       NAMS2(2) = LGEREC + 1
C...     UPDATE VST ENTRY TO DEFINED SYMBOL
  262  VST4(NAME2) = J
       VST4(NAME2+1) = NAMSUB
C
       KANCUR = LGEREC + 1
C     IS DEBUG FLAG ON
  265 IF(KDBUG )270,280,270
C 270 DEBUG FLAG IS ON
  270 IDEBUG( 3)=L
       CALL ADPRNT (A)
C     WRITE DEFSTO AREA
       IDEBUG(1) = 3
      IDEBUG( 2)=L
       CALL ADPRNT(0)
  280 KANGO = 0
  290 RETURN
C...  PUT CANON ENTRY FOR SURFACE IN TEMPORARY STORAGE
  300 DO 310 II = 1,L
      SCALR(ISCWS) = DEFSTO(II)
  310 ISCWS = ISCWS + 1
      GO TO 290
      END

