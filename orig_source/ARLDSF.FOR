      SUBROUTINE ARLDSF
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 0 ***
C
C...  RULED SURFACE PREPROCESSOR
C
      IMPLICIT REAL*8(A-H,O-Z)
       COMMON/A1COM/REFSYS,NAME,NAME1,JSUBER,JSV,NAMSUB,KDBUG,INDXPT,
     1 LOOP,IFINI
       REAL*8 PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,TAPES2,
     1 TAPES3,TAPES4,PPNAME
       INTEGER PUNTAP
       COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,
     1 TAPES1,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
      COMMON/AVST/VST(7200)
       DIMENSION DEFTAB(1000),IDFTAB(2000)
       EQUIVALENCE (VST(7200),DEFTAB(1000))
       EQUIVALENCE (DEFTAB(1),IDFTAB(1)),(IDFTAB(2),N)
C
       DIMENSION TMP(3),ATMP(3)
       DIMENSION KOUNT(20)
       DATA KOUNT    /4,5,5,8,8,11,11,8,11,11,4,0,5,11,0,0,0,0,0,0/
C
C...  MOVE DATA UP 30 LOCATIONS
C
       IN = N - 1
       DO 1  I = 1,IN
       NN = N - I + 1
 1    DEFTAB(NN+30)=DEFTAB(NN)
      N=N+30
       DO 101  I = 2,31
 101  DEFTAB(I)=0.
C
C...  SCAN INPUT
C
    2  NSTRT = 64
       NCNT = 6
    7  IDFTAB(NCNT) = NSTRT/2
      IF(IDFTAB(NSTRT)-3050) 3, 4, 999
C
    3       IF(IDFTAB(NSTRT-1).NE.0) GO TO 999
      IF(IDFTAB(NSTRT).LT. 3001) GO TO 999
      IF(IDFTAB(NSTRT).GT. 3020) GO TO 999
      NN = IDFTAB(NSTRT) - 3000
      IF(KOUNT(NN)) 999,999,5
    5  NSTRT = NSTRT + 2*KOUNT(NN)
      GOTO 6
C
    4  NSTRT = NSTRT + 2*(IDFTAB(NSTRT-1)+1)
C
    6  NCNT = NCNT + 2
            IF(N+1-NSTRT/2)  999, 8, 7
    8  IDFTAB(4) = NCNT/2 - 3
C
C...  CHECK FOR PROPER FORMAT
C
C
C...  RLDSRF/SURF,PNT,PNT,VCTR/PNT...
C
       NN = IDFTAB(6)*2
      IF(IDFTAB(NN)-3001) 999,999,9
 9    IF(IDFTAB(NN)-3050) 10,10,999
   10  IND = 8
       ASSIGN 131 TO IRET
       GO TO 25
C
  131  NN = IDFTAB(14)*2
      IF(IDFTAB(NN)-3001) 999,14,15
 15   IF(IDFTAB(NN)-3050) 16,16,999
C
C...  IS FORMAT ... PNT
C
   14       IF(IDFTAB(4)-5)  999, 211, 999
C
C...  IS FORMAT ... SRF,PNT,PNT,VCTR/PNT
C
   16       IF(IDFTAB(4)-8)  999, 18, 999
   18  IND = 16
       ASSIGN 211 TO IRET
       GO TO 25
C
C...     IF DEBUG FLAG ON, PRINT DEFTAB AREA
  211       IF(KDBUG.EQ.0) GO TO 23
       WRITE (IOUTAP,998) (DEFTAB(I),I=1,N)
   23  RETURN
  998  FORMAT(13H ** RLDSRF **/(7X,5Z18))
  999  JSUBER = 1002
       GO TO 211
C
   25  NN = IDFTAB(IND)*2
            IF(IDFTAB(NN).NE.3001) GO TO 999
       NN = IDFTAB(IND+2)*2
            IF(IDFTAB(NN).NE.3001) GO TO 999
       NN = IDFTAB(IND+4)*2
            IF(IDFTAB(NN)-3011)  28, 29, 28
   28       IF(IDFTAB(NN).NE.3001) GO TO 999
C
   29  NNA = IDFTAB(IND)
       NNB = IDFTAB(IND+2)
C
C...  IS(P-Q)**2 .GT. 1.E-4
C
   30  DO 31  I = 1,3
      NA=NNA+I
      NB=NNB+I
 31   TMP(I)=DEFTAB(NB)-DEFTAB(NA)
      CALL ADOT(TMP,TMP,A)
      IF(A-1.E-4) 997,997,32
 997  JSUBER=701
      GOTO 211
C
C...  NORM  V
C
   32  ND = NN/2
            IF(IDFTAB(NN)-3001)  42, 43, 42
C
C...  GENERATE  V
C
   43  DO 44  I = 1,3
      NA=NNA+I
       NB = ND + I
 44   ATMP(I)=DEFTAB(NB)-DEFTAB(NA)
      CALL ACROSS(TMP,ATMP,ATMP)
       CALL ACROSS(ATMP,TMP,DEFTAB(ND+1))
   42  CALL ANORM(DEFTAB(ND+1),DEFTAB(ND+1))
C
C...  IS NORM(P-Q) X V  .GT.  1.E-2
C
      CALL ANORM(TMP,TMP)
       CALL ACROSS(TMP,DEFTAB(ND+1),ATMP)
      CALL ADOT(ATMP,ATMP,A)
      IF(A-1.E-2) 996,996,33
 996  JSUBER=702
      GOTO 211
 33   GOTO IRET,(131,211)
      END

