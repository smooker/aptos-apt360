      SUBROUTINE ACANGT
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
      IMPLICIT REAL*8(A-H,O-Z)
       COMMON /ATMATY/XMAT4(16),XMAT3(16),XMAT2(16),XMAT1(16),TMATX(16)
       DIMENSION DEFANS(82),IDFSTO(170)
       DIMENSION PTPP(7200),CANON(7200)
       COMMON/A1COM/REFSYS,NAME,NAME1,JSUBER,JSV,NAMSUB,KDBUG,INDXPT,
     1 LOOP,IFINI
       REAL*8 PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,TAPES2,
     1 TAPES3,TAPES4,PPNAME
       INTEGER PUNTAP
       COMMON/A0CON/K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,K10,K11,K12,IBLANK
       COMMON/ATAPTB/PROTAP,DUMTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,
     1 TAPES1,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
       EQUIVALENCE (CANTAP,SRFTAP)
      COMMON/AVST/VST(7200)
      DIMENSION DEFTAB(1000)
      EQUIVALENCE(VST(1),PTPP(1),CANON(1))
      EQUIVALENCE(VST(7200),DEFTAB(1000))
      COMMON/ASCALR/SCALR(180),ISCWS,NSURF,LOCTEM,IARGTP
      COMMON/A2CLS7/PPSEQ1,PPSEQ2,ENAME,EINAME,IEREC,ISN
      COMMON/A1PAS2/I,J,K,L,MOVLGE,KANMAX,ICANST,IOVREC,KANPTR,MDFTAB,
     1KANCNT,KAUX,KDFCNT,IDEFP,KPRCNT,MDFPRE,IPREP,KOVFLP,KSRFCT,KOVCNT,
     2LSCAN,IOVFLO,MAXCAN,IREF,ICANSC,NAMSTA,KANGO,LASPTP,ISUB,
     3LCOMP,LGEREC,IRECN,JREC,JNUM,KANCUR,KANCOT,KDFENT,KANPAR,LGELOC,
     4IDTMOV,ISPPRG,INDEXS,KPTP,KPTPCT,KLASTP,KLASCT,KPRNT
      COMMON/ADFSTO/DEFSTO(85),PARTNO(11)
       EQUIVALENCE (DEFSTO(4),DEFANS(1)),(DEFSTO(1),IDFSTO(1))
      COMMON/ADEBUG/IDEBUG(3),KCANDF
      INTEGER AMDTOA,AEXTRA,AMATOD,AEXCH,AEXTRD
       DATA A,A1/8HACANGET1,8HACANGET2/
C**** THIS ROUTINE FINDS THE SURFACE REQUESTED AND PLACES IT IN A WORK
C     TABLE. IF THE SURFACE IS A LARGE SURFACE IT IS PLACED IN THE
C     DEFTAB TABLE, OTHERWISE IT IS PLACED IN THE DEFSTO TABLE.
C     THE PROGRAM EXPECTS THE VST INDEXOF THE SURFACE TO BE IN THE
C     VARIABLE NAME AND THE SUBSCRIPT  VALUE TO BE IN THE VARIABLE
C     NAMSUB. THE PROGRAM RESETS THE VARIABLE NAME TO THE ALPHAMERIC
C     NAME OF THE SYMBOL. IF THE SURFACE IS NOT DEFINED THE VARIABLE
C     NAMSTA IS SET TO NON-ZERO.
C*********                   *********                         *********
C**** FLAGS USED BY THE ROUTINE ****
C**   MOVLGE=0 IF LARGE SURFACE NOT 0PERATED ON FOR THIS CALL.
C**   IREF =0 IF KRFSYS=0,OTHERWISE A REFSYS MATRIX IS TO BE OBTAINED
C**   NAMSTA =0 IF NO ERROR OCCURS
C**   ENAME-SYMBOL ASSOCIATED WITH THIS SURFACE
C**   I-INDICATES STORAGE AREA FOR SURFACE(CANON,DEFTAB,ETC.)
C**   J-INDEX TO STORAGE AREA
C**   NAMSUB-CONTAINS SUBSCRIPT VALUE,0 IF NONE
C**   LCOMP-RECORD NUMBER FOR LARGE SURFACE CURRENTLY BEING PROCESSED
C**   LGEREC-RECORD NUMBER FOR LARGE SURFACE CURRENTLY IN DEFTAB
C**   LSCAN-RECORD NUMBER OF LAST LARGESURFACE PLACED IN SRFTAP FILE
C**   DEFTAB(1)-NUMBER OF PARAMETERS INCANONICAL FORM OF LARGE SURFACE
C**   IDEFP-INDEX TO DEFTAB INDICATING STARTING LOCATION WHERE LARGE
C     SURFACE IS TO BE PLACED
C**   IOVREC-RECORD NUMBER FOR CURRENT RECORD IN CANON OVERFLOW AREA
C**   KOVFLP-INDEX TO START OF CANON OVERFLOW
C**   JREC-RECORD NUMBER OF CANTAP FILE WHERE THIS SURFACE IS LOCATED
C**   JNUM-RELATIVE LOCATION IN CANTAP RECORD FOR THIS SURFACE
C**   KANCUR-CURRENT CANTAP RECORD NO. IN OVERFLOW AREA
C**   KANCOT-LENGTH OF CANTAP RECORD READ INTO OVERFLOW AREA
C**   KSRFCT-NUMBER OF SURFACES IN CANTAP RECORD IN OVERFLOW AREA
C**   KANPAR-NUMBER OF PARAMETERS IN CANONICAL FORM
C**   LGELOC-CORE LOCATION WHERE LARGE SURFACE IS STORED
C**   IDTMOV-IF NON-ZERO AND SURFACE ISLARGE SURFACE, DO NOT MOVE LARGE
C     SURFACE TO DEFTAB.
C
      MOVLGE=K0
      IREF=K0
C     MOVE CURRENT REFSYS MATRIX TO XMAT1
    5 DO 10 I=1,16
   10 XMAT1(I)=XMAT4(I)
C     GET VST NAME
   20 ERNAME=VST(NAME)
C     GET VARIABLE TYPE (I) WITH AVS2CK
      CALL AVS2CK(I)
C     GET J(SECOND 4 BYTES) OF VST SECOND ENTRY
      J=AEXTRA(VST(NAME),K4)
C     IS SYMBOL UNDEFINED OR INCORRECTLY DEFINED OR NOT PROCESSED
      IF(I.LT.K7) GOTO 80
C     YES,SYMBOL IS UNDEFINED OR INCORRECTLY DEFINED OR NOT PROCESSED
      GOTO 560
C  80 I CONTAINS TYPE OF VARIABLE,J CONTAINS TABLE INDEX, NAME CONTAINS
C     VST INDEX TO (I,J)
   80  GO TO (90,210,220,90,90,270),I
C
C  90 SURFACE IS STORED IN CANON
C     GET LENGTH OF CANONICAL FORM
   90 L=AEXTRA(CANON(J),K4)
C  90 GET SURFACE TYPE
      K=AMDTOA(CANON(J),K4)
      GOTO 180
C
C     GET RECORD NUMBER
  105  LCOMP = IDFSTO(8)
C...     TEST FOR ENOUGH SPACE FOR SURFACE IN DEFTAB AREA
            IF(IDFSTO(10).GE.1000-IDEFP) GO TO 420
       MOVLGE = 1
C 130 GET LARGE SURFACE FROM LGESRF FILE
  130 CALL ASERCH(SRFTAP,LCOMP,NAMSTA)
C     ERROR FROM ASERCH
      IF(NAMSTA.LT.K0) GO TO 150
C 140 ASERCH RETURNED ERROR CONDITION
  140 JSUBER=179
      RETURN
C 150 NO ERROR RETURNED BY ASERCH
  150 CALL ATAPRD(SRFTAP,NAMSTA,LCNT,K6,LSR,K1,LST,K1,LSC,K1,
     1ENAME, K1,SUB,K1 ,
     2DEFTAB(IDEFP+1),K0)
C     ERROR FROM ATAPRD
      IF(NAMSTA.LT.0) GOTO 170
C 160 ERR0R RETURNED FROM ATAPRD
  160 JSUBER=180
      RETURN
C 170 NO ERROR FOUND BY ATAPRD
C     SET LGELOC EQUAL TO INDEX FOR LARGE SURFACE IN DEFTAB
  170 LGELOC=IDEFP
      RETURN
C
  180 J=J-K1
C     IS THIS REFSYS LOOP
      IF(IREF.NE.K0) GO TO 380
C 190 MOVE SURFACE FROM CANON TO DEFSTO,NOT A REFSYS LOOP
  190 DO 200 I=K1,L
      J=J+K1
  200 DEFSTO(I)=CANON(J)
C...     TEST FOR A LARGE SURFACE
            IF(K.LT.50) GO TO 420
C 100 THIS IS A LARGE SURFACE
  100 IF(IDTMOV.EQ.K0)GO TO 105
      GO TO 420
C
C 210 THIS SYMBOL REFERENCES A SCALAR
  210 RETURN
C 220 SYMBOL REFERENCES A STATEMENT ID,ERROR
  220 JSUBER=111
      GO TO 570
C
C 270 SURFACE IS IN CANTAP FILE
C...     GET RELATIVE INDEX TO SURFACE IN RECORD
  270 JNUM = AMDTOA(J,2)
C...   GET NUMBER OF CANTAP RECORD CONTAINING SURFACE
      JREC = AEXTRA(J,2)
C     IS SURFACE IN CANON OVERFLOW AREA
         IF ( JREC.NE.KANCUR) GO TO 290
C 280 YES,SURFACE IS IN CANON OVERFLOW AREA
  280 J=JNUM+KOVFLP
      GO TO 90
C
C...     ANY INFORMATION TO BE SAVED FROM OVERFLOW AREA
 290  IF ( KANCNT.EQ.0 ) GOTO 310
C...  YES ... SAVE IT
      KANGO = 1
      CALL ACANPT
  310 J=KOVFLP
      CALL ASERCH(CANTAP,JREC,NAMSTA)
      IF(NAMSTA.GE.0) GO TO 140
      CALL ATAPRD(CANTAP,NAMSTA,KANCOT,K4,KANCUR,K1,KSRFCT,K1,IDUM,K1,
     1 CANON(J),K0)
      IF(NAMSTA.GE.0) GOTO 160
      GO TO  280
C
C 380 MOVE MATRIX FROM CANON TO XMAT2
  380 J = J + K3
      DO 390 I=K1,12
      J=J+1
  390 XMAT2(I)=CANON(J)
  415 IDEBUG(1)=K1
      GOTO 425
  420 IDEBUG(1)=K3
      IDEBUG(2)=L
C     IS DEBUG FLAG ON
  425 IF(KDBUG.EQ.0) GOTO 426
       CALL ADPRNT (A)
C 426 REFSYS MATRIX MANIPULATION
C     HAS THE REFSYS MATRIX FOR THIS SURFACE BEEN OBTAINED
  426 IF(IREF)500,430,510
C
C 430 GET THE RESYS MATRIX FOR THIS SURFACE
C     IS THE CURRENT MATRIX USED FOR THIS SURACE
  430 IF(DEFSTO(2).NE.REFSYS) GOTO 450
C 440 THE CURRENT MATRIX IS USED FOR THIS SURFACE
  440 RETURN
C 450 THE CURRENT MATRIX IS NOT USED FOR THIS SURFACE
C     IS THE BASIC REFERENCE SYSTEM USED FOR THIS SURFACE
  450 NSAVE=NAME
      NSUBSV=NAMSUB
      IF (DEFSTO(2).NE.0) GO TO 470
C 460 THE BASIC REFERENCE SYSTEM IS USED FOR THIS SURFACE
  460 J=33
      L=48
      GO TO 520
C
C 470 THE BASIC REFERENCE SYSTEM IS NOTUSED FOR THIS SURFACE
  470 IREF=K1
      IF(REFSYS.EQ.0.) IREF = -K1
  480 NAME=AMDTOA(DEFSTO(2),K4)
      NAMSUB=AEXTRA(DEFSTO(2),K4)
C     GO BACK THROUGH CANGET TO OBTAIN THE REFSYS MATRIX
      GOTO 20
C
C 500 USE THE CURRENT MATRIX FOR THIS SURFACE
  500 J=17
      L=32
      GO TO 520
C 510 THE CURRENT MATRIX IS NOT USED FOR THIS SURFACE
  510 CALL AMATM(K4)
      L=16
      J=K1
  520 K=K1
      NAME=NSAVE
         NAMSUB = NSUBSV
      DO 540 I=J,L
      TMATX(K)=XMAT3(I)
  540  K = K + 1
C...     IF PATTERN, DO NOT TRANSFORM TO PRESENT REFERENCE SYSTEM
C...     NOW - POINTS OF PATTERN WILL BE TRANSFORMED AS USED LATER
            IF(IDFSTO(1).EQ.18) GO TO 542
       CALL ATRFRM
C     IS DEBUG FLAG ON
  542       IF(KDBUG.EQ.0) GO TO 546
  545 IDEBUG( 1)=K3
      IDEBUG( 2)=AEXTRA(DEFSTO(1),K4)
       CALL ADPRNT (A1)
  546 RETURN
C
C 560 UNDEFINED SYMBOL
  560 JSUBER=101
  570 ENAME=ERNAME
      RETURN
      END

