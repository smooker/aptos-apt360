      SUBROUTINE TRUNC (X11,Y11,X22,Y22)
C  *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 0 ***
      IMPLICIT REAL*8 (A-H,O-Z)
C... THIS ROUTINE WILL CHECK THE LINE SEGMENT TO SEE IF IT IS TOTALLY
C... INSIDE THE PLOT FRAME.  IF THE LINE IS NOT, THEN THE ROUTINE WILL
C... TRUNCATE IT AT THE FRAME EDGE AND,IF REQUESTED,WILL PUT
C... AN ARROWHEAD ON THE END.
C....*******************************************************************
C***********************************************************************
       DOUBLE PRECISION   APOSTP,ATAPTB
       REAL*8 PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,TAPES2,
     1 TAPES3,TAPES4,PPNAME
       INTEGER PUNTAP
       COMMON/A0CON/K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,K10,K11,K12,IBLANK
       COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,
     1 TAPES1,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
       COMMON/ASISTM/IPTNLY,ITRCUT,IWAVEN,KFLAG1,LTVMIT,NCLREC,NOPOST,
     1 NOPLOT,NUMPST,NUMPTR,ICLPRT,INDEXX,IPLOTR,KFLAGS(9)
       COMMON/APOSTP/PPNAME(20)
      COMMON/A3FXD1/AMATI1(4,4),AMATI2(4,4),AMATI3(4,4),AMATRX(3,4),
     1AMTR(36),AN1,AN2,ANAME,AX,AX0,AXVEC(3),AY,AY0,CNTM(36),CNTMAT(3,4)
     2,CONT(3),COUNT(3),CSEQNO(1),DELX,DELY,DX,DY,F0,ORIGIN(3),PARRAY
     3(20),PARTNO(12),PNT(3),PPRINT(12),PPT(6),PT0(3),PTT(6),PTU(3),
     4SEQNO(1),SUB(5),SUB4(6),TAPSTO(250),TITL(8),TL,TMATRX(3,4),
     5TNTM(36),TOOLNG,TRAMAT(3,4),VEC(3),WORD,X0,X1,X2,X3,XNEW,
     6Y0,Y1,Y2,Y3,YNEW
      REAL*8 MOTION
      COMMON/A3FXD2/MOTION(8)
      COMMON/A3FXI1/IARROW,I1,I2,ICLWAS,ICOPY,IDPLOT,IDPLSQ,IFIRST,
     1IGODLT,INDN,INSTR1,INSTR2,IND2TB(160),INDOFF,INDTAB(160),
     2INDXNO(3),IPERSP,IPL5AX,IPLOTI,IPLOTX,IPLWAS,IPX,IPY,IRECNI(3),
     3IRECNO,IRECTP,IRET,IRETVR,ISUBSC,ISWMAC,ISWNOC,IT,
     4ITHPNT,ITRAFL,ITRUNC,JARROW,JCLPRT,JCOPY,JPTSW,
     5JSW,JTYPSW,JVECTR,KCLPRT,KCOPY,MAXCOP,MULTAX,
     6NCAMRA,NK,NNTAB,NRECNO,NTAB,NUMWDS,NURCNO,NX,NX0,
     7NX1,NX2,NX4,NX5,NXP,NY,NY0,NY1,NY2,NY4,NY5,NYP,
     8IFALMS,IWARMS,INTSEQ
       REAL*8 NUCLTP
      EQUIVALENCE   (NUCLTP,TAPES2)
C...********************************************************************
C....*******************************************************************
               X1 = X11
               X2 = X22
               Y1 = Y11
               Y2 = Y22
          ITRUNC = K0
C... DOES THE LINE HAVE LENGTH
       IF(DABS(X2-X1)+DABS(Y2-Y1))270,9999,270
C...  IS FIRST POINT RIGHT OF LEFT EDGE - LESS THAN MEANS NO. GO TRUNC.
  270          IF (PTU(IPX) - X1)                1000 , 275  , 275
C...  IS FIRST POINT LEFT OF RIGHT EDGE - LESS THAN MEANS NO. GO TRUNC.
  275          IF (X1 - PT0(IPX))                1000 , 280  , 280
C...  IS FIRST POINT BELOW TOP EDGE - LESS THAN MEANS NO. GO TRUNC.
  280          IF (PTU(IPY) - Y1)                1000 , 285  , 285
C...  IS FIRST POINT ABOVE BOTTOM EDGE - LESS THAN MEANS NO. GO TRUNC.
  285          IF (Y1 - PT0(IPY))                1000 , 290  , 290
C...  IS SECOND POINT RIGHT OF LEFT EDGE - LESS THAN MEANS NO. GO TRUNC.
  290          IF (PTU(IPX) - X2)                1000 , 295  , 295
C...  IS SECOND POINT LEFT OF RIGHT EDGE - LESS THAN MEANS NO.GO TRUNC.
  295          IF (X2 - PT0(IPX))                1000 , 300  , 300
C...  IS SECOND POINT BELOW TOP EDGE - LESS THAN MEANS NO. GO TRUNC.
  300          IF (PTU(IPY) - Y2)                1000 , 305  , 305
C...  IS SECOND POINT ABOVE BOTTOM EDGE - LESS THAN MEANS NO. GO TRUNC.
  305          IF (Y2 - PT0(IPY))                1000 , 330  , 330
C...  END POINTS ARE INSIDE FRAME - PLOT THE LINE SEGMENT.
  330            NX1 = NXV (X1)
                 NY1 = NYV (Y1)
                 NX2 = NXV (X2)
                 NY2 = NYV (Y2)
C...
C...   PLOT A LINE SEGMENT
       CALL LINEV (NX1,NY1,NX2,NY2)
C...  HAS THE LINE ALREADY BEEN TRUNCATED - EQUAL MEANS YES-GO PUT ARROW
               IF (ITRUNC - K1)                  9999 , 8000 , 9999
C...  HAS THE LINE BEEN TRUNCATED - LESS THAN MEANS NO.
 1000          IF (ITRUNC - K1)                  1050 , 9999 , 9999
C...  LINE SEGMENT IS NOT COMPLETELY INSIDE OF FRAME...TRUNCATE IT.
 1050            ITRUNC = K1
                 DELX = X2 - X1
                 DELY = Y2 - Y1
C...  DO WE CONSIDER THE Y LIMIT - EQUAL ZERO MEANS NO. CHECK X LIMIT.
               IF (DELY)                         1060 , 1160 , 1060
C...  COMPARE LINE SEGMENT WITH UPPER EDGE.
 1060            PARAM  = (PTU(IPY) - Y1) / DELY
C...  IF PARAM IS      MINUS THEN CHECK BOTTOM EDGE.
               IF (PARAM)                        1110 , 1070 , 1070
C...  IF PARAM IS GREATER THAN 1 THEN CHECK BOTTOM EDGE.
 1070          IF (PARAM - 1.0)                  1080 , 1080 , 1110
C...  LINE PIERCES TOP EDGE - COMPUTE NEW X VALUE AT TOP EDGE.
 1080            XNEW =  DELX * PARAM + X1
                 YNEW =  PTU(IPY)
C...  WAS THE FIRST POINT ABOVE TOP EDGE -LT MEANS 2ND PT,GT MEANS 1STPT
               IF (Y1 - PTU(IPY))                1100 , 1110 , 1090
C...  SET FIRST POINT TO NEW VALUE AND COMPARE LINE WITH BOTTOM EDGE.
 1090            X1 = XNEW
                 Y1 = YNEW
               GO TO    1105
C...  SET SECOND POINT TO NEW VALUE AND COMPARE WITH BOTTOM EDGE.
 1100            X2 = XNEW
                 Y2 = YNEW
 1105            DELX = X2 - X1
                 DELY = Y2 - Y1
C...  COMPARE LINE SEGMENT WITH LOWER EDGE.
 1110            PARAM = (PT0(IPY) - Y1) / DELY
C...  IF PARAM IS MINUS THEN CHECK RIGHT EDGE.
               IF (PARAM)                        1160 , 1120 , 1120
C...  IF PARAM IS GREATER THAN 1 THEN CHECK RIGHT EDGE.
 1120          IF (PARAM -1.0)                   1130 , 1130 , 1160
C...  LINE PIERCES BOTTOM EDGE - COMPUTE NEW X VALUE AT BOTTOM EDGE
 1130            XNEW = DELX * PARAM + X1
                 YNEW = PT0(IPY)
C...  WAS FIRST POINTBELOW BOT. EDGE - LT MEANS 1ST PT. GT MEANS 2ND PT.
               IF (Y1 - PT0(IPY))                1140 , 1160 , 1150
C...  SET FIRST POINT TO NEW VALUE AND COMPARE WITH RIGHT EDGE.
 1140            X1 = XNEW
                 Y1 = YNEW
               GO TO    1155
C...  SET SECOND POINT TO NEW VALUE AND COMPARE WITH RIGHT EDGE.
 1150            X2 = XNEW
                 Y2 = YNEW
 1155            DELX =  X2 - X1
                 DELY =  Y2 - Y1
C...  DO WE CONSIDER THE X LIMIT - EQUAL ZERO MEANS NO. SEE IF PT IN FRM
 1160          IF (DELX)                         1170 , 270  , 1170
C...  COMPARE LINE SEGMENT WITH RIGHT EDGE.
 1170            PARAM = (PTU(IPX) - X1) / DELX
C...  IF PARAM IS MINUS THEN CHECK LEFT EDGE.
               IF (PARAM)                        1220 , 1180 , 1180
C...  IF PARAM IS GREATER THAN 1 THEN CHECK LEFT EDGE.
 1180          IF (PARAM - 1.0)                  1190 , 1190 , 1220
C...  LINE PIERCES RIGHT EDGE - COMPUTE NEW Y VALUE AT RIGHT EDGE
 1190            XNEW = PTU(IPX)
                 YNEW = DELY * PARAM + Y1
C...  WAS FIRST POINT RIGHT OF RIGHT EDGE -LT MEANS 2ND PT. GT MEANS 1ST
               IF (X1 - PTU(IPX))                1210 , 1220 , 1200
C...  SET FIRST POINT TO NEW VALUE AND COMPARE WITH LEFT EDGE.
 1200            X1 = XNEW
                 Y1 = YNEW
               GO TO    1215
C...  SET SECOND POINT TO NEW VALUE AND COMPARE WITH LEFT EDGE.
 1210            X2 = XNEW
                 Y2 = YNEW
 1215            DELX =  X2 - X1
                 DELY =  Y2 - Y1
C...  COMPARE LINE SEGMENT WITH LEFT EDGE.
 1220            PARAM = (PT0(IPX) - X1) / DELX
C...  IF PARAM IS MINUS THEN SEE IF LINE SEGMENT TOTALLY IN FRAME.
               IF (PARAM)                         270 , 1230 , 1230
C...  IF PARAM GREATER THAN 1 THEN SEE IF LINE SEGMENT TOTALLY IN FRAME.
 1230          IF (PARAM - 1.0)                  1240 , 1240 , 270
C...  LINE PIERCES LEFT EDGE - COMPUTE NEW Y VALUE AT LEFT EDGE.
 1240            XNEW = PT0(IPX)
                 YNEW = DELY * PARAM + Y1
C...  WAS FIRST POINT LEFT OF LEFT EDGE - LT MEANS 1ST PT. GT MEANS 2ND.
               IF (X1 - PT0(IPX))                1250 , 270  , 1260
C...  SET FIRST POINT TO NEW VALUE AND CHECK IF SEGMENT INSIDE OF FRAME.
 1250            X1 = XNEW
                 Y1 = YNEW
               GO TO    270
C...  SET SECOND POINT TO NEW VALUE AND CHECK IF INSIDE OF FRAME.
 1260            X2 = XNEW
                 Y2 = YNEW
               GO TO    270
C***********************************************************************
C...
C...  LINE HAS BEEN TRUNCATED-PUT ARROW ON - IF IARROW IS NON-ZERO.
 8000          IF (IARROW)                       8020 , 9999 , 8020
 8020  CALL ARROW
 9999  RETURN
       END

