      SUBROUTINE ADFPRE
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4,MODIFICATION 4 ***
C
C
C...  THIS SUBROUTINE SETS UP THE INPUT DATA IN DEFTAB
C     FOR ALL THE DEFINITION PREPROCESSOR ROUTINES,
C     AND CALLS THE PROPER GEOMETRIC DEFINITION BASED
C     ON THE INPUT PARAMETER TYPE LIST. IF NO SUCH
C     DEFINITION EXISTS, JSUBER IS SET TO 1000.
C     IF NO ERROR HAS OCURRED IN THE DEFINITION,
C     ACANPT IS CALLED TO STORE NAMED SURFACES.
C     UNNAMED SURFACES OTHER THAN LARGE SURFACES
C     ARE STORED IN SURFTB. LARGE SURFACES RESIDE
C...  IN DEFTAB OR ON THE SRFTAP FILE.
C
      IMPLICIT REAL*8(A-H,O-Z)
       INTEGER PUNTAP
       INTEGER*2 KPROTP(400),KDFLST(1150)
       INTEGER*2 KDIREC(16)/7,8,10,13,19,22,24,24,26,26
     1 ,31,42,48,49,106,107/
       INTEGER IDAT(4)/8,10,0,9/
       INTEGER*2 KNCLUS,KARGPN,KARG(2)
       INTEGER*2 IN,IF,KTEMP(6),NIL,NID,IFNXT
       REAL*8 PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,TAPES2,
     1 TAPES3,TAPES4,PPNAME
       COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,
     1 TAPES1,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
       DIMENSION PTPP(7200),CANON(7200)
      DIMENSION IVST(14400)
       DIMENSION IPTPP(14400)
       DIMENSION DEFANS(82)
       DIMENSION IDFTAB(2000),IDFSTO(170),JPROTP(200)
       DIMENSION JTEMP(3)
       DIMENSION ITRAY(2)
       COMMON/A1COM/REFSYS,NAME,NAME1,JSUBER,JSV,NAMSUB,KDBUG,INDXPT,
     1 LOOP,IFINI
       INTEGER*4 DEFLST
      COMMON/AVST/VST(7200)
      DIMENSION DEFTAB(1000)
      EQUIVALENCE(VST(1),CANON(1),PTPP(1))
      EQUIVALENCE (VST(1),IVST(1))
       EQUIVALENCE (PTPP(1),IPTPP(1))
      EQUIVALENCE(VST(7200),DEFTAB(1000))
       EQUIVALENCE (DEFTAB(1),IDFTAB(1))
      COMMON/ASCALR/SCALR(180),ISCWS,NSURF,LOCTEM,IARGTP
      COMMON/A2CLS7/PPSEQ1,PPSEQ2,ENAME,EINAME,IEREC,ISN,DNSUB
      COMMON/A1PAS2/I,J,K,L,MOVLGE,KANMAX,ICANST,IOVREC,KANPTR,MDFTAB,
     1KANCNT,KAUX,KDFCNT,IDEFP,KPRCNT,MDFPRE,IPREP,KOVFLP,KSRFCT,KOVCNT,
     2LSCAN,IOVFLO,MAXCAN,IREF,ICANSC,NAMSTA,KANGO,LASPTP,ISUB,
     3LCOMP,LGEREC,IRECN,JREC,JNUM,KANCUR,KANCOT,KDFENT,KANPAR,LGELOC,
     4IDTMOV,ISPPRG,INDEXS,KPTP,KPTPCT,KLASTP,KLASCT,KPRNT
      COMMON/ADFSTO/DEFSTO(85),PARTNO(11)
      EQUIVALENCE(DEFSTO(4),DEFANS(1))
       EQUIVALENCE (IARGTP,KNCLUS,KARG(1)),(KARGPN,KARG(2))
       COMMON/ADFPRL/DEFLST(575)
       COMMON/APROTP/PROTP(102),PROSAV(102),NOWCLT,LSTPSV,INCORE
     1 ,JGORIT,SAVMOT
       COMMON/ADEBUG/IDEBUG(3),KCANDF
       EQUIVALENCE (DEFSTO(1),IDFSTO(1)),(PROTP(1),JPROTP(1))
       EQUIVALENCE (PTEMP,ITRAY(1),IT),(ITRAY(2),IL)
       EQUIVALENCE (JTEMP(1),KTEMP(1),IF),(KTEMP(2),IN)
       EQUIVALENCE (KTEMP(3),NIL),(KTEMP(4),NID)
       EQUIVALENCE (KTEMP(5),IFNXT)
       EQUIVALENCE (PROTP(1),JPROTP(1),KPROTP(1))
       EQUIVALENCE (DEFLST(1),KDFLST(1))
       EQUIVALENCE (IDAT(1),SKIPAR),(IDAT(3),ERRCOD)
C
      COMMON/A1STAB/STABLE(23)
C
       DATA A1 /8HADFPRE  /
C
      JSV=0
       MODEF = 0
C     SET FLAG TO PUT LARGE SURFACE IN DEFTAB
      IDTMOV=0
      LGELOC = 0
       KINDXP = 2*INDXPT - 1
C...     COMPUTE LIMIT INDEX FOR SCAN OF DEFINITION
       IPTLIM = INDEXS + KLASCT
C...     SAVE FLAG INDICATING WHETHER SURFACE DEFINED OR READ
       IREAD = IPTPP(KINDXP)
       LS = IPTPP(KINDXP+2)
C     GET SUBSCRIPT TYPE
       NAMSUB = IPTPP(KINDXP+3)
       INDXPT = INDXPT + 2
C     CHECK FOR NESTED, NAMELESS SURFACE
      IF(LS.NE.0) GOTO 10
C
C     NESTED, NAMELESS SURFACE - SAVE SURFTB INDEX
      ISCWS=NAMSUB
C     SET ERROR NAME TO ZERO
      EINAME=0.0D0
       GO TO 15
C
C     NOT NESTED, NAMELESS - GET VST INDEX OF NAME
   10  LS = IPTPP(KINDXP+5)
      ENAME=VST(LS)
C     SAVE NAME FOR POSSIBLE LATER ERRORS
      EINAME=ENAME
C     GET SUBSCRIPT VALUE, IF ANY
      CALL AGTSUB
      IF(JSUBER.EQ.0) GO TO 12
      JSV = -1
      CALL ADIAGM
C...     SAVE SUBSCRIPT
   12 NS = NAMSUB
      DNSUB=NAMSUB
C
C     GET SURFACE TYPE AND LENGTH OF CANONICAL FORM
   15  PTEMP = PTPP(INDXPT)
       INDXPT = INDXPT + 1
C     MOVE DEFINITION PARAMETERS TO DEFTAB
       IDEFP = 2
       INPR = 2
C
C...     TEST FOR CLASS 14 PTPP RECORD GENERATED BY ROUTINE AREAD -
C...     IF SO, GO TO SET UP FOR CANON DEFINITION INPUT
            IF(KLASTP.EQ.14) GO TO 41
C
C...     PICK UP PARAMETERS, STACK DATA IN DEFTAB, AND BUILD
C...     CODE STRING USED TO DETERMINE PROCESSING ROUTINE
   20       IF(KNCLUS.EQ.2) GO TO 22
       KNCLUS = 1
            IF(INDXPT.GT.IPTLIM) GO TO 105
C
C...     IF IN CANON REDEFINITION MODE, TEST PARAMETER FOR DOUBLE
C...     COMMA CODE - IF IT IS, MOVE STORING INDEX UP ONE PARAMETER
            IF(MODEF.NE.1) GO TO 22
            IF(PTPP(INDXPT).NE.SKIPAR) GO TO 22
C...     MOVE SCANNING INDEX PAST DOUBLE COMMA CODE
       INDXPT = INDXPT + 1
       GO TO 60
C
   22  KARGPN = 1
       JDEF = 2*IDEFP - 1
       CALL AGTARG(DEFTAB(IDEFP+1),1000-IDEFP,N)
C
C...     BRANCH ON DEFINITION MODE - NORMAL, OR CANON INPUT
C...     OR REDEFINITION
            IF(MODEF.EQ.0) GO TO 24
C
C...     CANON INPUT OR REDEFINITION - PARAMETER MUST BE A SCALAR
            IF(N.EQ.1) GO TO 60
C...     IT IS NOT - ERROR
       JSUBER = 83
       GO TO 90
C
C...     NORMAL DEFINITION - BRANCH ON PARAMETER TYPE
   24       IF(N-6)  26, 28, 92
   26  GO TO (35,30,86,28,40),N
C...     INVALID PARAMETER
   28  JSUBER = 132
       GO TO 90
C
C...     SURFACE - PUT DEFTAB LOCATION AND SURFACE TYPE CODE INTO LIST
   30  ISC = IDFSTO(1)
       IDFTAB(JDEF) = 0
       IDFTAB(JDEF+1) = ISC + 3000
       KPROTP(INPR-1) = ISC + 200
       KPROTP(INPR) = IDEFP
       ISL = IDFSTO(2) - 3
C...     IF THIS IS A LARGE SURFACE, LENGTH IS IN IDFSTO(10)
            IF(ISC.LT.50) GO TO 32
       ISL = IDFSTO(10)
C      SET LENGTH AND TYPE IN DEFTAB FOR LARGE SURFACES
       IDFTAB(JDEF) = ISL
C...     INCREASE DEFTAB POINTER BY LENGTH OF CANONICAL FORM
   32  IDEFP = IDEFP + ISL + 1
      GOTO 95
C
C...     SCALAR - PUT DEFTAB LOCATION AND SCALAR CODE INTO LIST
   35  KPROTP(INPR-1) = 300
       KPROTP(INPR) = IDEFP
       GO TO 58
C
C...     VOCABULARY - TEST CODE FOR SPECIAL VALUES...
   40  ISC = IDFTAB(JDEF+3)
C...     TEST FOR CANON
            IF(ISC.NE.3099) GO TO 50
C...     IT IS - IS MODIFIER FIRST INPUT PARAMETER
           IF(INPR.NE.2) GO TO 43
C...    YES - SET FLAG FOR CANON DEFINITION
   41 MODEF = -1
           IF(IT.EQ.18) GO TO 162
C... 'CANON' DEFINITION VALID IF RULED SURFACE READ IN
           IF(IT.EQ.53.AND.KLASTP.EQ.14) GO TO 42
C...     IF DEFINING A LARGE SURFACE, ADJUST STORING INDEX
            IF(IT.LT.50) GO TO 20
            IF((IT.GT.54).OR.(IT.EQ.53)) GO TO 162
   42  IDEFP = 1
       GO TO 20
C
C...     CANON NOT FIRST PARAMETER - IF NOT SECOND, FOLLOWING A
C...     SURFACE, TREAT STATEMENT AS NORMAL DEFINITION
   43       IF(INPR.NE.4) GO TO 50
            IF(KPROTP(1).GE.300) GO TO 44
            IF(KPROTP(1).GT.200) GO TO 45
   44  JSUBER = 79
       GO TO 90
C
C...     SEE IF TYPES OF INPUT SURFACE AND ONE BEING DEFINED MATCH
   45       IF(KPROTP(1)-200.EQ.IT) GO TO 46
       JSUBER = 80
       GO TO 90
C
C...     SET FLAG FOR CANON REDEFINITION
   46  MODEF = 1
C...     SAVE LENGTH OF SURFACE FOR PARAMETER COUNT TESTS
       LENGTH = IDEFP - 1
C...     ADJUST STORING INDEX TO START REPLACING PARAMETERS
       IDEFP = 2
C...     IF LARGE SURFACE OR PATTERN BEING REDEFINED, PICK UP
C...     LENGTHS - FOR PATTERN, ALSO READ IN ORIGINAL ONE
            IF(IT.LT.18) GO TO 20
C...     LOCATE ORIGINAL DEFINITION ON LARGE SURFACE FILE
   47  CALL ASERCH(SRFTAP,IDFSTO(8),JTM)
C...     TEST FOR ERROR IN FILE SEARCH OPERATION
            IF(JTM.LT.0) GO TO 48
       JSUBER = 840
       GO TO 190
C...     READ IN PATTERN DEFINITION
   48  CALL ATAPRD(SRFTAP,JTM,JTM2,3,IDFSTO(60),3,DEFSTO(62),2
     1 ,DEFTAB(2),0)
C...     TEST FOR ERROR READING IN PATTERN
            IF(JTM.LT.0) GO TO 49
       JSUBER = 841
       GO TO 190
C...     GET LENGTHS OF CANON BLOCK AND DATA
   49  IL = IDFSTO(2)
       LENGTH = IDFSTO(10) + 1
       IDEFP = 1
       GO TO 20
C
C...     VOCAB. IS NOT CANON - TEST IT FOR DIRECTIONAL MODIFIER
   50  DO 55  J = 1,16,2
            IF(ISC-KDIREC(J))  55, 54, 52
   52       IF(ISC.GT.KDIREC(J+1)) GO TO 55
   54  ISC = 121
       GO TO 56
   55  CONTINUE
C
C...     ADD CODE FOR VOCABULARY TO DEFINITION PATTERN LIST
   56  KPROTP(INPR-1) = ISC
       KPROTP(INPR) = IDEFP
C
C...     MOVE VOCABULARY WORD OR SCALAR TO PROPER POSITION
   58  DEFTAB(IDEFP) = DEFTAB(IDEFP+1)
       DEFTAB(IDEFP+1) = 0.0D0
C
   60  IDEFP = IDEFP + 1
      GOTO 95
C
C     PARAMETER STRING TOO LONG
 80   JSUBER=84
       GO TO 190
C
C...     ILLEGAL FORMAT (PUNCTUATION FOUND)
   86  JSUBER = 131
C
C...     OUTPUT ERROR DIAGNOSTIC FOR THIS PARAMETER
   90       IF(JSUBER.EQ.0) GO TO 92
       CALL ADIAGM
      IF(JSV.NE.0) GO TO 95
   92  JSV = 1
C
C     DO NOT BUILD UP LIST FOR LARGE SURFACES
   95       IF(IT.LT.50) GO TO 98
            IF(INPR.GT.6) GO TO 20
   98  INPR = INPR + 2
       GO TO 20
C
C     HAVE ANY PARAMETERS BEEN IN ERROR
  105       IF(JSV.NE.0) GO TO 190
C...     PUT LENGTH OF INPUT IN DEFTAB(1)
       IDFTAB(1) = 0
       IDFTAB(2) = IDEFP - 1
       INPR = INPR - 2
            IF(KDBUG.EQ.0) GO TO 106
C
C     DEBUG IS ON - PRINT DEFTAB AREA
       IDEBUG(1) = 5
       IDEBUG(2) = 1
       IDEBUG(3) = IDEFP
       CALL ADPRNT(A1)
       IDEBUG(1) = 13
       IDEBUG(2) = (INPR+3)/4
       CALL ADPRNT(0)
C
C...     TEST FOR CANON DEFINITION OR REDEFINITION
  106      IF(MODEF) 107, 108, 109
C...     CANON DEFINITION - TEST FOR LARGE SURFACES
  107       IF(IT.LT.50) GO TO 1075
       JIT = IT - 49
       GO TO (1300,1300,1075,1305,1300),JIT
C
C...     NO - TEST FOR PROPER NUMBER OF PARAMETERS
 1075       IF(IDEFP+1-IL)  80, 176, 80
C
C...     IF DEFINITION UNNAMED (NESTED), OR IF CANON DEFINITION
C...     FLAG ON, SKIP REDEFINITION TEST
  108       IF(LS.EQ.0) GO TO 110
            IF(KCANDF.NE.0) GO TO 110
C...     TEST FOR ALREADY-DEFINED (OR ATTEMPTED) SYMBOL
       NAME = LS
       NAMSUB = NS
       CALL AVS2CK(J)
            IF(J.EQ.7) GO TO 110
            IF(J.EQ.10) GO TO 110
       JSUBER = 1002
       GO TO 190
C
C...     CANON REDEFINITION - TEST FOR TOO MANY INPUT PARAMETERS
  109       IF(IDEFP.GT.LENGTH) GO TO 80
C...     NO - BRANCH ON NORMAL OR LARGE SURFACE TYPE (OR PATTERN)
C...     TO STORE IT
       IDFTAB(2) = LENGTH
            IF(IT.EQ.18) GO TO 190
            IF(IT-50)  176, 190, 190
C
C...     GET SURFACE TYPE
  110  ISC = IT
C...     IF DEFINING A LARGE SURFACE, SKIP INPUT FORMAT SEARCH,
C...     AND GO TO SET CANON BLOCK LENGTH AND ADJUST BRANCHING INDEX
            IF(IT.GE.50) GO TO 165
C
C...     GET NUMBER OF DEFINITION FORMATS LISTED FOR THIS SURFACE
C...     AND INDEX TO FIRST PARAMETER IN FORMAT LIST FOR THIS TYPE
       JTEMP(1) = DEFLST(ISC)
C...     IF NO FORMATS LISTED FOR THIS SURFACE TYPE, SKIP THE
C...     SEARCH OPERATION
            IF(IN.EQ.0) GO TO 170
C
C     LOOK THROUGH THIS DEFINITION LIST
       DO 160  JJ = 1,IN
C     GET NO. OF ITEMS IN LIST FOR THIS DEF.
C...     AND NUMBER OF ITEMS IN DEFTAB FOR THIS DEFINITION
       JTEMP(2) = DEFLST(IF)
       NID = NID + 1
C     GET ROUTINE BRANCHING INDEX
C...     AND LOCATION OF NEXT DEFINITION IN THIS LIST
       JTEMP(3) = DEFLST(IF+1)
       NR = KTEMP(6)
       IF = IF + 1
C     IS LENGTH OF DATA UNIQUE (NID.EQ.1, NO)
      IF(NID.EQ.1) GOTO 115
C...     SEE IF NO. OF WORDS USED IN DEFTAB MATCHES THIS FORMAT
            IF(NID.NE.IDFTAB(2)) GO TO 160
C...     YES - DO NO. OF ITEMS OF INPUT MATCH
  115       IF(NIL.NE.INPR/2) GO TO 160
C
C     YES - CHECK LIST ITEM BY ITEM
       IF = IF + 1
       INPL = INPR/2
       DO 150  II = 1,INPL
  120  JTM = 2*IF - 1
       JTM2 = 2*II - 1
            IF(DEFLST(IF).GT.0) GO TO 140
C...     SEVERAL PARAMETER TYPES POSSIBLE - CHECK ALL
       JTM3 = KDFLST(JTM)
            IF(IABS(JTM3).NE.KPROTP(JTM2)) GO TO 125
            IF(KDFLST(JTM+1).EQ.0) GO TO 130
            IF(KDFLST(JTM+1).EQ.KPROTP(JTM2+1)) GO TO 130
  125  IF = IF + 1
      GOTO 120
C
C     SURFACE TYPES MATCH - DISREGARD OTHER POSSIBILITIES
  130  IF = IF + 1
            IF(DEFLST(IF).LT.0) GO TO 130
      GOTO 150
C
  140       IF(KDFLST(JTM+1).NE.0) GO TO 145
C     CHECK CODE ONLY - NOT LOCATION IN DEFTAB
            IF(KDFLST(JTM).NE.KPROTP(JTM2)) GO TO 160
      GOTO 150
C
  145       IF(DEFLST(IF).NE.JPROTP(II)) GO TO 160
  150  IF = IF + 1
C
C     GOT HIM - ISC IS SURFACE CODE, NR IS SPECIFIC DEF. NO.
      GOTO 170
C     SET LOCATION OF NEXT LIST FOR THIS DEF.
 160  IF=IFNXT
C
C     METHOD OF DEFINITION UNKNOWN
  162  JSUBER = 1000
      GOTO 190
C
C     SET LENGTH TO 5 FOR LARGE SURFACE
  165  IL = 5
C...     DECREMENT ISC TO BRING IT WITHIN RANGE FOR BRANCHING
C...     INDEX USE
       ISC = ISC - 31
C
C     CLEAR DEFANS AREA
  170  DO 175  JJ = 1,25
  175  DEFANS(JJ) = 0.0D0
C     BRANCH TO VARIOUS SURFACE TYPE DEFINITIONS
      GOTO(1010,1020,1030,1040,1050,1060,1070,1080,1090,1100,1110,1120,
     1 1130,1140,1150,1160,1170,1175,1180,1190,1200,1210,1220),ISC
C...  POINTS
 1010       IF(NR.EQ.11) GO TO 1011
      CALL APOINT(NR)
      GOTO 180
 1011 CALL ATABPT
      CALL AZVALU
      GOTO 180
C...  LINES
 1020       IF(NR.EQ.13) GO TO 1021
      CALL ALINE(NR)
      GOTO 180
 1021 CALL ATABLN
      GOTO 180
C...  PLANES
 1030 CALL APLAN (NR)
      GOTO 180
C...  CIRCLES
 1040 IF(NR.EQ.13) GOTO 1041
      CALL ACIRCL(NR)
      GOTO 180
 1041 CALL ATABCR
      GOTO 180
C...  CYLINDERS
 1050 CALL ACYLND(NR)
      GOTO 180
C...  ELLIPSES
 1060 CALL AELP01
      GOTO 180
C...  HYPERBOLAS
 1070 CALL AHYPR1
      GOTO 180
C...  CONES
 1080 CALL ACONE1
      GOTO 180
C...  GENERAL CONIC
 1090 CALL AGENCN(NR)
      GOTO 180
C...  LOFT CONICS
 1100 CALL ALFTCN(NR)
      GOTO 180
C...  VECTORS
 1110 CALL AVECDF(NR)
      GOTO 180
C...  MATRICES
 1120 CALL AMATX(NR)
      GOTO 180
C...  SPHERES
 1130 CALL ASPHER(NR)
      GOTO 180
C...  QUADRICS
 1140 CALL AQADR1
      GOTO 180
C...  POLYCONIC
 1150  JSUBER = 1000
      GOTO 190
C...  LOFT
 1160 CALL XLOFTX(NR)
      GOTO 190
C...  TOOL
 1170  JSUBER = 1000
       GO TO 190
C...     PATTERNS
 1175  CALL PATGEN(IL)
       GO TO 180
C...  TABCYL
 1180 IDFP1 = IDEFP + 1
      DO 1185  IY = IDFP1,1000
 1185 DEFTAB(IY) = 0.0D0
      NAMSUB = NS
      CALL APREPR
      GOTO 180
C...     MESH
 1190 CALL MSHPRE
       GO TO 190
C...     CONIC SECTIONS
 1200  JSUBER = 1000
       GO TO 190
C...     RULED SURFACE
 1210  CALL ARLDSF
       GO TO 190
C...     ELMSRF FOR DAC
 1220  CALL ELMPRE
       GO TO 190
C
C...     CANON DEFINITION OF TABCYL...
C...     IF SURFACE NOT READ IN, CONVERT SECOND WORD TO INTEGER
 1300       IF(IREAD.EQ.0) GO TO 1305
       IDFTAB(4) = DEFTAB(2)
       IDFTAB(3) = 0
C...     SET LENGTH OF CANON BLOCK
 1305  IL = 5
C...     ADJUST LENGTH IN FIRST WORD
       IDFTAB(2) = IDFTAB(2) + 1
       GO TO 190
C
C...     MOVE INPUT CANONICAL FORM TO DEFSTO AREA
  176  DO 178  J = 4,IL
  178  DEFSTO(J) = DEFTAB(J-1)
C...     CHECK VALIDITY OF CANONICAL FORM
            IF(MODEF.LE.0) GO TO 180
C
       CALL ACANCK(IT)
C
C...     RESTORE NAME AND SUBSCRIPT FOR ERROR DIAGNOSTICS
  180  CONTINUE
  190  ENAME = EINAME
       NAMSUB = NS
       NAME = LS
C...     SEE IF THERE WAS AN ERROR IN THE DEFINITION
      IF(JSV) 199,192,195
  192 IF(JSUBER.EQ.0) GO TO 200
C
C     YES, IS SURFACE NESTED, UNNAMED
  195 IF (LS.EQ.0) GO TO 198
C
C...     NO - TEST FOR SUBSCRIPT
            IF(NAMSUB.NE.0) GO TO 196
       NAME = NAME + 1
       GO TO 197
C...     YES - GET POINTER TO ENTRY IN SUBSCRIPT ARRAY
  196  CALL AVS2CK(J)
C...     COMPUTE INDEX FOR STORAGE OF ERROR CODE
  197  ILS = 2*NAME - 1
       IVST(ILS) = 9
       GO TO 199
C
C       SET SURFTB NEST ERROR FLAG FOR NESTED, UNNAMED SURFACE
  198  SCALR(ISCWS) = ERRCOD
  199 RETURN
C
C...     PUT SURFACE TYPE AND LENGTH INTO 1ST WORD OF CANON ENTRY
  200  DEFSTO(1) = PTEMP
C
C...     SEE WHETHER OR NOT THIS IS AN UNNAMED SURFACE (NESTED)
            IF(LS.NE.0) GO TO 215
C
C...     YES, IT IS - SET UP 2ND AND 3RD WORDS OF CANON ENTRY
       DEFSTO(2) = 0.0D0
       DEFSTO(3) = 0.0D0
      GO TO 217
C
C...     SURFACE IS NAMED - SET UP 2ND AND 3RD WORDS OF CANON ENTRY
  215  DEFSTO(2) = REFSYS
       IDFSTO(5) = LS
       IDFSTO(6) = NS
C...     RESTORE VST INDEX AND SUBSCRIPT FOR SURFACE BEING DEFINED
       NAME = LS
       NAMSUB = NS
C...     PUT SURFACE IN CANON
  217 CALL ACANPT
            IF(JSUBER.NE.0) GO TO 195
C
            IF(KDBUG.EQ.0) GO TO 220
C...     IF DEFINING A LARGE SURFACE, SKIP TEST FOR POSSIBLE PRINTING
  220       IF(IT.GE.50) GO TO 250
C...     ALSO FOR PATTERNS FOR NOW
            IF(IT.EQ.18) GO TO 250
C...     NOT A LARGE SURFACE - SEE IF PRINT FLAG IS ON
            IF(KPRNT.EQ.0) GO TO 250
C...     YES - PICK UP SURFACE TYPE, AND ADJUST LENGTH FOR PRINTING
       STYPE = STABLE(IT)
       IL = IL - 3
C
C...     SEE WHETHER OR NOT SURFACE IS NAMED
            IF(LS.NE.0) GO TO 230
C
C...     NO, IT IS NOT - PRINT TYPE, LENGTH, AND CANONICAL FORM
       WRITE (IOUTAP,225) STYPE,IL,(DEFANS(II),II=1,IL)
  225  FORMAT (7H NESTED,8X,A6,I3,7F13.6/(24X,7F13.6))
       GO TO 250
C
C...     SURFACE IS NAMED - PRINT NAME, SUBSCRIPT, TYPE, LENGTH,
C...     AND CANONICAL FORM
  230  WRITE (IOUTAP,235) EINAME,NS,STYPE,IL,(DEFANS(II),II=1,IL)
  235  FORMAT (1H ,A6,1H(,I4,3H)  ,A6,I3,7F13.6/(24X,7F13.6))
C
  250  RETURN
       END

