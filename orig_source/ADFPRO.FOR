      SUBROUTINE ADFPRO
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
      IMPLICIT REAL*8(A-H,O-Z)
       INTEGER ISLASH/Z00000304/
       INTEGER*2 IAT/0/
       LOGICAL*1 LCLAS1(2400),GAT(2)
       REAL*8 NAME,KRFSYS
       INTEGER DEBUG,SUM
C     THIS SUBROUTINE OUTPUTS CLASS 3 PTPP RECORDS - SURFACE DEF.
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
       COMMON/AMOTCM/PINT(30),IFURST,JPTIND,NOW,JSUB,KRESLT,KRSLT2
     1,NWDS,ITS,NEXT,MULTAX
      COMMON/AVST/VST(2750),PTPP(2225),CANON(2225)
      COMMON/AILMTB/ELMENT(600),ICLASS(600),JLMENT
      COMMON/APRTAB/ISTARP,IENDP,NMOVE,NL,ITSQ,LINDX
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
      COMMON/ASCALR/SCALR(180),ISCWS,NSURF,LOCTEM,IARGTP
       DIMENSION IPT(600),LMENT(1200),IVST(5500)
       EQUIVALENCE (PT(1),IPT(1)),(ELMENT(1),LMENT(1))
       EQUIVALENCE (IAT,GAT(1)),(ICLASS(1),LCLAS1(1))
       EQUIVALENCE (VST(1),IVST(1))
C
       JLMSAV = JLMENT
       INPT = 5
       KSURF = 4*ISTARP - 3
       GAT(2) = LCLAS1(KSURF+3)
            IF(IAT.NE.4) GO TO 5
       ISTARP = ISTARP + 1
C...     SEE IF SURFACE IS NAMED
    5       IF(ICLASS(ISTARP).NE.1) GO TO 70
C
C     YES - SET UP PTPP FOR NAMED SURFACE - CHECK SUBSCRIPT
      J1 = 0
      K = 0
       NAME = ELMENT(ISTARP)
       ISTARP = ISTARP + 1
C...     TEST FOR SUBSCRIPT ON NAME
       KSURF = 4*ISTARP - 3
       GAT(2) = LCLAS1(KSURF+3)
            IF(IAT.LE.6) GO TO 60
       IA = IAT - 6
C...     SUBSCRIPTED - BRANCH ON TYPE
       GO TO (10,20,30,340,340),IA
C     SYMBOLIC SUBSCRIPT
   10  J1 = 2
      GOTO 40
C     NUMERIC SUBSCRIPT
   20  J1 = 1
       PT(5) = ELMENT(ISTARP)
       INPT = 6
      GOTO 50
C     COMPUTED SUBSCRIPT
   30  J1 = 3
   40  KSURF = 2*ISTARP - 1
       K = LMENT(KSURF+1)
   50  ISTARP = ISTARP + 1
C
C...     PUT SURFACE DEFINITION CODE AND SUBSCRIPT TYPE
C...     INDICATOR INTO PTPP RECORD
   60  IPT(5) = 4
       IPT(6) = J1
      CALL AVS1CK(JV)
            IF(JV.NE.1) GO TO 64
C
C...     SYMBOL NOT IN VST, SO NOT DIMENSIONED - IF IT
C...     HAS A SUBSCRIPT, IT IS AN ERROR
            IF(IAT.GT.6) GO TO 320
C...     ADD SYMBOL TO VST
 63   CALL AVS1PT(JV)
C...     TEST FOR VARIABLE SYMBOL TABLE OVERFLOW
            IF(JV-1)  290, 67, 290
C
C...     SYMBOL ALREADY IN VST - IF SUBSCRIPTED, ONLY UNDEFINED
C...     OR DEFINED AS SURFACE ACCEPTABLE
   64       IF(IAT.LE.6) GO TO 66
C
       GO TO (330,320,320,330,330,65,330,310,68),JV
   65  CALL APRFIX(2,IDUM)
       GO TO 68
C
C...     NOT SUBSCRIPTED - MUST BE DEFINED AS SURFACE, OR REFERENCED
   66  GO TO (330,68,67,330,330,340,330,310,340),JV
C
   67  KSURF = 2*NAMSUB - 1
       IVST(KSURF+2) = 7
       IVST(KSURF+3) = 0
C
   68  IPT(7) = K
       IPT(8) = NAMSUB
       ISTARP = ISTARP + 1
       INPTP = INPT
      GOTO 90
C
C     NESTED, UNNAMED SURFACE - SET SURFTB INDEX
   70  IPT(5) = 0
       IPT(6) = ISCWS
       ELMENT(ISTARP-1) = PT(3)
C...     IS THERE ROOM FOR DEFINITION IN SURFACE TABLE
   75  KSURF = 2*ISTARP - 1
            IF(ISCWS+LMENT(KSURF).GT.180) GO TO 280
       ISCWS = ISCWS + LMENT(KSURF)
C     YES - PRESS ON
   80  INPTP = 4
C
C...     PUT TYPE CODE (3) FOR SURFACE DEFINITION INTO PTPP RECORD
   90  IPT(1) = 3
C...     PUT FLAG INTO 2ND WORD TO DISTINGUISH DEFINITION FROM
C...     SURFACE READ IN (READ/1)
       IPT(3) = 1
       IPT(4) = 0
C...     PUT SURFACE TYPE CODE AND LENGTH INTO PTPP RECORD
       KSURF = 2*ISTARP - 1
       INPT4 = 2*INPTP - 1
       IPT(INPT4) = LMENT(KSURF+1)
       IPT(INPT4+1) = LMENT(KSURF)
C...     INCREMENT STORING INDEX, AND SAVE PICK-UP INDEX LOCATION
       INPTP = INPTP + 1
       INPT = INPTP
       ISAVE = ISTARP
C...     IF STATEMENT LACKS AT LEAST 2 MORE ELMENT ENTRIES, ERROR
            IF(ISTARP+2.GT.IENDP) GO TO 350
C
C...     LOCATE SECOND ENTRY FOLLOWING SLASH
       ISTARP = ISTARP + 2
       ITSQ = 4
       JLMENT = IENDP
       CALL APTLOD
            IF(ISTARP+1.GT.IENDP) GO TO 120
            IF(JPTIND.EQ.9) GO TO 120
       CALL APTLOD
       ITSQ = 3
C...     SEE IF SECOND ENTRY IS VOCABULARY WORD 'CANON'
            IF(JPTIND.NE.1) GO TO 120
            IF(KRESLT.EQ.3099) GO TO 130
C
C...     IT IS NOT - CHECK STATEMENT FOR ONLY COMMAS AS SEPARATORS
  120  ILAST = IENDP - 1
       CALL ADCLAR(ISAVE,ILAST)
            IF(JSUBER.NE.0) GO TO 300
C
C...     RESTORE PICK-UP INDEX
  130  ISTARP = ISAVE + 1
       INPTP = INPT
C...     MAKE SURE NEXT ICLASS ENTRY IS A SLASH
            IF(ICLASS(ISTARP).NE.ISLASH) GO TO 270
C
C...     ICLASS PICK-UP INDEX WILL BE MOVED PAST SLASH IN AEXPRS
C...     CLEAR SUCCESSIVE COMMA FLAG FOR APTLOD
       IFURST = 0
C...     CALL AEXPRS TO MOVE PARAMETERS FOLLOWING SLASH INTO PTPP,
C...     AND OUTPUT RECORD
       CALL AEXPRS
  250  JLMENT = JLMSAV
       RETURN
C
C...     NO SLASH FOUND
  270  JSUBER = 155
       GO TO 300
C...     NOT ENOUGH STORAGE SPACE FOR UNNAMED SURFACE
  280  JSUBER = 62
       GO TO 300
C     VST IS FULL
 290  JSUBER=15
  295  SUM = 1
C
C     ABORT THIS PTPP CLASS
  300  JMODE = 4
      CALL APTPUT
       GO TO 250
C
C     ATTEMPTING TO DEFINE SURFACE IN SCALAR ARRAY
 310  JSUBER=106
       GO TO 295
C     SUBSCRIPTED VARIABLE HAS NOT APPEARED IN A RESERV STATEMENT
 320  JSUBER=108
       GO TO 295
C     MULTIPLY DEFINED SYMBOL
 330  JSUBER=1002
       GO TO 295
C     NO SUBSCRIPT FOR DIMENSIONED VARIABLE SYMBOL
 340  JSUBER=105
       GO TO 295
C...     NOT ENOUGH PARAMETERS
  350  JSUBER = 129
       GO TO 295
C
       END

