      SUBROUTINE APOCK
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 2 ***
      IMPLICIT REAL*8 (A-H,O-Z)
      COMMON/A0CON/K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,K10,K11,K12,IBLANK
      COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,
     1TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
      COMMON/APOSTP/PPNAME(20)
      COMMON/ASISTM/IPTNLY,ITRCUT,IWAVEN,KFLAG1,LTVMIT,NCLREC,NOPOST,
     1NOPLOT,NUMPST,NUMPTR,ICLPRT,INDEXX,IPLOTR,KFLAGS(9)
C... A2CMMN START
      COMMON/A2CMMN/ADUM(600),IAFL(1) ,IPONTR(1) ,IFAR(1) ,IPL(1)
      COMMON/A2CMMN/IUNFL(1),ISFTYP(1),ITLON(1)  ,ISVFL(1)  ,IFL4(1)   ,
     1IOP(1)    ,IOPSET(1) ,JIOPS(1)  ,NOTAN(1)  ,JENT(1)   ,JU1(1)    ,
     2ISIGCR(1) ,ITSEG(1)  ,JTLFLG(1) ,LOFS(1)   ,LIMFL(1)  ,ICSTR(1)  ,
     3JTN(1)    ,ICHKCT(1) ,J20(1)    ,J21(1)    ,J22(1)    ,J23(1)    ,
     4J24(1)    ,J50(1)    ,J51(1)    ,INDIR(1) ,IFILLR(209),TE(3)     ,
     5TEK(3)    ,TEL(3)    ,TES(3)    ,TA(3)     ,TAK(3)    ,TAL(3)    ,
     6PMOVE(3)  ,TI(3)     ,TIK(3)    ,TIL(3)    ,U2(3)     ,UVEC(3)   ,
     7VTEM(3)   ,CMOVE(3)  ,EX(3)     ,EY(3)     ,EZ(3)     ,VNUL(3)   ,
     8TM(3)     ,DIR(3)    ,AXIS(3)   ,AXIS1(3)  ,AXIS2(3)  ,AXIS3(3)  ,
     9REFPNT(3) ,RGT(3)    ,FWD(3)    ,UP(3)     ,ZLNORM(3) ,ZLPNT(3)
      COMMON/A2CMMN/TNDIR(3), VA(3)   ,TMVCMP(3) ,P1(3)     ,P2(3)     ,
     1PNT(3)    ,PNT1(3)   ,OLDU1(3)  ,OGLE(3)   ,RZERO(3)  ,TANMOT(3) ,
     2TLEND1(3) ,V(3)      ,CEND(3)   ,DELMOT(3) ,D2(3)     ,DNMOT(3)  ,
     3AX4(3)    ,A         ,B         ,C         ,RA        ,HI        ,
     4ALPHA     ,GAMMA     ,CAGL      ,SAGL      ,COM1      ,COM4      ,
     5COSTH     ,CTOCL     ,DIAM      ,DIF       ,DIFOUT    ,DINC      ,
     6DP        ,DPE       ,DPI       ,DPL       ,DPMAX     ,DP1       ,
     7DPCNT     ,DSMOV     ,D1        ,D2A       ,EL1       ,EL2       ,
     8FIPNT     ,FLIPCK    ,HAFDIA    ,HCHORD    ,OFFSET    ,PROD1     ,
     9PROD2     ,PSI       ,RADNO     ,RC1       ,RDRM      ,RDRN
      COMMON/A2CMMN/ RONE  ,RZEROL    ,SAVE1     ,SIUTH     ,TANGL     ,
     1THETA     ,ALP       ,EPS7      ,VAMAX     ,VL        ,ZDOTC     ,
     2ZGAMMA    ,ZIGN      ,ZL        ,ZL1       ,ZL2       ,ZNPTS     ,
     3TOLBND    ,CENDIS    ,CENLEN    ,CHORD     ,ABCD(2)   ,ACARD(2)  ,
     4SAVE(6)   ,CUTDAT(7) ,TEM(10)   ,TEMP(20)  ,TCDAT(260),QEQUIV(20),
     5IS        ,IIS       ,IT        ,IIT       ,IPS       ,IIPS      ,
     6IDS       ,IIDS      ,ICS       ,IICS      ,IGS       ,IIGS      ,
     7ICDEFL    ,ICDEFS    ,IAUTPS    ,IGO       ,ICRDCT    ,ICUT      ,
     8IGTFLG    ,INOPS     ,ISRCH     ,IOFSET    ,ISTRUP    ,I3DFLG    ,
     9MULOUT    ,MULTAX    ,NUMAX     ,NUMSFS    ,NUMSUR    ,IGOUG
      COMMON/A2CMMN/ IPDPL ,NUMDIM    ,IRSTRT    ,ICSCNT    ,I3        ,
     1I31       ,J         ,JA        ,JL        ,JS        ,JT        ,
     2KC        ,KND       ,KR        ,L         ,INCFS     ,NP        ,
     3IBEGIN    ,IFAR1     ,IK        ,INS1      ,ITNFLG    ,IVAMAX    ,
     4IWS       ,IIWS      ,IZ        ,NEXT1     ,NEXT2     ,NPTS      ,
     5NUMPT1    ,JAM       ,JAP       ,JTUSED    ,IFRL      ,N         ,
     6M         ,MDIC      ,JBR       ,JCKR      ,JCPR      ,JCR       ,
     7JDR       ,JGR       ,JMIN      ,JMINR     ,JPR       ,JPXR      ,
     8JTR       ,JCNT1     ,JCNT2     ,JCNT3     ,JSW       ,JTKF      ,
     9LISV      ,LSV       ,IPT       ,JFIND     ,IC        ,ICC
      COMMON/A2CMMN/  IL   ,K         ,NUMPTS    ,IAMDCT    ,IFL2      ,
     1J5        ,J6        ,JW6       ,J10       ,J12       ,J13       ,
     2J40       ,J43       ,J54       ,J103      ,PROBUF(100)          ,
     3CANSTO(2000) , IER   ,INSTR1    ,INSTR2    ,NWDS      ,ICL       ,
     4NREC      ,IRECNO    ,ITRFLG    ,NW        ,IDUMMY
C... A2CMMN END
      COMMON/A2DYDP/ KDYNFQ(12), NKFQ
      COMMON/A2FPC / Q15X01,QP9X01    ,QP6X01    ,QP5X01    ,QP4X01    ,
     1QP0001    ,QP001     ,QP01      ,QP1       ,Q1P       ,Q10P      ,
     2Q1000P    ,Q1PE5     ,Q1PE6     ,Q1PE10    ,Q1PE20    ,Q1PE30    ,
     3Q1PE36    ,Q1PE38    ,QP8X01    ,QP7X01    ,
     4QP4X09    ,QP9       ,QP99      ,QP995     ,QP997     ,QP999     ,
     5QP9999    ,QP4X95    ,QP5X95    ,QP6X9     ,QP7X9     ,
     6QP6X05    ,QP5X05    ,QP4X05    ,QP0005    ,QP005     ,QP05      ,
     7QP5       ,Q5P       ,                                 Q4X045    ,
     8QP0002    ,QP0047    ,QP017     ,Q1RAD     ,QP0349    ,QP125     ,
     9QP6       ,QP2       ,QP2499    ,QP25      ,QP3
      COMMON/A2FPC / QP7   ,QP75      ,QP8       ,QP866     ,Q1P01     ,
     1Q1P1      ,Q1P2      ,Q1P25     ,Q1P5      ,Q2P       ,Q2P5      ,
     2Q3P       ,Q3P5      ,Q4P       ,Q8P       ,Q11P      ,Q45P      ,
     3Q90P      ,Q130P     ,Q4500P    ,Q9000P    ,QP02      ,QNUL      ,
     4QPIE       ,QFIL(9)
      DIMENSION XI(3,22),Q(3,21),U(3,21),W(3,20),BL(20),
     1XIPRIM(3,21),VPRIM(3,20),UPRIM(3,20),T(3),WD(3),Y(3),PTINT(3),
     2CTEMP(3,20),CROSTO(3),UCRSTO(3),TCRSTO(3),COR(3,20),KTAB(20)
      DIMENSION POCDAT(69),QONE(3),WONE(3),FRONE(1),FRTWO(1),FRTHRE(1)
      COMMON/A2POK8/ADDEM1,ADDEM2,BL    ,COSVA ,CROSTO,CTEMP ,CUTRAD,
     1DCOV  ,DELDST,DIST  ,DUMMY ,OFCSTO,OFFSTO,PHITMP,PTINT ,QONE  ,
     2Q     ,RTEST ,SIN2VA,SPHIO2,T     ,TCRSTO,U     ,UCRSTO,UPRIM ,
     3VPRIM ,W     ,WD    ,WONE  ,XI    ,XIPRIM,X1    ,X2    ,X3    ,
     4Y
      COMMON/A2POCK/IPCERR,IWDCNT,NWD,IBM1,IBM2,IBM3,IBM4,IBM6
      COMMON/A2POK2/     JONE,    NC,NCORIG,  JTWO,  JTHR,  JFOU,  KALC,
     1     MOVE,  INIT,NCUTBK,NPLUS1,NLESS1,ICRSTO,  KTAB,KUTBAC,KOLAPS,
     2    JSAVE, INTER,  KONE,  KTWO,JDUMMY,   NUM, ITEST,   KT1,   KT2,
     3    KOVER
C     EQUIVALENCE FOR POCKET
      EQUIVALENCE(PROBUF(1),POCDAT(1)),
     1(POCDAT(2),RADEFF),(POCDAT(3),OFSETC),(POCDAT(4),OFSETF),
     2(POCDAT(5),FRONE(1)),(POCDAT(6),FRTWO(1)),(POCDAT(7),FRTHRE(1)),
     3(POCDAT(8),OVRIDE),(POCDAT(9),PTTYPE),(POCDAT(10),COR(1,1))
C
      DIMENSION COR1(3,20),GPNT(3)
      EQUIVALENCE (COR1(1,1),CANSTO(1510))
C
    1 CALL ATAPOP(POCTAP,1,IPCERR)
      DO 2 I=1,99
      CANSTO(1601-I) = PROBUF(100-I)
    2 PROBUF(101-I) = PROBUF(100-I)
      JONE = NWDS + 1
      NC=(JONE-9)/3
      NCORIG=NC
      I = PTTYPE + QP01
      IF(I .GT. 1) GO TO 9999
 9997 IBM6 = 1
      CUTRAD=CUTDAT(1)
      IF(RADEFF.LT.QNUL) CALL AERR(3511)
      IF(OFSETC.LT.QNUL) CALL AERR(3512)
      IF(OFSETF.LT.QNUL) CALL AERR(3513)
      IF((FRONE(1).LT.QNUL).OR.(FRTWO(1).LT.QNUL).OR.
     1(FRTHRE(1).LT.QNUL)) CALL AERR(3514)
      I = OVRIDE + QP01
      IF((I.NE.0).AND.(I.NE.1)) CALL AERR(3515)
      I= PTTYPE + QP01
      IF((I.NE.0).AND.(I.NE.1)) CALL AERR(3516)
      JONE=0
      IBM1=0
      JTWO=0
      JTHR=0
      JFOU=0
      IF(RADEFF)10,10,20
   10 RADEFF=QP5*OFSETC*CUTRAD
   20 KALC=0
      MOVE=1
      INIT=1
      DELDST=QNUL
      GO TO 40
   30 NC=NCUTBK
      PTTYPE=QNUL
   40 DO 50 J=1,NC
      DO 50 I=1,3
   50 XI(I,J+1)=COR(I,J)
      DO 60 I=1,3
      XI(I,1)=COR(I,NC)
   60 XI(I,NC+2)=COR(I,1)
      NPLUS1=NC+1
      NLESS1=NC-1
      DO 80 J=1,NPLUS1
      ADDEM1=QNUL
      DO 70 I=1,3
      Q(I,J)=XI(I,J+1)-XI(I,J)
   70 ADDEM1=(Q(I,J))**2+ADDEM1
      DO 80 I=1,3
   80 U(I,J)=Q(I,J)/DSQRT(ADDEM1)
      IF (INIT)300,85,85
   85 JGR=8
      CALL APOCKA
C     ADJUST POCKET VERTICES IF POCKET BOTTOM IS CANTED WITH RESPECT T0
C     TOOL AXIS AND VERTICES DESCRIBE ACTUAL POCKET BOUNDARIES
      CALL AVDOT(TA(1),TCRSTO(1),ADDEM1)
      X1=DABS(ADDEM1)
      IF(X1-QP2)190,190,200
  190 CALL AERR(3507)
  200 IF(X1-QP9999)220,210,210
  210 INIT = -1
  220 IF (INIT)300,210,230
  230 IF (PTTYPE)190,210,240
  240 INIT=0
      PTTYPE=QNUL
      JGR=9
      CALL APOCKA
      GO TO 40
  300 IF (OVRIDE)430,310,430
  310 SPHIO2=Q1P
      DO 340 J=1,NC
      CALL AVDOT(U(1,J),U(1,J+1),ADDEM2)
      DUMMY=DSQRT(DABS((Q1P+ADDEM2)/Q2P))
      IF (DUMMY-SPHIO2)330,340,340
  330 SPHIO2=DUMMY
  340 CONTINUE
      DUMMY=RADEFF/CUTRAD*(Q1P+SPHIO2)
      IF (OFSETC-DUMMY)360,360,350
  350 OFSETC=DUMMY
  360 IF (OFSETF-DUMMY)380,380,370
  370 OFSETF=DUMMY
  380 IF (JFOU)430,430,385
  385 JFOU=0
  390 OFCSTO=OFSETC
      OFFSTO=OFSETF
      DUMMY=Q2P*RADEFF/CUTRAD*SPHIO2
      IF (OFSETC-DUMMY)420,420,400
  400 OFSETC=DUMMY
      IF (OFSETF-DUMMY)420,420,410
  410 OFSETF=DUMMY
  420 JFOU=1
  430 DO 460 J=1,NC
      DO 440 I=1,3
  440 W(I,J)=U(I,J+1)-U(I,J)
      ADDEM1=QNUL
      ADDEM2=QNUL
      DO 450 I=1,3
      ADDEM1=W(I,J)*U(I,J+1)+ADDEM1
  450 ADDEM2=W(I,J)*W(I,J)+ADDEM2
  460 BL(J)=DSQRT(DABS(ADDEM2-ADDEM1**2))
      DIST=PTTYPE*CUTRAD
      JGR=7
  461 CALL APOCKA
  462 GO TO (1610,1560,1450,951),JGR
  951 IF(NC-NCUTBK) 1140,1140,960
  960 IF (KALC)980,970,980
  970 IF (OVRIDE)1000,1020,1000
  980 IF (OVRIDE)1000,990,1000
  990 JFOU=1
 1000 DO 1010 J=1,NCUTBK
      DO 1010 I=1,3
 1010 COR(I,J)=CTEMP(I,J)
      GO TO 30
 1020 IF (JFOU)1040,1040,1025
 1025 JFOU=0
 1030 IF(JTHR)1040,1040,1035
 1035 JTHR=0
      GO TO 1000
 1040 IF (PHITMP-SPHIO2)1050,1000,1000
 1050 SPHIO2=PHITMP
      DUMMY=RADEFF/CUTRAD*(Q1P+SPHIO2)
      IF (OFSETC-DUMMY)1080,1080,1060
 1060 OFCSTO=DUMMY
      IF (OFSETF-DUMMY)1090,1090,1070
 1070 OFFSTO=DUMMY
      GO TO 1100
 1080 OFCSTO=OFSETC
 1090 OFFSTO=OFSETF
 1100 DUMMY=Q2P*RADEFF/CUTRAD*SPHIO2
      IF (OFSETC-DUMMY)1000,1000,1110
 1110 OFSETC=DUMMY
      IF (OFSETF-DUMMY)1130,1130,1120
 1120 OFSETF=DUMMY
 1130 JFOU=1
      JTHR=1
      DIST=DIST-DELDST
      KALC=1
      GO TO(1131,1132,1132,1133,1133),MOVE
 1131 JGR=6
      GO TO 1134
 1132 JGR=3
      GO TO 1134
 1133 JGR=5
 1134 CALL APOCKA
      GO TO(1610,1560,1450,951),JGR
 1140 IF (KALC)1160,1150,1160
 1150 JONE=0
      JTWO=0
      JTHR=0
      JFOU=0
C     COVERAGE TESTS
 1160 RTEST=Q2P*RADEFF
      KOVER=2
      GO TO 1180
 1170 RTEST=RADEFF
      KOVER=1
 1180 DO 1360 J=1,NC
      DO 1340 L=2,NLESS1
      K=J+L
      IF (K-NC)1200,1200,1190
 1190 K=K-NC
 1200 GO TO (1210,1230),KOVER
 1210 DO 1220 I=1,3
 1220 Y(I)=XIPRIM(I,K)-XIPRIM(I,J+1)
 1230 DO 1240 I=1,3
 1240 T(I)=XIPRIM(I,K)-XIPRIM(I,J)
      CALL AVDOT(T(1),UPRIM(1,J),ADDEM1)
      CALL AVDOT(T(1),T(1),ADDEM2)
      DCOV=DSQRT(DABS(ADDEM2-ADDEM1**2))
      IF (DCOV-RTEST)1260,1260,1360
 1260 GO TO (1270,1340),KOVER
 1270 ADDEM1=QNUL
      DO 1280 I=1,3
 1280 ADDEM1=Y(I)*(-UPRIM(I,J))+ADDEM1
      IF (ADDEM1)1290,1340,1310
 1290 CALL AVDOT(Y(1),Y(1),ADDEM1)
      ADDEM2=DSQRT(ADDEM1)
      IF (ADDEM2-RTEST)1340,1340,1360
 1310 CALL AVDOT(T(1),UPRIM(1,J),ADDEM1)
      IF (ADDEM1)1330,1340,1340
 1330 ADDEM1=DSQRT(ADDEM2)
      IF (ADDEM1-RTEST)1340,1340,1360
 1340 CONTINUE
      MOVE=5
      GO TO (1380,1350),KOVER
 1350 IF (KALC)1450,1450,1170
 1360 CONTINUE
      GO TO (1450,1370),KOVER
 1370 IF (KALC)1450,1450,1470
 1380 ADDEM1=QNUL
      ADDEM2=QNUL
      DO 1390 I=1,3
      ADDEM1=(XIPRIM(I,J)-XIPRIM(I,1))**2+ADDEM1
 1390 ADDEM2=(XIPRIM(I,J+1)-XIPRIM(I,1))**2+ADDEM2
      IF(DSQRT(ADDEM1)-DSQRT(ADDEM2))1400,1400,1430
 1400 DO 1410 I=1,3
      WD(I)=XIPRIM(I,J)
 1410 XIPRIM(I,1)=XIPRIM(I,J+1)
 1420 J=2
      NUM=2
      GO TO 1500
 1430 DO 1440 I=1,3
      WD(I)=XIPRIM(I,J+1)
 1440 XIPRIM(I,1)=XIPRIM(I,J)
      GO TO 1420
 1450 NUM=NPLUS1
      J = NUM
      GO TO 1480
 1460 J=NUM-1
      NUM=J
      IF (J)1470,1470,1480
 1470 GO TO(1471,1472,1473,1474,1610),MOVE
 1471 JGR=1
      GO TO 1475
 1472 JGR=2
      GO TO 1475
 1473 JGR=4
      GO TO 1475
 1474 JGR=5
 1475 CALL APOCKA
 1476 GO TO(1610,1560,1450,951),JGR
 1480 IF (MOVE.LT.5)GO TO 1485
      IF (J.GT.1)GO TO 1485
      IBM6=2
 1485 DO 1490 I=1,3
 1490 WD(I)=XIPRIM(I,J)
 1500 IF (IBM6.NE.1)GO TO 1520
 1510 IBM2=0
      IBM3=241
      IBM6=0
 1520 IBM3=IBM3-3
 1530 IF(MULOUT.LT.1) GO TO 1540
      CALL AVSTO(TA(1),TCDAT(IBM3))
      IBM3 = IBM3 - 3
 1540 CALL AVSTO(WD(1),TCDAT(IBM3))
 1550 IBM2=IBM2+1
      IF (IBM3.LT.13)GO TO 1560
      IF (IBM6.NE.2)GO TO 1460
 1560 IBM1=IBM1+1
      IF (MULOUT.EQ.1)GO TO 1580
 1570 IBM4=IBM2*3
      GO TO 1590
 1580 IBM4=IBM2*6
C...    *** ON S/360  IBM1, IBM2, IBM4, IPCERR, IBM3,NWD  MUST BE 4 BYTE
C            INTEGERS  ***
 1590 CALL ATAPWT(POCTAP,IPCERR,4,IBM1,1,IBM2,1,IBM4,1,TCDAT(IBM3),IBM4,
     1Q1P,0,Q1P,0)
      IF (IPCERR.LT.0)GO TO 1600
      CALL AERR(3505)
 1600 IBM2=0
      IBM3=241
      GO TO 1460
C     USING DATA STORED ON TAPE
 1610 IF(CANSTO(1509).LT.QP5) GO TO 1650
      DO 1611 K = 1,3
 1611 COR1(K,NCORIG+1) = COR1(K,1)
      DO 1615 K = 1,NCORIG
      DO 1614 I = 1,3
 1614 VTEM(I) = COR1(I,K)-COR1(I,K+1)
      CALL AVCROS(VTEM,TA,VTEM)
      CALL AVNORM(VTEM,VTEM,IER)
      IF(IER.EQ.1) CALL AERR(3517)
      CALL AVDOT(VTEM,COR1(1,K) ,A)
      CALL AVDOT(VTEM,WD,B)
      IF(DABS(A-B).LT.(CUTDAT(1)-QP0001)) CALL AERR(3518)
 1615 CONTINUE
 1650 NCLREC = NCLREC + 1
      CALL APOCKB
      RETURN
 9999 IF(IPL(IIPS) .NE. 1) CALL AERR(3519)
      PTTYPE = PTTYPE - Q2P
C
      CANSTO(1509) = PTTYPE
      KK1 = IPONTR(IIPS) + 4
      CALL AVSTO(CANSTO(KK1),VTEM)
      CALL AVDOT(VTEM,TA,ANS)
      IF(DABS(ANS) .LT. QP9X01) CALL AERR(3507)
      KK2 = IPONTR(IIPS) + 7
      J = 0
      JJJ = ((NCORIG-1)*3)+1510
      DO 9998 K=1510,JJJ,3
      J = J + 1
      CALL AVSTO(CANSTO(K),GPNT)
      CALL AVDOT(GPNT,VTEM,ANS)
      CALL AVDOT(TA,VTEM,BNS)
      ANS = (CANSTO(KK2) - ANS) / BNS
      CALL AVMULT(TA,ANS,TEMP(1))
      CALL AVADD(GPNT,TEMP(1),TEMP(1))
      CALL AVSTO(TEMP(1),COR(1,J))
 9998 CONTINUE
      GO TO 9997
      END

