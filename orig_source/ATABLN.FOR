      SUBROUTINE ATABLN
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
C
C.....CONSTRUCT A LINE THRU A POINT AND TANGENT OR NORMAL(AS SPECIFIED)
C.....TO A TABCYL IN THE XY-PLANE
C
      IMPLICIT REAL*8(A-H,O-Z)
       INTEGER PUNTAP
       COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,
     1 TAPES1,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
       COMMON/A1COM/REFSYS,NAME,NAME1,JSUBER,JSV,NAMSUB,KDBUG,INDXPT,
     1 LOOP,IFINI
      COMMON/AVST/VST(7200)
      DIMENSION DEFTAB(1000)
      EQUIVALENCE(VST(7200),DEFTAB(1000))
      COMMON/ADFSTO/DEFSTO(85),PARTNO(11)
       DIMENSION DEFANS(82)
      EQUIVALENCE(DEFSTO(4),DEFANS(1))
C               *          *          *          *          *
      DIMENSION D( 999),ID(1998)
      EQUIVALENCE (DEFTAB(2),ID(1),D(1))
      DIMENSIONAA(22),R(22),INE(3),CO(11)
C***********************************************************************
      SQRT(Q) = DSQRT(Q)
      ATAN(Q) = DATAN(Q)
      ABS(Q) = DABS(Q)
      SIGN(Q,QQ) = DSIGN(Q,QQ)
C
C.....SAVE SENSE LIGHT 1 CONDITION
C
      ISENSE=0
      CALL SLITET(1,K000FX)
       GO TO(160,161),K000FX
  160 ISENSE=1
C
C.....FIND ESTIMATED TABCYL INTERVAL OF TANGENT OR NORMAL POINT.
C
  161 ER=0.0
      IHU=7
      ITRY=0
      NT=(ID(14)-1)*7+21
      CALLASCHTB(IHU,D(NT),D(NT+1),ER)
      IF(ER)1   ,2 ,1
    1 JSUBER=1005
      GOTO15
C
C.....TRANSLATE AND ROTATE INTO COORDINATE SYSTEM OF THE SELECTED
C.....TABCYL INTERVAL
C
   12 IF(ITRY-7)2,13,13
    2 IHUT=IHU
      IF(ID(10)-18)411,412,411
  411 ITE=NT-10
      IZT=18
      GOTO 413
C...   THIS AREA COMPUTES ROTATION ANGL OF INTRVL AXIS TO BASIC AXIS
 1100 XA=D(IHU+7)-D(IHU)
      YA=D(IHU+8)-D(IHU+1)
      COSTHA=SQRT(XA*XA+YA*YA)
      SINTHA=YA/COSTHA
      COSTHA=XA/COSTHA
      IF(ABS(COSTHA-1.0E-6))1101,1101,1103
 1101 RA=-SIGN(1.5707963,SINTHA)
 1102 GO TO IT,(1105,1106,1107)
 1103 RA=-ATAN(SINTHA/COSTHA)
      IF(COSTHA)1104,1101,1102
 1104 RA=RA+3.14159265
      GO TO 1102
C.....EXTENSION INTERVALS ARE INCLUDED IN THE NORMAL LINE SEARCH.
 412  ITE=NT-3
      IZT=12
 413  IZ=1
      ASSIGN 1105 TO IT
      GO TO 1100
 1105 CALL ATRNRO(XA,YA,XB,YB,RA,IZ)
      XC=D(2)-D(IHU)
      YC=D(3)-D(IHU+1)
      CALL ATRNRO(XC,YC,XD,YD,RA,IZ)
C
C.....TEST TO SEE IF GIVEN POINT IS ON OR OFF TABCYL
C
      TOL=1.0D-5
      IF(XB+TOL-XD)206,71,71
 71   IF(XD+TOL)206,72,72
   72 EQU2=D(IHU+2)*(XD**3)+D(IHU+3)*(XD**2)-(D(IHU+2)*D(IHU+4)+D(IHU+3)
     1)*(D(IHU+4)*XD)
      IF(ABS(YD-EQU2)-TOL)70,70,206
 206  IF(ID(10)-18)73,207,73
   70 SLOP=3.*D(IHU+2)*XD**2+2.0*D(IHU+3)*XD-(D(IHU+2)*D(IHU+4)+D(IHU+3)
     1)*D(IHU+4)
      IF(ID(10)-18)290,200,290
  290 IF(SLOP)291,76,291
  291 IF(ABS(SLOP)-1.0)74,76,76
 74   R1=XD-1.0/SLOP
      RY=YD-1.0
      GOTO 79
 76   R1=XD-1.0
      RY=YD-SLOP
      GOTO 79
 200  IF(ABS(SLOP)-0.000001)201,202,202
 201  IF(SLOP)203,204,204
 203  BORSLP=+9999999.0
      GOTO 205
 204  BORSLP=-9999999.0
      GOTO 205
 202  BORSLP=-1.0/SLOP
 205  SLOP=BORSLP
      GOTO 290
C
C.....CALCULATE COEFFICIENTS OF THE CUBIC EQUATION AND SOLVE FOR THE
C.....POINTS OF TANGENCY
C
 73   AA(1)=2.0*D(IHU+2)
      IF(ABS(AA(1))-1.0D-14)1236,1237,1237
 1236 AA(1)=DSIGN(1.0D-14,AA(1))
 1237 AA(2)=D(IHU+3)-3.0*D(IHU+2)*XD
      AA(3)=-2.0*D(IHU+3)*XD
      AA(4)= YD+(D(IHU+2)*D(IHU+4)+D(IHU+3))*(D(IHU+4)*XD)
      DO16I=1,22
   16 R(I)=0.0
      IFALL=0
      II=3
      NN=7
      CALLAPOLYR(AA,II,NN,R,IFALL)
C
C.....TEST DEBUG FLAG
C
      IF(KDBUG)99,21,99
   99 WRITE (IOUTAP,100)XA,YA,XB,YB,                         XC,YC,XD,YD
  100 FORMAT(1H08E14.6)
      WRITE (IOUTAP,100)R(1),R(2),R(3),                      R(4),R(5),R
     1(6)
C
C.....TEST FOR ERRORS
C
   21 IF(IFALL-1)3,22,22
   22 WRITE (IOUTAP,23)
   23 FORMAT(28H0TABCYL TANGENT LINE FAILURE)
      GOTO1
C
C.....ROOTS FOUND OKAY, TEST THEIR POSITIONS WITH RESPECT TO THE
C.....BOUNDARY POINTS OF THE INTERVAL
C
    3 KIT=-1
      LUCK=0
      DO24I=1,3
      INE(I)=0
      KIT=KIT+2
      IF(R(KIT+1))24,30,24
   30 IF(R(KIT)-1.0D-6)24,24,25
   25 IF(R(KIT)*(XB-R(KIT)))24,26,26
   26 LUCK=LUCK+1
      INE(I)=KIT
   24 CONTINUE
      IF(LUCK-1)27,28,4
C
C.....MULTIPLE TANGENCY POINTS IN THE INTERVAL
C
    4 WRITE (IOUTAP,6)
    6 FORMAT(40H0MORE THAN 1 POINT OF TANGENCY ON TABCYL)
      KIT=-1
      IZ=-1
      ASSIGN 1106 TO IT
      GO TO 1100
 1106 DO301I=1,3
      KIT=KIT+2
      IF(INE(I))298,301,298
  298 R1=R(KIT)
      RY=D(IHU+2)*(R1**3)+D(IHU+3)*(R1**2)-(D(IHU+2)*D(IHU+4)+D(IHU+3))
     1*(D(IHU+4)*R1)
      CALLATRNRO(R1,RY,XA,YA,RA,IZ)
      R1=XA+D(IHU)
      RY=YA+D(IHU+1)
      WRITE (IOUTAP,300)R1,RY
  301 CONTINUE
  300 FORMAT(1H 2F14.6)
      GOTO1
C
C.....TEST FOR NORMAL LINE WHEN GIVEN POINT
C.....IS NOT A POINT ON THE TABCYL.
C.....CALCULATE COEFFICIENTS FOR A FIFTH ORDER EQUATION
C.....WHICH DEFINES A POINT ON THE TABCYL INTERVAL (CUBIC EQUATION)
C.....WHERE THE NORMAL TO THE INTERVAL PASSES THROUGH THE GIVEN POINT
C
 207  CO(1)=3.0*(D(IHU+2)**2)
      CO(2)=5.0*D(IHU+2)*D(IHU+3)
      CO(3)=4.0*D(IHU+2)*(-(D(IHU+2)*D(IHU+4)+D(IHU+3))*D(IHU+4))
     1+2.0*(D(IHU+3)**2)
      CO(4)=3.0*D(IHU+3)*(-(D(IHU+2)*D(IHU+4)+D(IHU+3))*D(IHU+4))
     1-3.0*D(IHU+2)*YD
      CO(5)=(-(D(IHU+2)*D(IHU+4)+D(IHU+3))*D(IHU+4))**2
     1-2.0*D(IHU+3)*YD+1.0
      CO(6)=XD-YD*(D(IHU+2)*D(IHU+4)+D(IHU+3))*D(IHU+4)
      CO(7)=5.0*CO(1)
      CO(8)=4.0*CO(2)
      CO(9)=3.0*CO(3)
      CO(10)=2.0*CO(4)
      CO(11)=CO(5)
C.....(X11,Y11) IS THE END POINT OF THE INTERVAL BEING
C.....CONSIDERED THAT IS NEAREST TO THE SPECIFIED POINT.
      CALL ATRNRO(D(NT),D(NT+1),X11,Y11,RA,IZ)
      IF(X11)40,44,41
 40   X11=0.0
      GOTO 44
   41 IF(X11-.5*XB)40,44,43
 43   X11=XB
C.....NEWTON'S METHOD IS USED TO SOLVE THE FIFTH ORDER
C.....EQUATION. X11 IS THE INITIAL ESTIMATE OF THE ROOT.
 44   DO 45 J=1,200
      EQ1=CO(1)*X11**5+CO(2)*X11**4+CO(3)*X11**3
     1+CO(4)*X11**2+CO(5)*X11-CO(6)
      EQ2=CO(7)*X11**4+CO(8)*X11**3+CO(9)*X11**2
     1+CO(10)*X11+CO(11)
      DELTA=-EQ1/EQ2
      IF(ABS(DELTA)-3.0D-6)47,46,46
 46   X11=X11+DELTA
 45   CONTINUE
      GOTO 27
 47   IF(X11+5.0D-6)27,112,112
 112  IF((XB+5.0D-6)-X11)27,113,113
  113 Y11=D(IHU+2)*X11**3+D(IHU+3)*X11**2-(D(IHU+2)*D(IHU+4)+D(IHU+3))
     1*(D(IHU+4)*X11)
      R1=X11
      RY=Y11
      GOTO 79
C
C.....TANGENCY POINT NOT FOUND OR NOT IN INTERVAL,
C.....SET UP FOR RE-TRY UNTIL 3 INTERVALS ON EACH SIDE OF THE INITIAL
C.....INTERVAL HAVE BEEN TRIED------A TOTAL OF 7 INTERVALS.
C.....  (EXTENSION INTERVALS ARE INCLUDED FOR NORMAL LINE ONLY.)
C
   27 ITRY=ITRY+1
      GOTO(29,900,904,905,906,907,13),ITRY
   29 IHU=IHU+7
  902 IF(IHU-ITE)12,27,27
  900 IHU=IHU-14
  903 IF(IHU-IZT)27,27,12
  904 IHU=IHU+21
      GOTO902
  905 IHU=IHU-28
      GOTO903
  906 IHU=IHU+35
      GOTO902
  907 IHU=IHU-42
      GOTO903
   13 IF(ID(10)-18) 409,408,409
  409 WRITE (IOUTAP,14)
   14 FORMAT(30H0TABCYL TANGENT LINE NOT FOUND)
      GOTO1
 408  WRITE(IOUTAP,410)
 410  FORMAT(29H0TABCYL NORMAL LINE NOT FOUND)
      GOTO 1
C
C.....TANGENCY POINT FOUND, CALCULATE SECOND COORDINATE AND TRANSFORM
C.....THE POINT BACK TO THE XY-PLANE
C
   28 DO32I=1,LUCK
      IF(INE(I))33,32,33
   32 CONTINUE
   33 INZ=INE(I)
      R1=R(INZ)
    9 RY=D(IHU+2)*(R1**3)+D(IHU+3)*(R1**2)
     1-(D(IHU+2)*D(IHU+4)+D(IHU+3))*(D(IHU+4)*R1)
   79 IZ=-1
      ASSIGN 1107 TO IT
      GO TO 1100
 1107 CALL ATRNRO(R1,RY,XA,YA,RA,IZ)
 1110 D(5)=D(IHU)+XA
      D(6)=D(IHU+1)+YA
      D(7)=0.0
C
C.....CALCULATE CANONICAL FORM OF A LINE THRU TWO POINTS IN
C.....THE XY-PLANE
C
 1120 DEFANS(3)=0.0
      X1=D(2)
      Y1=D(3)
      X2=D(5)
      Y2=D(6)
      IF(X1-X2)1000,914,1000
 1000 SLP=(Y1-Y2)/(X1-X2)
      IF(ABS(SLP)-5.E-6)910,912,912
  910 X0=0.0
      Y0=Y1
      DEFANS(1)=0.0
      DEFANS(2)=1.0
      DEFANS(4)=Y1
      GO TO 15
  912 IF(ABS(SLP)-5.E+3)916,914,914
  914 X0=X1
      Y0=0.0
      DEFANS(1)=1.0
      DEFANS(2)=0.0
      DEFANS(4)=X1
      GO TO 15
  916 X0=SQRT(1.0+SLP**2)
      DEFANS(1)=-SLP/X0
      DEFANS(2)=1.0/X0
      DEFANS(4)=DEFANS(1)*X1 + DEFANS(2)*Y1
C
C.....TEST DEBUG FLAG
C
 137  IF(KDBUG)165,15,165
  165 WRITE (IOUTAP,100)R1,RY,XA,YA,                         D(5),D(6),D
     1(7),X0,Y0
C
C.....RESTORE SENSE LIGHT 1 CONDITION
C
   15 IF(ISENSE)162,163,162
  162 ISENSE=0
      CALL SLITE (1)
  163 RETURN
      END

