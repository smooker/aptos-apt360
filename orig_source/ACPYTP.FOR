      SUBROUTINE ACPYTP
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
C
C**** THIS ROUTINE PROCESSES PTPP CLASS  6 DATA AND BUILDS THE PROTP
C     TABLE FOR RITAPE TO PLACE AS A RECORD IN THE PROTAP FILE. THE
C     INPUT TO THE ROUTINE CONSISTS OF THE PTPP AND ITS INDEX, INDXPT,
C     THE SCALR TABLE, THE SURFTB TABLE, AND THE CANON TABLES.
      IMPLICIT REAL*8(A-H,O-Z)
       INTEGER*2 KVST(28800)
       DIMENSION DEFANS(82)
       DIMENSION PTPP(7200),CANON(7200)
       COMMON/A1COM/REFSYS,NAME,NAME1,JSUBER,JSV,NAMSUB,KDBUG,INDXPT,
     1 LOOP,IFINI
       COMMON/A0CON/K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,K10,K11,K12,IBLANK
      COMMON/AVST/VST(7200)
      DIMENSION DEFTAB(1000)
      EQUIVALENCE(VST(1),PTPP(1),CANON(1))
       EQUIVALENCE (VST(1),KVST(1))
      EQUIVALENCE(VST(7200),DEFTAB(1000))
      COMMON/A2CLS7/PPSEQ1,PPSEQ2,ENAME,EINAME,IEREC,ISN
      COMMON/A1PAS2/I,J,K,L,MOVLGE,KANMAX,ICANST,IOVREC,KANPTR,MDFTAB,
     1KANCNT,KAUX,KDFCNT,IDEFP,KPRCNT,MDFPRE,IPREP,KOVFLP,KSRFCT,KOVCNT,
     2LSCAN,IOVFLO,MAXCAN,IREF,ICANSC,NAMSTA,KANGO,LASPTP,ISUB,
     3LCOMP,LGEREC,IRECN,JREC,JNUM,KANCUR,KANCOT,KDFENT,KANPAR,LGELOC,
     4IDTMOV,ISPPRG,INDEXS,KPTP,KPTPCT,KLASTP,KLASCT,KPRNT
      COMMON/ADFSTO/DEFSTO(85),PARTNO(11)
      EQUIVALENCE(DEFSTO(4),DEFANS(1))
       COMMON/APROTP/PROTP(102),PROSAV(102),NOWCLT,LSTPSV,INCORE
     1 ,JGORIT,SAVMOT
      COMMON/ADEBUG/IDEBUG(3),KCANDF
      INTEGER AMDTOA,AEXTRA,AMATOD,AEXCH,AEXTRD,ASTYPE
       DATA A /8HACOPYTAP/
C****              ****                     ****                    ****
      IN=INDXPT
      KE=K2
C     SET IDTMOV NON-ZERO TO PRECLUDE MOVING LARGE SURFACES TO DEFTAB
      IDTMOV=K1
C     INITIALIZE PROTP COUNTER
      JK=K3
C     GET NO. PARAMETERS IN PTPP
      NPT=AMDTOA(PTPP(INDXPT),K4)
      INDXPT=INDXPT+K1
C
      I1=AMDTOA(PTPP(INDXPT),K4)
      J1=AEXTRA(PTPP(INDXPT),K4)
C
C     SET PROTAP CLASS AND SUBCLASS
      PROTP(2)=PTPP(INDXPT)
       INDXPT = INDXPT + 1
C
C...     COMPUTE BRANCHING NUMBER FROM PROTAP RECORD TYPE
       IRECTP = I1/1000
C...     BRANCH FOR INDIVIDUAL PROCESSING
            IF(IRECTP-11)  2, 10, 10
    2  GO TO (160,302,10,304,305,306,10,10,10,200),IRECTP
C
C...     POST PROCESSOR COMMAND
  302       IF(J1.NE.1045) GO TO 10
C...     STORE THE LAST PARTNO FOR USE AS HEADING IN TABCYL ROUTINES
       KONT = INDXPT + 1
       DO 7  KLJ = 1,11
       PARTNO(KLJ) = PTPP(KONT)
    7  KONT = KONT + 2
       GO TO 10
C
C...     TEST FOR TRANTO OR MULTIPLE CS BRANCH
  306       IF(J1.EQ.7) GO TO 170
            IF(J1.EQ.8) GO TO 170
C
   10       IF(NPT.LE.0) GO TO 130
C
       DO 120  II = 1,NPT
C     GET EXPECTED SURFACE TYPE IF IT EXISTS
      IT=ASTYPE(INDXPT)
      INDSAV = INDXPT
C     GET THE SURFACE OR SCALAR REFERENCED BY THE PTPP ENTRY.
      M=83
       CALL AGTARG(DEFANS,M,MN)
C     IS THE VARIABLE DEFINED
      IF(MN.NE.K3)GO TO 20
C     THE VARIABLE IS UNDEFINED, JSUBER HAS BEEN SET BY ACANGT.
      GOTO 110
C
C  20 IS THE VARIABLE A SURFACE
   20 IF(MN.EQ.K2)GO TO 30
C
C     THE VARIABLE IS NOT A SURFACE.
C...     TEST FOR ENOUGH ROOM FOR ENTRY IN PROTP AREA
            IF(JK.GT.102) GO TO 95
       PROTP(JK) = DEFANS(1)
      JK=JK+K1
C      CHECK FOR FROM/X,Y  OR  GOTO/X,Y
            IF(I1.NE.5000) GO TO 120
            IF(J1.EQ.3) GO TO 25
            IF(J1.NE.5) GO TO 120
C...     NO VOCABULARY WORDS ALLOWED IN FROM AND GOTO STATEMENTS
            IF(MN.NE.5) GO TO 25
       JSUBER = 133
       GO TO 405
   25 IF(JK.NE.7)  GO TO 120
      IF(NPT.NE.4) GO TO 120
C      YES - GET Z VALUE
      DEFANS(1) = PROTP(5)
      DEFANS(2) = PROTP(6)
      CALL AZVALU
      PROTP(7) = DEFANS(3)
      JK = JK + 1
      GO TO 120
C
C...     VARIABLE IS A SURFACE - SET INDXPT TO PROPER LOCATION IN PTPP
   30       IF(AEXTRA(PTPP(INDSAV),4).LT.2) GO TO 32
       INDXPT = INDXPT + 1
C
C...     EXTRACT TYPE FROM CANONICAL FORM
   32  K = AMDTOA(DEFSTO(1),4)
C...     SEE IF IT IS A PATTERN
            IF(K.NE.18) GO TO 34
C
C...     PATTERN FOUND - MAKE SURE STATEMENT IS A GOTO/...
C...     CHECK PROTP CLASS...
            IF(IRECTP.NE.5) GO TO 100
C...     ...AND SUBCLASS CODES
            IF(J1.NE.5) GO TO 100
C...     PATTERN IS VALID - CALL ROUTINE TO OUTPUT IT, THEN EXIT
       CALL PATGO
       RETURN
C
C...     SURFACE IS NOT PATTERN - GET LENGTH OF CANONICAL FORM
   34  L = AEXTRA(DEFSTO(1),4)
C...     TEST FOR ENOUGH ROOM FOR ENTRY IN PROTP AREA
            IF(JK+L-1.GT.102) GO TO 95
C...     CAN EXPECTED SURFACE TYPE BE DETERMINED
            IF(IT.EQ.100) GO TO 40
      IF(IT.EQ.150)  GO TO 35
C     YES - IS THIS SURFACE THE EXPECTED TYPE
      IF(K.NE.IT) GOTO 100
      GO TO 45
C
C      SURFACE CANNOT BE POINT, VECTOR, MATRIX, OR LARGE SURFACE
   35 IF(K.GE.50)  GO TO 100
C     SURFACE CANNOT BE POINT, VECTOR, OR MATRIX
   40 IF(K.EQ.K1 ) GO TO 100
      IF(K.EQ.K11) GO TO 100
      IF(K.EQ.K12) GO TO 100
C
C     SURFACE IS THE EXPECTED TYPE - CHECK FOR 3000 TYPE PROTAP RECORD
   45 IF(I1.NE.3000) GOTO 50
C     3000 TYPE - STORE SURFACE TYPE AND LENGTH OF CANONICAL FORM
      PROTP(JK)=AFULL8(K0,K)
      JK=JK+K1
      PROTP(JK)=AFULL8(K0,L-1)
      JK=JK+K1
      GOTO 60
C
C     IS THIS A 5000 TYPE PROTAP RECORD
   50 IF(I1.NE.5000) GOTO 60
C
C     YES - IS THIS FROM, GODLTA, OR GOTO
      IF(J1.LT.K3) GOTO 60
      IF(J1.GT.K5) GOTO 60
C     YES - CHECK FOR SYMBOLIC TOOL AXIS VECTOR
      IF(JK.EQ.K8) GOTO 70
C
C      IS THIS AN 11000 TYPE PROTAPE RECORD  (POCKET)
   60 IF(I1.EQ.11000)  GO TO 70
C     NO - STORE NAME AND SUBSCRIPT(ZEROS IF NESTED)
      PROTP(JK)=ENAME
      JK=JK+K1
      PROTP(JK)=NAMSUB
      JK=JK+K1
C     IS THIS A LARGE SURFACE
      IF(L.NE.K5) GOTO 70
C     YES - STORE SRFTAP RECORD NO. AND LENGTH OF CANONICAL FORM
      PROTP(JK)=DEFSTO(4)
      JK=JK+K1
      PROTP(JK)=DEFSTO(5)
      JK=JK+K1
      GOTO 120
C
C     MOVE CANONICAL FORM TO PROTP
   70  DO 80  I = 4,L
       PROTP(JK) = DEFSTO(I)
   80  JK = JK + 1
       GO TO 120
C
C...     PROTP AREA OVERFLOW - ERROR
   95  JSUBER = 378
       GO TO 110
C
C     SURFACE IS NOT EXPECTED TYPE
  100 JSUBER=1006
C
C     OUTPUT DIAGNOSTIC MESSAGE FOR THIS PARAMETER
  110 IF(JSUBER .EQ.0) GO TO 115
      CALL ADIAGM
  115 KE=K1
  120 CONTINUE
C
C     SET NO. OF WORDS IN PROTP
  130 JK=JK-K1
      PROTP(1)=AFULL8(K0,JK-K1)
C
      IF(KDBUG.EQ.0) GOTO 140
C     DEBUG FLAG IS ON - PRINT PTPP AND PROTP
      IDEBUG(1)=K7
      IDEBUG(2)=IN
      IDEBUG(3)=KLASCT
       CALL ADPRNT(A)
      IDEBUG(1)=13
      IDEBUG(2)=JK
      CALL ADPRNT(K0)
C...     IS THIS A SURFACE RECORD (3000 TYPE)
  140       IF(IRECTP.NE.3) GO TO 145
C...     YES - IS IMPLIED CHECK SURFACE NEEDED
            IF(JGORIT.EQ.1) GO TO 340
C...     HAVE THERE BEEN ERRORS
  145  GO TO (160,150),KE
C...     NO - OUTPUT PROTAP RECORD
  150 CALL ARITAP
  160 RETURN
C
C     TRANTO/ID
 170  IF(AMDTOA(PTPP(INDXPT),K4).NE.K7) GOTO 190
      INDXPT=INDXPT+K1
       L = 4*AEXTRA(PTPP(INDXPT),4) - 3
      PROTP(3)=0.
      INDXPT = INDXPT + 1
      PROTP(4) = PTPP(INDXPT)
C...  GET PROTAPE RECORD NUMBER, IF ALREADY PROCESSED
       J = KVST(L+4)
            IF(J.EQ.0) GO TO 180
C     SET PROTAP REC. NO. FOR BACKWARD TRANSFER
      PROTP(3)=AFULL8(K0,J)
 180  JK=JK+K2
      GOTO 130
C
 190  JSUBER=453
      KE=K1
      GOTO 130
C
C     STATEMENT DOES NOT GENERATE PROTAP RECORD
 200  JSUBER=456
      KE=K1
      GOTO 130
C
C...     TOOL POSITION (4000 TYPE) - IF LEFT, RIGHT, OR ON, SAVE IT
  304       IF(J1.GE.4) GO TO 130
       JTOOL = J1
       GO TO 130
C
C...     5000 TYPE RECORD - IF FROM, GOTO, OR GODLTA, AND
C...     IMPLIED CHECK SURFACE NEEDED, ERROR
  305       IF(J1.LE.2) GO TO 10
            IF(J1.EQ.8) GO TO 10
            IF(JGORIT)  400, 10, 400
  400  JSUBER = 137
       JGORIT = 0
  405  CALL ADIAGM
       GO TO 160
C
C...     IMPLIED CS NEEDED - IF THIS MOTION IS START-UP, ERROR
  340       IF(AMDTOA(SAVMOT,4).NE.8000) GO TO 400
       MOTSAV = AEXTRA(SAVMOT,4)
C...     IF THIS MOTION IS GOUP OR GODOWN, ERROR
            IF(MOTSAV.LT.5) GO TO 350
       JSUBER = 136
       GO TO 405
C
C...     CONSTRUCT AND OUTPUT CHECK SURFACE RECORD FOR IMPLIED CS
C...     IS THIS MOTION GOLFT OR GORGT
  350       IF(MOTSAV.LE.2) GO TO 352
C...     NO - SET INDICATOR FOR DS AND CS TANGENT
       JUPIT = 4
       GO TO 360
C...     YES - WAS LAST TOOL POSITION ON
  352       IF(JTOOL.NE.3) GO TO 354
C...     YES - SET INDICATOR FOR ON CS
       JUPIT = 3
       GO TO 360
C...     TOOL NOT ON - SET INDICATOR INITIALLY FOR TO CS - MAY
C...     BE ALTERED LATER
  354  JUPIT = 1
C...     WAS LAST TOOL POSITION LEFT
            IF(JTOOL.EQ.1) GO TO 356
C...     NO - MUST BE RIGHT - IF THIS MOTION GOLFT, SET
C...     INDICATOR FOR PAST CS
            IF(MOTSAV.EQ.1) JUPIT = 2
       GO TO 360
C...     LAST TOOL POSITION WAS LEFT - IF THIS MOTION GORGT,
C...     SET INDICATOR FOR PAST CS
  356       IF(MOTSAV.EQ.2) JUPIT = 2
C
C...     PUT SURFACE CONDITION INDICATOR INTO CS RECORD
  360  PROTP(3) = AFULL8(0,JUPIT)
       PROTP(2) = AFULL8(3000,3)
       JGORIT = -1
C...     HAVE THERE BEEN ANY ERRORS
       GO TO (370,365),KE
  365  CALL ARITAP
C...     CLEAR IMPLIED CHECK SURFACE FLAG
  370  JGORIT = 0
C...     SET SURFACE USE CODE BACK TO DRIVE SURFACE
       PROTP(2) = AFULL8(3000,2)
       PROTP(3) = 0.0
       GO TO 145
C
       END

