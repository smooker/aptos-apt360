      SUBROUTINE APARAM
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
      IMPLICIT REAL*8(A-H,O-Z)
       LOGICAL*1 LCLAS1(2400),GCL(2)
       INTEGER IPT(600),LMENT4(1200)
       INTEGER*2 LCLAS2(1200),CL/0/,SC
       INTEGER *2 ICOPY(12)/29,6,34,4,38,4,42,4,54,3,55,4/
       INTEGER ISLASH/Z00000304/
       INTEGER DEBUG,SUM
       REAL*8 NAME,KRFSYS
       REAL*8 SIGNEG/Z0000000800000002/
      COMMON/ASISTM/IPTNLY,ITRCUT,IWAVEN,KFLAG1,LTVMIT,NCLREC,NOPOST
     1 ,NOPLOT,NUMPST,NUMPTR,ICLPRT,INDEXX,IPLOTR,KFLAGS(9)
      COMMON/AVST/VST(7200)
       DIMENSION IVST(14400)
       EQUIVALENCE (VST(1),IVST(1))
      COMMON/APOSTP/PPNAME(20)
       COMMON/APRTAB/ISTARP,IENDP,NMOVE,NL,ITSQ,LINDX
       COMMON/AMOTCM/PINT(30),IFURST,JPTIND,NOW,JSUB,KRESLT,KRSLT2
     1,NWDS,ITS,NEXT,MULTAX
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
       COMMON/AILMTB/ELMENT(600),ICLASS(600),JLMENT
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
       EQUIVALENCE (ELMENT(1),LMENT4(1)),(PT(1),IPT(1))
       EQUIVALENCE (ICLASS(1),LCLAS2(1),LCLAS1(1)),(CL,GCL(1))
C
       JTEMP1 = 2*ISTARP - 1
       IPT(5) = LMENT4(JTEMP1+1)
       IPT(6) = LMENT4(JTEMP1)
       SC = LCLAS2(JTEMP1)
       JTEMP2 = 4*ISTARP - 3
       GCL(2) = LCLAS1(JTEMP2+2)
       IPT(1) = 6
       JT = 0
       IT = 0
       NPT = 0
       JMODE = 5
       NW = -1
       INPTP = 4
       ITSQ = 0
       ISTARP = ISTARP + 1
C...     TEST FOR PARTNO, PPRINT, INSERT
            IF(CL.EQ.1) GO TO 45
C...     NO - TEST FOR POST PROC. COMMANDS WITH OR WITHOUT PARAMETERS
            IF(CL-23)  10, 5, 15
C
C...     SINGLE-WORD POST PROCESSOR COMMAND - TEST FOR PARAMETERS -
C...     IF SO, ERROR
    5       IF(ISTARP.GT.JLMENT) GO TO 190
       JSUBER = 505
       GO TO 990
C
C...     POST PROCESSOR COMMANDS WITH PARAMETERS
C...     IF NO PARAMETERS GIVEN, TREAT AS SINGLE-WORD COMMAND
   10       IF(ISTARP-JLMENT)  20, 15, 190
C...     SLASH (ASSUMED) BUT NO PARAMETERS - ERROR
   15  JSUBER = 129
       GO TO 990
C...     TEST FOR SLASH
   20       IF(ICLASS(ISTARP).EQ.ISLASH) GO TO 30
       JSUBER = 155
       GO TO 990
C
C...     MOVE SCANNING INDEX PAST SLASH
   30  ISTARP = ISTARP + 1
C...     SET FLAG FOR AUTOMATIC SKIPPING OF COMMAS
       ITSQ = 4
C...     TEST FOR TRACUT, INDEX, COPY, OR MACHIN
            IF(CL-21)  15, 120, 40
C...     IF EITHER VTLAXS OR WCORN, SET FLAG TO CALL SECTION 3
   40       IF(SC.EQ.62)  INDEXX = 1
            IF(SC.EQ.63)  INDEXX = 1
C...     IF REQUIRED, SET FLAG FOR PLOTTING IN SECTION 3
      IF (SC.EQ.39) IPLOTR=1
C      CHECK FOR TRANS STATEMENT TO  ALLOW FOR A MATRIX
      IF(SC.EQ.35) GO TO 700
C...  CHECK FOR CLRSRF OR CLEARP
         IF (SC.EQ.49)  JT=150
            IF(SC.EQ.4) JT = 3
   45  SC = 5
C
   50  CALL APTLOD
       CALL ASWICH (JT)
   55       IF(JPTIND.EQ.0) GO TO 70
       GO TO (70,110,110,100,460,110,110,990,460),JPTIND
C
C...     VOCABULARY WORD
   70  JTEMP1 = 2*INPTP - 1
            IF(IPT(JTEMP1-1).LE.0) GO TO 460
C...    NUMBER OF ALLOWABLE POSTPROCESSOR MINOR WORDS EXCEEDED?
             IF(IPT(JTEMP1-1).LE.400) GO TO 110
       GO TO 460
C..
C...     SURFACE DEFINITION, NAMED OR UNNAMED - CHECK ACCEPTABILITY
  100       IF(JT.NE.0) GO TO 110
C
C...     NO SURFACE VALID IN THIS STATEMENT
  105 JSUBER=501
      SUM = 1
      GO TO 990
C
  110  NPT = NPT + 1
C...     TEST FOR END OF STATEMENT
            IF(ISTARP.GT.JLMENT) GO TO 190
C...     NO - TEST FOR OVERFLOW OF PT BUFFER
            IF(INPTP.GE.297) GO TO 195
       GO TO 50
C
C...     TRACUT, INDEX, COPY, OR MACHIN STATEMENT - DETERFMINE WHICH
  120  GO TO (150,260,340,300),SC
C
C     TRACUT
  150  CALL APTLOD
C...     CHECK NUMBER OF PARAMETERS - ONLY ONE LEGAL
            IF(ISTARP.LE.JLMENT) GO TO 15
C...     SEE IF PARAMETER WAS 'NOMORE'
            IF(JPTIND.NE.0) GO TO 155
            IF(KRESLT-53)  160, 180, 160
C...     NO - MUST BE SURFACE - PERMIT SYMBOLIC SCALAR FOR
C...     POSSIBLE UNDEFINED
  155       IF(JPTIND.EQ.4) GO TO 170
            IF(JPTIND.EQ.3) GO TO 170
C...     IF ERROR FLAG SET IN APTLOD, SIMPLY EXIT
            IF(JPTIND.EQ.8) GO TO 995
  160  JSUBER = 506
       GO TO 990
  170  CALL ASWICH(12)
  180  ITRCUT = 1
       NPT = 1
C
C...     OUTPUT (POSSIBLE PARTIAL) PTPP RECORD, AND EXIT IF FINISHED
  190  IT = 1
  195  INPTP = INPTP - 1
       NW = NW + INPTP
C...     TEST FOR END OF POST PROCESSOR COMMAND
            IF(IT.EQ.0) GO TO 205
C...     YES - IF PTPP RECORD ALREADY STARTED, SET FOR TERMINATION
            IF(JMODE.NE.5) GO TO 200
       IPT(2) = NW
       IPT(3) = NPT
       IPT(4) = 0
       GO TO 220
  200  JMODE = 3
       GO TO 220
C
C...     NOT END - RECORD MUST BE CONTINUED...
C...     IF THIS IS START OF RECORD, ADJUST MODE FLAG
  205       IF(JMODE.NE.5) GO TO 210
       JMODE = 1
       GO TO 220
C...     NO - SET FLAG FOR CONTINUATION
  210  JMODE = 2
C
  220  CALL APTPUT
            IF(JSUBER.NE.0) GO TO 990
       INPTP = 1
C...     IF PTPP RECORD NOT COMPLETED, RETURN TO CONTINUE SCAN
            IF(JMODE.GE.3) GO TO 995
       GO TO (15,15,390,50,50),SC
C
C...     INDEX
  260  CALL APTLOD
       NPT = 1
C...     TEST FIRST PARAMETER FOR SCALAR
            IF(JPTIND.EQ.2) GO TO 265
            IF(JPTIND.EQ.3) GO TO 265
C...     IF ERROR FLAG SET IN APTLOD, SIMPLY EXIT
            IF(JPTIND.EQ.8) GO TO 995
C..
C..  FIRST PARAMETER HASNT A SCALAR VALUE
       JSUBER = 83
      GO TO 990
C
  265       IF(ISTARP-JLMENT)  270, 15, 290
  270  CALL APTLOD
C...     SECOND PARAMETER CAN ONLY BE 'NOMORE'
            IF(JPTIND.NE.0) GO TO 460
            IF(KRESLT.NE.53) GO TO 460
C...     TEST FOR MORE PARAMETERS IN STATEMENT - IF SO, ERROR
            IF(ISTARP.LE.JLMENT) GO TO 15
       NPT = 2
C..
  290 INDEXX = 1
       GO TO 190
C...
C     MACHIN
  300  CALL APTLOD
            IF(JPTIND.EQ.1) GO TO 306
            IF(JPTIND.NE.3) GO TO 460
C...     MAKE SURE THERE IS NO SUBSCRIPT
            IF(IPT(8).NE.0) GO TO 460
C...     ALSO THAT IT IS UNDEFINED
       JTEMP1 = 2*IPT(10) - 1
            IF(IVST(JTEMP1+2).NE.8) GO TO 460
       IPT(7) = 6
       JTEMP2 = IPT(10)
       PT(5) = VST(JTEMP2)
 306  IF(NUMPST.LT.10) GOTO 310
      JSUBER=504
      GO TO 990
  310  NUMPST = NUMPST + 1
       PPNAME(NUMPTR) = PT(INPTP-1)
       NUMPTR = NUMPTR + 2
       NPT = 1
            IF(ISTARP.LE.JLMENT) GO TO 315
      PPNAME(NUMPTR-1) = 1.
      GO TO 190
C...     NEXT ENTRY MUST BE A NUMBER
  315  CALL APTLOD
            IF(JPTIND.NE.2) GO TO 460
       PPNAME(NUMPTR-1) = PT(INPTP-1)
C...     SEE IF MACHINE NUMBER HAD A NEGATIVE SIGN PREFIXED
            IF(PT(INPTP-3).NE.SIGNEG) GO TO 110
C...     YES - CHANGE ITS SIGN IN PPNAME ENTRY
       PPNAME(NUMPTR-1) = -PPNAME(NUMPTR-1)
       GO TO 110
C
C    COPY
  340  CALL APTLOD
C...     FIRST PARAMETER MUST BE A SCALAR
            IF(JPTIND.EQ.2) GO TO 350
            IF(JPTIND.NE.3) GO TO 460
C...     IF NO MORE PARAMETERS, ERROR
  350       IF(ISTARP.GT.JLMENT) GO TO 390
       CALL APTLOD
C...     SECOND PARAMETER MUST BE A MODIFIER
            IF(JPTIND.NE.0) GO TO 460
C...     SAVE THE MODIFIER CODE - NEEDED FOR TESTING LATER ALSO
       JDUM = KRESLT
C...     IF NO MORE PARAMETERS, ERROR
            IF(ISTARP.LE.JLMENT) GO TO 400
  390  JSUBER = 507
       GO TO 990
C
  400  INDEXX = 1
       CALL APTLOD
C...     IF MODIFIER WAS 'MODIFY', PACK MATRIX TYPE CODE WITH LATEST
C...     PARAMETER, AND MAKE SURE PARAMETER IS A SURFACE
            IF(KRESLT.NE.55) GO TO 380
       CALL ASWICH(12)
            IF(JPTIND-4)  460, 420, 460
C
C...     FOR ALL OTHER MODIFIERS, THIRD PARAMETER MUST BE SCALAR
  380       IF(JPTIND.EQ.2) GO TO 420
            IF(JPTIND.NE.3) GO TO 460
  420  NPT = 3
C
C...     TEST FOR END OF STATEMENT
  430       IF(ISTARP.GT.JLMENT) GO TO 470
C...     NO - GET NEXT PARAMETER - MUST BE A SCALAR
       CALL APTLOD
            IF(JPTIND.EQ.2) GO TO 440
            IF(JPTIND.NE.3) GO TO 460
C...     INCREMENT PARAMETER COUNT, AND GO TO TEST FOR END
  440  NPT = NPT + 1
       GO TO 430
C
C...     INCORRECT PARAMETER TYPE FOUND
C...     IF ERROR FLAG SET IN APTLOD, SIMPLY EXIT
  460       IF(JPTIND.EQ.8) GO TO 995
       JSUBER = 503
      GO TO 990
C
C...     END OF COPY STATEMENT - CHECK NUMBER OF PARAMETERS
  470  DO 480  J = 1,12,2
            IF(JDUM.EQ.ICOPY(J)) GO TO 490
  480  CONTINUE
       GO TO 460
  490       IF(NPT.NE.ICOPY(J+1)) GO TO 390
       GO TO 190
C
C      PROCESS TRANS/ STATEMENT
  700 SC = 5
       CALL APTLOD
C...     IF PARAMETER IS A SURFACE, PACK MATRIX TYPE CODE IN ITS
C...     PTPP ENTRY
            IF(JPTIND.NE.4) GO TO 55
       CALL ASWICH(12)
       GO TO 55
C
C...     ERROR EXIT - ERASE ANY PORTION OF RECORD ALREADY OUTPUT
  990       IF(JMODE.EQ.5) GO TO 995
       JMODE = 4
      CALL APTPUT
C
  995 RETURN
      END

