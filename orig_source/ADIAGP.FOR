      SUBROUTINE ADIAGP
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
C
      IMPLICIT REAL*8(A-H,O-Z)
      REAL*8 INWORD,NEWONE,NAME,IDIS,MACNAM,KRFSYS
       INTEGER PUNTAP
      INTEGER AMATOD,AEXTRA,AMDTOA,AEXTRD,AEXCH,DEBUG,SUM
      COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1
     1 ,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
       EQUIVALENCE (POCTAP,PTPTAP),(TAPES4,ERRTAP)
       COMMON/AMCSTF/MACNAM(5),MACCUR,MACLCN(5),MACRD,MACSTR(5),
     1 NMACVR,NUMIDS,IDLOCN,MACIDS(5),ISVID
       COMMON/AMACRO/LIMCAN,LMDW,NITEMS,JWHAT,MACREC,MACVST,MACERR
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
      COMMON/ABREAK/NEXTNW,NRELCN,KANLCN,LOCSEQ,NEXTCN,NWONRD,LPLOCN,
     1JSW4,ISN,K,MXLOOP,JSW2,JSAV,JSW1,MAXMV,MXNEST,INILL,KF
       COMMON/AKLAS7/PPSEQ1,PPSEQ2,IDIS,IISN,IDVST,KFK
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
       DIMENSION KPT(600)
       EQUIVALENCE (PT(1),KPT(1))
C
C... SUM  - INPUT FLAG SET BY CALLING PROG..0 INDICATES DIAG. NO. ONLY
C... JSUBER MUST BE SET BY CALLING PROG... 1 - INDICATES A VAR. SYMB.
C...  IS TO BE OUTPUT,  NAME AND JSUBER SET BY CALLING PROG..
C...  9 - INDICATES A SUBSCRIPTED VAR. SYMB. IN ERROR..JSUBER, NAME
C... AND PT(7) ARE SET BY CALLING PROG.,,(PT(7) IS SUBSCRIPT VALUE)
C..   MACERR -- .NE.0  ERROR DURING LOOP OR MACRO DEFINITION MODE    D39
C..
      IF (NWONRD.LT.0) MACERR = 1
      IF (SUM.EQ.9) GOTO 90
      KF = 4
      IF(SUM.EQ.0) GOTO 10
C
C     VARIABLE SYMBOL INVOLVED - OUTPUT THE NAME
      KF = 5
   9  PT(6) = NAME
      SUM = 0
C
   10  KPT(1) = 2
       KPT(2) = KF
       KPT(3) = JSUBER
       KPT(4) = 1
       KPT(5) = 0
       KPT(6) = IISN
       PT(4) = PPSEQ1
       PT(5) = PPSEQ2
       KF = KF + 1
C
C...     TEST FOR DEFINING A MACRO - SPECIAL CASE
            IF(MACRD.LT.0) GO TO 20
C
C...     NO...
       INPTP = KF
       JMODE = 5
       CALL APTPUT
       GO TO 30
C
C...     DEFINING A MACRO...
C...     INCREMENT PTPP RECORD NUMBER
   20  IRECN = IRECN + 1
C...     WRITE DIAGNOSTIC OUT IMMEDIATELY
       CALL ATAPWT(PTPTAP,IOFLAG,4,IRECN,1,0,1,2,1,PT(1),KF)
C...     SET FLAG INDICATING BAD MACRO DEFINITION
       MACERR = 1
C
   30  JSUBER = 0
       RETURN
C... OUTPUT SUBSCRIPTED VAR.., PT(7) IS SET BY CALLING PROG.
C...   KF IS THE LENGTH OF PT ENTRIES LESS THE HEADER ENTRY
   90 KF = 6
      GO TO 9
      END

