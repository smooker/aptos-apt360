      SUBROUTINE APOCKA
      IMPLICIT REAL*8 (A-H,O-Z)
      COMMON/A0CON/K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,K10,K11,K12,IBLANK
      COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,
     1TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
      COMMON/APOSTP/PPNAME(20)
      COMMON/ASISTM/IPTNLY,ITRCUT,IWAVEN,KFLAG1,LTVMIT,NCLREC,NOPOST,
     1NOPLOT,NUMPST,NUMPTR,ICLPRT,INDEXX,IPLOTR,KFLAGS(9)
C... A2CMMN START
      COMMON/A2CMMN/ADUM(720) ,TE(3) ,
     5TEK(3)    ,TEL(3)    ,TES(3)    ,TA(3)     ,TAK(3)    ,TAL(3)    ,
     6PMOVE(3)  ,TI(3)     ,TIK(3)    ,TIL(3)    ,U2(3)     ,UVEC(3)   ,
     7VTEM(3)   ,CMOVE(3)  ,EX(3)     ,EY(3)     ,EZ(3)     ,VNUL(3)   ,
     8TM(3)     ,DIR(3)    ,AXIS(3)   ,AXIS1(3)  ,AXIS2(3)  ,AXIS3(3)  ,
     9REFPNT(3) ,RGT(3)    ,FWD(3)    ,UP(3)     ,ZLNORM(3) ,ZLPNT(3)
      COMMON/A2CMMN/TNDIR(3), VA(3)   ,TMVCMP(3) ,P1(3)     ,P2(3)     ,
     1PNT(3)    ,PNT1(3)   ,OLDU1(3)  ,OGLE(3)   ,RZERO(3)  ,TANMOT(3) ,
     2TLEND1(3) ,V(3)      ,CEND(3)   ,DELMOT(3) ,D2(3)     ,DNMOT(3)  ,
     3AX4(3)    ,A         ,B         ,C         ,RA        ,HI        ,
     4ALPHA     ,GAMMA     ,CAGL      ,SAGL      ,COM1      ,COM4      ,
     5COSTH     ,CTOCL     ,DIAM      ,DIF       ,DIFOUT    ,DINC      ,
     6DP        ,DPE       ,DPI       ,DPL       ,DPMAX     ,DP1       ,
     7DPCNT     ,DSMOV     ,D1        ,D2A       ,EL1       ,EL2       ,
     8FIPNT     ,FLIPCK    ,HAFDIA    ,HCHORD    ,OFFSET    ,PROD1     ,
     9PROD2     ,PSI       ,RADNO     ,RC1       ,RDRM      ,RDRN
      COMMON/A2CMMN/ RONE  ,RZEROL    ,SAVE1     ,SIUTH     ,TANGL     ,
     1THETA     ,ALP       ,EPS7      ,VAMAX     ,VL        ,ZDOTC     ,
     2ZGAMMA    ,ZIGN      ,ZL        ,ZL1       ,ZL2       ,ZNPTS     ,
     3TOLBND    ,CENDIS    ,CENLEN    ,CHORD     ,ABCD(2)   ,ACARD(2)  ,
     4SAVE(6)   ,CUTDAT(7) ,TEM(10)   ,TEMP(20)  ,TCDAT(260),QEQUIV(20),
     5IS        ,IIS       ,IT        ,IIT       ,IPS       ,IIPS      ,
     6IDS       ,IIDS      ,ICS       ,IICS      ,IGS       ,IIGS      ,
     7ICDEFL    ,ICDEFS    ,IAUTPS    ,IGO       ,ICRDCT    ,ICUT      ,
     8IGTFLG    ,INOPS     ,ISRCH     ,IOFSET    ,ISTRUP    ,I3DFLG    ,
     9MULOUT    ,MULTAX    ,NUMAX     ,NUMSFS    ,NUMSUR    ,IGOUG
      COMMON/A2CMMN/ IPDPL ,NUMDIM    ,IRSTRT    ,ICSCNT    ,I3        ,
     1I31       ,J         ,JA        ,JL        ,JS        ,JT        ,
     2KC        ,KND       ,KR        ,L         ,INCFS     ,NP        ,
     3IBEGIN    ,IFAR1     ,IK        ,INS1      ,ITNFLG    ,IVAMAX    ,
     4IWS       ,IIWS      ,IZ        ,NEXT1     ,NEXT2     ,NPTS      ,
     5NUMPT1    ,JAM       ,JAP       ,JTUSED    ,IFRL      ,N         ,
     6M         ,MDIC      ,JBR       ,JCKR      ,JCPR      ,JCR       ,
     7JDR       ,JGR       ,JMIN      ,JMINR     ,JPR       ,JPXR      ,
     8JTR       ,JCNT1     ,JCNT2     ,JCNT3     ,JSW       ,JTKF      ,
     9LISV      ,LSV       ,IPT       ,JFIND     ,IC        ,ICC
      COMMON/A2CMMN/  IL   ,K         ,NUMPTS    ,IAMDCT    ,IFL2      ,
     1J5        ,J6        ,JW6       ,J10       ,J12       ,J13       ,
     2J40       ,J43       ,J54       ,J103      ,PROBUF(100)          ,
     3CANSTO(2000) , IER   ,INSTR1    ,INSTR2    ,NWDS      ,ICL       ,
     4NREC      ,IRECNO    ,ITRFLG    ,NW        ,IDUMMY
C... A2CMMN END
      COMMON/A2DYDP/ KDYNFQ(12), NKFQ
      COMMON/A2FPC / Q15X01,QP9X01    ,QP6X01    ,QP5X01    ,QP4X01    ,
     1QP0001    ,QP001     ,QP01      ,QP1       ,Q1P       ,Q10P      ,
     2Q1000P    ,Q1PE5     ,Q1PE6     ,Q1PE10    ,Q1PE20    ,Q1PE30    ,
     3Q1PE36    ,Q1PE38    ,QP8X01    ,QP7X01    ,
     4QP4X09    ,QP9       ,QP99      ,QP995     ,QP997     ,QP999     ,
     5QP9999    ,QP4X95    ,QP5X95    ,QP6X9     ,QP7X9     ,
     6QP6X05    ,QP5X05    ,QP4X05    ,QP0005    ,QP005     ,QP05      ,
     7QP5       ,Q5P       ,                                 Q4X045    ,
     8QP0002    ,QP0047    ,QP017     ,Q1RAD     ,QP0349    ,QP125     ,
     9QP6       ,QP2       ,QP2499    ,QP25      ,QP3
      COMMON/A2FPC / QP7   ,QP75      ,QP8       ,QP866     ,Q1P01     ,
     1Q1P1      ,Q1P2      ,Q1P25     ,Q1P5      ,Q2P       ,Q2P5      ,
     2Q3P       ,Q3P5      ,Q4P       ,Q8P       ,Q11P      ,Q45P      ,
     3Q90P      ,Q130P     ,Q4500P    ,Q9000P    ,QP02      ,QNUL      ,
     4QPIE       ,QFIL(9)
      DIMENSION XI(3,22),Q(3,21),U(3,21),W(3,20),BL(20),
     1XIPRIM(3,21),VPRIM(3,20),UPRIM(3,20),T(3),WD(3),Y(3),PTINT(3),
     2CTEMP(3,20),CROSTO(3),UCRSTO(3),TCRSTO(3),COR(3,20),KTAB(20)
      DIMENSION POCDAT(69),QONE(3),WONE(3),FRONE(1),FRTWO(1),FRTHRE(1)
      COMMON/A2POK8/ADDEM1,ADDEM2,BL    ,COSVA ,CROSTO,CTEMP ,CUTRAD,
     1DCOV  ,DELDST,DIST  ,DUMMY ,OFCSTO,OFFSTO,PHITMP,PTINT ,QONE  ,
     2Q     ,RTEST ,SIN2VA,SPHIO2,T     ,TCRSTO,U     ,UCRSTO,UPRIM ,
     3VPRIM ,W     ,WD    ,WONE  ,XI    ,XIPRIM,X1    ,X2    ,X3    ,
     4Y
      COMMON/A2POCK/IPCERR,IWDCNT,NWD,IBM1,IBM2,IBM3,IBM4,IBM6
      COMMON/A2POK2/     JONE,    NC,NCORIG,  JTWO,  JTHR,  JFOU,  KALC,
     1     MOVE,  INIT,NCUTBK,NPLUS1,NLESS1,ICRSTO,  KTAB,KUTBAC,KOLAPS,
     2    JSAVE, INTER,  KONE,  KTWO,JDUMMY,   NUM, ITEST,   KT1,   KT2,
     3    KOVER
C     EQUIVALENCE FOR POCKET
      EQUIVALENCE(PROBUF(1),POCDAT(1)),
     1(POCDAT(2),RADEFF),(POCDAT(3),OFSETC),(POCDAT(4),OFSETF),
     2(POCDAT(5),FRONE(1)),(POCDAT(6),FRTWO(1)),(POCDAT(7),FRTHRE(1)),
     3(POCDAT(8),OVRIDE),(POCDAT(9),PTTYPE),(POCDAT(10),COR(1,1))
      GO TO (470,480,490,500,510,550,590,90,245),JGR
   90 DO 110 J=1,NC
      DO 100 I=1,3
      IF(DABS(XI(I,J)-COR(I,J))-QP0005)100,100,110
  100 CONTINUE
      CALL AERR(3501)
  110 CONTINUE
      DO 130 J=1,NC
      DO 120 I=1,3
      IF(DABS(U(I,J+1)-U(I,J))-QP0005) 120,120,130
  120 CONTINUE
      CALL AERR(3502)
  130 CONTINUE
      ICRSTO=1
      DO 180 J=1,NC
      CALL AVSUB(VNUL(1),U(1,J),CROSTO(1))
      CALL AVCROS(CROSTO(1),U(1,J+1),CROSTO(1))
      CALL AVNORM(CROSTO(1),UCRSTO(1),IERR)
      IF (ICRSTO)160,160,140
  140 DO 150 I=1,3
  150 TCRSTO(I)=UCRSTO(I)
      ICRSTO=0
      GO TO 180
  160 DO 170 I=1,3
      IF(DABS(UCRSTO(I)-TCRSTO(I))-QP0005)170,170,270
  170 CONTINUE
  180 CONTINUE
      RETURN
  270 DO 280 I=1,3
      IF(DABS(DABS(UCRSTO(I))-DABS(TCRSTO(I)))-QP0005) 280,280,290
  280 CONTINUE
      CALL AERR(3504)
  290 CALL AERR(3503)
      RETURN
  245 DO 261 J=1,NC
      CALL AVDOT(TA(1),U(1,J),ADDEM1)
      CALL AVDOT(TA(1),U(1,J+1),ADDEM2)
      DO 250 I=1,3
      QONE(I)=U(I,J)-TA(I)*ADDEM1
  250 WONE(I)=U(I,J+1)-TA(I)*ADDEM2
      CALL AVNORM(QONE(1),QONE(1),IERR)
      CALL AVNORM(WONE(1),WONE(1),IERR)
      CALL AVSUB(WONE(1),QONE(1),T(1))
      CALL AVNORM(T(1),T(1),IERR)
      CALL AVDOT(T(1),WONE(1),ALPHA)
      ALPHA=CUTRAD/(DSQRT(DABS(Q1P-ALPHA**2)))
      CALL AVMULT(T(1),ALPHA,Y(1))
      CALL AVDOT(Y(1),TCRSTO(1),ALPHA)
      CALL AVDOT(TA,TCRSTO,X1)
      DO 260 I=1,3
  260 COR(I,J) = COR(I,J) + Y(I) - ALPHA*TA(I)/X1
  261 CONTINUE
      RETURN
  470 MOVE=2
      GO TO 490
  480 MOVE=3
  490 DELDST=QP5*OFSETF*CUTRAD
      GO TO 520
  500 MOVE=4
  510 DELDST=QP5*OFSETC*CUTRAD
  520 DIST=DIST+DELDST
  530 IF (KALC)540,540,550
  540 KALC=1
      GO TO 560
  550 KALC=0
C     EXIT IF ZERO DIAMETER CUTTER
  560 IF(CUTRAD.GT.QNUL)GO TO 570
      CALL AERR(3510)
  570 IF (JFOU)590,590,580
  580 OFSETC=OFCSTO
      OFSETF=OFFSTO
      JFOU=1
  590 DO 600 J=1,NC
      DO 600 I=1,3
  600 XIPRIM(I,J)=COR(I,J)+DIST/BL(J)*W(I,J)
      DO 610 I=1,3
  610 XIPRIM(I,NC+1)=XIPRIM(I,1)
      DO 630 J=1,NC
      ADDEM1=QNUL
      DO 620 I=1,3
      VPRIM(I,J)=XIPRIM(I,J+1)-XIPRIM(I,J)
  620 ADDEM1=(VPRIM(I,J))**2+ADDEM1
      DO 630 I=1,3
  630 UPRIM(I,J)=VPRIM(I,J)/DSQRT(DABS(ADDEM1))
C     COLLAPSE TESTS
  640 DO 644 J =1,NC
      KTAB(J) = 0
      DO 644 I=1,3
      IF(DABS (U(I,J+1)-UPRIM(I,J))-QP005)644,644,642
  642 KTAB(J)=1
  644 CONTINUE
  646 NCUTBK=NC
      KUTBAC=0
      KOLAPS=0
      PHITMP=Q1P
      DO 950 J=1,NC
      IF(KTAB(J))650,650,780
  650 IF(JONE)710,710,655
  655 JONE=0
  660 IF (KUTBAC-J+1)680,670,680
  670 JSAVE=J
      KOLAPS=0
      GO TO 950
  680 INTER=1
      KONE=J-KOLAPS-1
      KTWO=J
      GO TO 890
  690 DO 700 I=1,3
      JDUMMY=J-KUTBAC
  700 CTEMP(I,JDUMMY)=PTINT(I)
      KOLAPS=0
      GO TO 730
  710 DO 720 I=1,3
      JDUMMY=J-KUTBAC
  720 CTEMP(I,JDUMMY)=XIPRIM(I,J)
  730 IF (J-NC)950,740,740
  740 IF (JTWO)950,950,745
  745 JTWO=0
  750 INTER=2
      KONE=J
      KTWO=JSAVE
      GO TO 890
  760 DO 770 I=1,3
  770 CTEMP(I,1)=PTINT(I)
      GO TO 950
  780 NCUTBK=NCUTBK-1
      KUTBAC=KUTBAC+1
      KOLAPS=KOLAPS+1
      JONE=1
      IF (J-1)790,790,800
  790 JTWO=1
      GO TO 950
  800 IF (J-NC)950,810,810
  810 IF (NCUTBK-1)820,820,850
  820 MOVE=5
      IF(KALC) 830,830,825
  825 NUM = 1
      IF(IBM2) 826,826,827
  826 JGR=1
      RETURN
  827 JGR=2
      RETURN
  830 DO 840 JJ=1,NC
      DO 840 I=1,3
  840 XIPRIM(I,JJ)=CTEMP(I,JJ)
      JGR=3
      RETURN
  850 IF (JTWO)880,880,855
  855 JTWO=0
  860 KTWO=JSAVE
  870 INTER=2
      KONE=J-KOLAPS
      GO TO 890
  880 KTWO=1
      GO TO 870
C     CALCULATE INTERSECTION OF NON-COLLAPSING SIDES
  890 ITEST = 1
      KT1=KONE
      KT2=KTWO
  895 CALL AVDOT(UPRIM(1,KT1),UPRIM(1,KT2),COSVA)
      ADDEM2=DSQRT(DABS((Q1P+COSVA)/Q2P))
      IF(ADDEM2-PHITMP) 896,898,898
  896 PHITMP=ADDEM2
  898 SIN2VA=Q1P-COSVA**2
      IF(SIN2VA-QP0001)2140,2140,2340
C     SIDES ARE NEARLY PARALLEL - TAKE AVERAGE OF TWO VERTICES
 2140 DO 2240  L=1,3
 2240 PTINT(L)=(XIPRIM(L,KONE+1)+XIPRIM(L,KTWO))/Q2P
      GO TO 940
C     SIDES INTERSECT - COMPUTE INTERSECTION
 2340 ALPHA=QNUL
      DO 2440 L=1,3
 2440 ALPHA=ALPHA+(XIPRIM(L,KT2)-XIPRIM(L,KT1))*
     1(UPRIM(L,KT1)-UPRIM(L,KT2)*COSVA)
      ALPHA=ALPHA/SIN2VA
      ADDEM1=QNUL
      DO 2540  L=1,3
 2540 ADDEM1=ADDEM1+(XIPRIM(L,KT1+1)-XIPRIM(L,KT1))**2
      ADDEM1=DSQRT(DABS(ADDEM1))
      GO TO (2640,2740,3040,3340,3540,3840),ITEST
 2640 IF(ALPHA)2650,2140,3140
 2650 KT1=KT1-1
      IF(KT1)2680,2680,2660
 2660 IF(KTAB(KT1)) 2670,2670,2650
 2670 ITEST=2
      GO TO 895
 2680 KT1=NC
 2690 IF(KTAB(KT1)) 2670,2670,2700
 2700 KT1=KT1-1
      IF(KT1-KT2) 2140,2140,2690
 2740 IF(ALPHA) 2140,2140,2840
 2840 IF(ALPHA-ADDEM1) 2940,2940,2140
 2940 KT2=KT1
      KT1=KTWO
      ITEST=3
      GO TO 2340
 3040 IF(ALPHA) 2140,2140,3050
 3050 IF(ALPHA-ADDEM1) 3060,3060,2140
C     SIDE OUTSIDE POLYGON - PLACE SIDE IN COLLAPSE CONDITION
 3060 KTAB(KONE) =1
      GO TO 3870
 3140 IF(ALPHA-ADDEM1) 3240,2140,2140
 3240 KT1=KTWO
      KT2=KONE
      ITEST=4
      GO TO 2340
 3340 IF(ALPHA) 2140,2140,3350
 3350 IF(ALPHA-ADDEM1) 5940,5940,3440
 3440 KT1=KT2
      KT2=KTWO
 3450 KT2=KT2+1
      IF (KT2-NC) 3460,3460,3480
 3460 IF (KTAB(KT2)) 3470,3470,3450
 3470 ITEST=5
      GO TO 895
 3480 KT2=1
 3490 IF(KTAB(KT2)) 3470,3470,3510
 3510 KT2=KT2+1
      IF (KT2-KT1-1) 3490,2140,2140
 3540 IF(ALPHA) 2140,2140,3640
 3640 IF (ALPHA-ADDEM1) 3740,3740,2140
 3740 KT1=KT2
      KT2=KONE
      ITEST=6
      GO TO 2340
 3840 IF (ALPHA) 2140,2140,3850
 3850 IF(ALPHA-ADDEM1) 3860,3860,2140
C     SIDE OUTSIDE POLYGON - PLACE SIDE IN COLLAPSE CONDITION
 3860 KTAB(KTWO) = 1
 3870 JONE=0
 3880 JTWO=0
      GO TO 646
 5940 DO 6040 L=1,3
 6040 PTINT(L)=XIPRIM(L,KT1)+ALPHA*UPRIM(L,KT1)
  940 GO TO (690,760),INTER
  950 CONTINUE
      JGR=4
      RETURN
      END

