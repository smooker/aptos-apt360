      SUBROUTINE AMON5(KRET)
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4,MODIFICATION 4 ***
      IMPLICIT REAL*8(A-H,O-Z)
       REAL*8 INWORD,NAME,IDIS,MACNAM,KRFSYS
       LOGICAL*1 LCLAS1(2400),GAT(2)
       INTEGER*2 KAT/0/,KTEMP(2),KTERM(2)/2,Z0E02/,KCOMMA(2)/0,Z0904/
       INTEGER DEBUG,SUM
C     THIS ROUTINE PRE-PROCESSES THE INDIVIDUAL STATEMENTS RESULTING
C     FROM A MACRO CALL
C          COMMON  STORAGE
C               *          *          *          *          *
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
      COMMON/AMXTAB/MAXTAB,MAXVS1,MAXVS2,MAXPTP,MAXSCL,MAXVS,MAXVST,MXPT
     1PP,MXCAN,MXSRCN,MAXSLR,MAXELM,MAXPOT
      COMMON/AILMTB/ELMENT(600),ICLASS(600),JLMENT
       EQUIVALENCE (ICLASS(1),LCLAS1(1)),(KAT,GAT(1))
      COMMON/AINPOT/INWORD(14),MORE,IFIRST
      COMMON/ASCALR/SCALR(180),ISCWS,NSURF,LOCTEM,IARGTP
      COMMON/AVST/VST(7200)
       DIMENSION PTPP(7200),CANON(7200),ICANON(14400),IVST(14400)
       EQUIVALENCE (VST(1),IVST(1),PTPP(1),CANON(1),ICANON(1))
      COMMON/ABREAK/NEXTNW,NRELCN,KANLCN,LOCSEQ,NEXTCN,NWONRD,LPLOCN,
     1 JSW4,ISN,K,MXLOOP,JSW2,JSAV,JSW1,MAXMV,MXNEST,INILL,KF
      COMMON/AMACRO/LIMCAN,LMDW,NITEMS,JWHAT,MACREC,MACVST,MACERR
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
      COMMON/AMCSTF/MACNAM(5),MACCUR,MACLCN(5),MACRD,MACSTR(5),NMACVR
     1,NUMIDS,IDLOCN,MACIDS(5),ISVID
      COMMON/ADATA1/ANODEF,BLANX,BLANKS,SYN,TLAXIS,DUMMY,PLENT,LOOPST
     1 ,LOOPND,MACRO,NTRMAC,NCALL,LAPTH,JAPTH,IPLUS,NCOMMA,IFF,IC(10),
     2 LLASS
      COMMON/AKLAS7/PPSEQ1,PPSEQ2,IDIS,IISN,IDVST,KFK
       EQUIVALENCE (ITEMP,KTEMP(1)),(ITERM,KTERM(1)),(JCOMMA,KCOMMA(1))
C..
C...  CHECK FOR ID TO ESTABLISH START OF NORMAL STATEMENT INFORMATION
      IF(JLMENT.EQ.1) GO TO 800
      IF(ICLASS(2).NE.JAPTH) GO TO 800
  740  GAT(2) = LCLAS1(4)
       GO TO (750,800,760),KAT
  750 NAME=ELMENT(1)
      GO TO 770
  760 A=ELMENT(1)
      CALL AIFUN8(A,NAME)
  770 CALL AVS1CK(J)
      IF(JSUBER.EQ.0) GO TO 775
  772 K = 3
      GO TO 810
  775 IF (J.EQ.3) GOTO 780
            IF(J.EQ.4) GO TO 780
       JSUBER = 6
       GO TO 998
  780 IDIS=NAME
      IDVST=NAMSUB
C...  ID FOUND
       KTEMP(2) = INDXPT - MAXVST
       KTEMP(1) = IRECN + 1
       JTEMP1 = 2*NAMSUB - 1
       IVST(JTEMP1+2) = 3
       IVST(JTEMP1+3) = ITEMP
       GO TO 772
C...  NO ID FOUND
  800 K = 1
      IDIS = 0.0D0
      IDVST = 0
  810       IF(ICLASS(K).NE.ITERM) GO TO 880
C
C...  TERMAC FOUND
C.. OUTPUT CLASS7 PTPP FOR IT AND RETURN TO THE PREVIOUS MODE OF PROCES
  850 CALL ACLAS7
C...  DECREASE MACRO COUNT FOR NESTING
      MACCUR=MACCUR-1
C..  MACCUR EQUALS ZERO THEN PREVIOUS MODE WAS NOT MACRO EXEC.
      IF (MACCUR.NE.0) GOTO 870
      IDLOCN = ISVID
C...  NESTINGS COMPLETE - LAST MACRO FINISHED
  860 MACRD = 0
      NRELCN = MAXVST + 1
       KRET = 1
C.. NWONRD.NE.0 INDICATES TO RETURN TO LOOP EXEC. MODE
         IF (NWONRD.NE.0) GOTO 998
C.. FLUSH EXISTING PTPP TABLE AND RETURN TO NORMAL MODE PROCESSING
         LOOP = 0
       JMODE = 6
      INPTP = 0
      CALL APTPUT
      GO TO 998
C
C...  REINSTATE CALLING PROGRAM TO RESUME PROCESSING
870      KANLCN = MACLCN(MACCUR)
       JTEMP1 = 2*KANLCN - 1
       NRELCN = ICANON(JTEMP1)
       NEXTCN = 1
       JTEMP1 = 2*MACSTR(MACCUR) - 1
       NMACVR = ICANON(JTEMP1+3)
      NAME = MACNAM(MACCUR)
      CALL AVS1CK(J)
      IDLOCN = MACIDS(MACCUR)
      CALL APRINT(4)
      KRET = 1
      GO TO 998
C
C...  STATEMENT WAS NOT A TERMAC
  880 KN=K
       JTEMP2 = 4*K - 3
      JSW1 = 0
C
  890  JTEMP1 = 4*KN - 3
       GAT(2) = LCLAS1(JTEMP1+3)
            IF(KAT.NE.1) GO TO 970
  900 I = MACSTR(MACCUR) +3
       JTEMP1 = 2*I - 1
       NMACVR = ICANON(JTEMP1-3)
C...  CHECK FOR MACRO VARIABLES IN STATEMENT
      IF(NMACVR.EQ.0) GO TO 990
C
       DO 965  II = 1,NMACVR
      IF(ELMENT(KN).NE.CANON(I))  GO TO 960
C...  MACRO VARIABLE FOUND - MAKE SUBSTITUATION
C...  IS THIS A CALL/   STATEMENT
       GAT(2) = LCLAS1(JTEMP2+2)
            IF(KAT.NE.7) GO TO 950
C...     YES - IF VARIABLE FOLLOWS COMMA, IT STARTS A VARIABLE
C...     ASSIGNMENT PHRASE - DO NOT SUBSTITUTE VALUE IN THIS CASE
            IF(ICLASS(KN-1).EQ.JCOMMA) GO TO 960
  950 ELMENT(KN) = CANON(I+3)
       ICLASS(KN) = ICANON(JTEMP1+9)
      GO TO 970
  960 I = I+5
  965  JTEMP1 = JTEMP1 + 10
C
  970 KN = KN+1
  980 IF(KN.LE.JLMENT)GO TO 890
C
  990 CALL APRINT(1)
      KRET = 0
  998 RETURN
      END

