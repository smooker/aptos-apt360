      SUBROUTINE AFINI
C..
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4,MODIFICATION 4 ***
C..
      IMPLICIT REAL*8 (A-H,O-Z)
      LOGICAL*1 ICLS1(2400)
      INTEGER*2 IBR
      INTEGER DEBUG,SUM,IPT(600)
       REAL*8 KRFSYS,NAME,INWORD,MACNAM,IDIS
      COMMON/ABREAK/NEXTNW,NRELCN,KANLCN,LOCSEQ,NEXTCN,NWONRD,LPLOCN,
     1JSW4,ISN,K,MXLOOP,JSW2,JSAV,JSW1,MAXMV,MXNEST,INILL,KF
       COMMON/AKLAS7/PPSEQ1,PPSEQ2,IDIS,IISN,IDVST,KFK
      COMMON/AMCSTF/MACNAM(5),MACCUR,MACLCN(5),MACRD,MACSTR(5),NMACVR
     1 ,NUMIDS,IDLOCN,MACIDS(5),ISVID
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
      COMMON/AILMTB/ELMENT(600),ICLASS(600),JLMENT
      COMMON/AINPOT/INWORD(14),MORE,IFIRST
      COMMON/ALIBRY/ALIB(126),SEGNAM,DUM1,IRDMOD,IA1(3)
      COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,
     1TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
      COMMON/AMXTAB/MAXTAB,MAXVS1,MAXVS2,MAXPTP,MAXSCL,MX(8)
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
C..
      EQUIVALENCE (PT(1),IPT(1)),(ICLASS(1),ICLS1(1))
      EQUIVALENCE(TAPES4,ERRTAP),(POCTAP,PTPTAP)
C..
C...     TEST FOR TERMINATION OF A PROGRAM WITHOUT A FINI
            IF(JSUBER.EQ.23) GO TO 520
C
C.. OUTPUT THE CLASS 7 FOR THE FINI
      KFK = 2
      CALL ACLAS7
C.
C.. PROCESS THE STATEMENT I.D. IF ANY
      CALL AMON2
      IF(JSUBER.EQ.0) GOTO 100
      IBR = 1
      GOTO 600
C.
C.. PROCESSING A MACRO IS ILLEGAL
  100 IF(MACRD.EQ.0) GOTO 200
      JSUBER = 1600
      IBR = 2
      GOTO 600
C..
C.. EXEC A LOOP IS ILLEGAL TOO
  200 IF(NWONRD.EQ.0) GOTO 300
      JSUBER = 1601
       IBR = 2
      GOTO 600
C..
C..  ONLY NORMAL PROCESSING MODE IS ACCEPTABLE
  300 IF(LOOP.EQ.0) GOTO 400
      JSUBER = 6102
       IBR = 2
      GOTO 600
C..
C..  FINI MUST BE BY ITSELF OR WITH A STMT.I.D., ONLY
  400       IF(JLMENT.EQ.1) GO TO 700
      IF(JLMENT.NE.3) GOTO 510
      IF(ICLS1(7).NE.7) GOTO 510
      IF(ICLS1(8).EQ.4) GOTO 700
C..
C..  FINI INPUT WITH AN ILLEGAL FORMAT
  510 JSUBER = 23
  520  IBR = 3
C..
  600 CALL ADIAGP
       GO TO (100,400,700),IBR
C..
C.. CLOSE THE MACRO AND SEGMENT LIBRARIES, REWIND LOOP STORAGE AND
C.. THE CANON OVERFLO FILE
C..
  700 CALL ATAPOP(CANTAP,1,IOFLAG)
      CALL ATAPOP(ERRTAP,1,IOFLAG)
      CALL APREAD(INWORD(1),10,SEGNAM,JSUBER)
      IRDMOD = 0
C..
C.. HAVE WE BUILT TABLES IN PASS1 THAT EXCEEDED THE ALLOWABLE SIZE
C.
      IC = MAXVS1+1+MAXVS2+MAXPTP+MAXSCL
       IF(IC.LE.5900) GO TO 800
C..
C.. THE TABLE SIZE WAS EXCEEDED
       JSUBER = 40
       CALL ADIAGP
C..
C..   OUTPUT THE CLASS 8 PTPP RECORD -- MUST BE THE LAST REC. THEREON
C..
  800 IPT(1) = 8
      IPT(2) = 0
      INPTP = 1
      JMODE = 5
      CALL APTPUT
C.. MOVE THE PTPP TABLE TO THE PTPP STORAGE FILE -- PTPTAP
       JMODE = 6
      CALL APTPUT
C.. WRITE THE END OF FILE AND REWIND THE PTPTAP FILE
      CALL ATAPOP(PTPTAP,2,IOFLAG)
      CALL ATAPOP(PTPTAP,1,IOFLAG)
C..
C.. INDICATE TO THE SECTION 1 CONTROL PROGRAM THAT PASS ONE PROCESSING
C.. IS COMPLETED
      IFINI = -1
      CALL ASCNTL
      STOP
      END

