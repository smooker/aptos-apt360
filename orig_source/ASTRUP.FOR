      SUBROUTINE ASTRUP
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4,MODIFICATION 4 ***
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
      IMPLICIT REAL*8 (A-H,O-Z)
      REAL*4 AB
C...
      COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,
     1TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
C... A2CMMN START
      COMMON/A2CMMN/ SP(3) ,SN(3)     ,TP(3)     ,TN(3)     ,SNK(3)    ,
     1SNL(3)    ,SPK(3)    ,SPL(3)    ,TNK(3)    ,TNL(3)    ,TPK(3)    ,
     2TPL(3)    ,PLNV(3)   ,CC(3)     ,U1(3)     ,CUTH(3)   ,SFVCT(3)  ,
     3VNDIR(3)  ,VMD(3)    ,VT(3)     ,TEE(3)    ,SLX(3)    ,DPLAN(3)  ,
     4S(1)      ,RC(1)     ,PLND(1)   ,TH(1)     ,CSD(1)    ,Z(1)      ,
     5EPS1(1)   ,EPS2(1)   ,EPS3(1)   ,EPS4(1)   ,EPS6(1)   ,EPS8(1)   ,
     6TAU(1)    ,TAU1(1)   ,TAU2(1)   ,STCK(1)   ,STCKN(1)  ,STCK1(1)  ,
     7STCK2(1)  ,COS1(1)   ,DPMX1(1)  ,CPLFL(1)  ,CPTST(1)  ,PLNCS(1)  ,
     8PLND1(1)  ,PLTST(1)  ,PAST(1)   ,SPAST(1)  ,ADCS(1)   ,H(1)      ,
     9CUTR(1) ,AFILLR(500) ,IAFL(1)   ,IPONTR(1) ,IFAR(1)   ,IPL(1)
      COMMON/A2CMMN/IUNFL(1),ISFTYP(1),ITLON(1)  ,ISVFL(1)  ,IFL4(1)   ,
     1IOP(1)    ,IOPSET(1) ,JIOPS(1)  ,NOTAN(1)  ,JENT(1)   ,JU1(1)    ,
     2ISIGCR(1) ,ITSEG(1)  ,JTLFLG(1) ,LOFS(1)   ,LIMFL(1)  ,ICSTR(1)  ,
     3JTN(1)    ,ICHKCT(1) ,J20(1)    ,J21(1)    ,J22(1)    ,J23(1)    ,
     4J24(1)    ,J50(1)    ,J51(1)    ,INDIR(1) ,IFILLR(209),TE(3)     ,
     5TEK(3)    ,TEL(3)    ,TES(3)    ,TA(3)     ,TAK(3)    ,TAL(3)    ,
     6PMOVE(3)  ,TI(3)     ,TIK(3)    ,TIL(3)    ,U2(3)     ,UVEC(3)   ,
     7VTEM(3)   ,CMOVE(3)  ,EX(3)     ,EY(3)     ,EZ(3)     ,VNUL(3)   ,
     8TM(3)     ,DIR(3)    ,AXIS(3)   ,AXIS1(3)  ,AXIS2(3)  ,AXIS3(3)  ,
     9REFPNT(3) ,RGT(3)    ,FWD(3)    ,UP(3)     ,ZLNORM(3) ,ZLPNT(3)
      COMMON/A2CMMN/TNDIR(3), VA(3)   ,TMVCMP(3) ,P1(3)     ,P2(3)     ,
     1PNT(3)    ,PNT1(3)   ,OLDU1(3)  ,OGLE(3)   ,RZERO(3)  ,TANMOT(3) ,
     2TLEND1(3) ,V(3)      ,CEND(3)   ,DELMOT(3) ,D2(3)     ,DNMOT(3)  ,
     3AX4(3)    ,A         ,B         ,C         ,RA        ,HI        ,
     4ALPHA     ,GAMMA     ,CAGL      ,SAGL      ,COM1      ,COM4      ,
     5COSTH     ,CTOCL     ,DIAM      ,DIF       ,DIFOUT    ,DINC      ,
     6DP        ,DPE       ,DPI       ,DPL       ,DPMAX     ,DP1       ,
     7DPCNT     ,DSMOV     ,D1        ,D2A       ,EL1       ,EL2       ,
     8FIPNT     ,FLIPCK    ,HAFDIA    ,HCHORD    ,OFFSET    ,PROD1     ,
     9PROD2     ,PSI       ,RADNO     ,RC1       ,RDRM      ,RDRN
      COMMON/A2CMMN/ RONE  ,RZEROL    ,SAVE1     ,SIUTH     ,TANGL     ,
     1THETA     ,ALP       ,EPS7      ,VAMAX     ,VL        ,ZDOTC     ,
     2ZGAMMA    ,ZIGN      ,ZL        ,ZL1       ,ZL2       ,ZNPTS     ,
     3TOLBND    ,CENDIS    ,CENLEN    ,CHORD     ,ABCD(2)   ,ACARD(2)  ,
     4SAVE(6)   ,CUTDAT(7) ,TEM(10)   ,TEMP(20)  ,TCDAT(260),QEQUIV(20),
     5IS        ,IIS       ,IT        ,IIT       ,IPS       ,IIPS      ,
     6IDS       ,IIDS      ,ICS       ,IICS      ,IGS       ,IIGS      ,
     7ICDEFL    ,ICDEFS    ,IAUTPS    ,IGO       ,ICRDCT    ,ICUT      ,
     8IGTFLG    ,INOPS     ,ISRCH     ,IOFSET    ,ISTRUP    ,I3DFLG    ,
     9MULOUT    ,MULTAX    ,NUMAX     ,NUMSFS    ,NUMSUR    ,IGOUG
      COMMON/A2CMMN/ IPDPL ,NUMDIM    ,IRSTRT    ,ICSCNT    ,I3        ,
     1I31       ,J         ,JA        ,JL        ,JS        ,JT        ,
     2KC        ,KND       ,KR        ,L         ,INCFS     ,NP        ,
     3IBEGIN    ,IFAR1     ,IK        ,INS1      ,ITNFLG    ,IVAMAX    ,
     4IWS       ,IIWS      ,IZ        ,NEXT1     ,NEXT2     ,NPTS      ,
     5NUMPT1    ,JAM       ,JAP       ,JTUSED    ,IFRL      ,N         ,
     6M         ,MDIC      ,JBR       ,JCKR      ,JCPR      ,JCR       ,
     7JDR       ,JGR       ,JMIN      ,JMINR     ,JPR       ,JPXR      ,
     8JTR       ,JCNT1     ,JCNT2     ,JCNT3     ,JSW       ,JTKF      ,
     9LISV      ,LSV       ,IPT       ,JFIND     ,IC        ,ICC
      COMMON/A2CMMN/  IL   ,K         ,NUMPTS    ,IAMDCT    ,IFL2      ,
     1J5        ,J6        ,JW6       ,J10       ,J12       ,J13       ,
     2J40       ,J43       ,J54       ,J103      ,PROBUF(100)          ,
     3CANSTO(2000) , IER   ,INSTR1    ,INSTR2    ,NWDS      ,ICL       ,
     4NREC      ,IRECNO    ,ITRFLG    ,NW        ,IDUMMY
C... A2CMMN END
      COMMON/A2CTDF/         TLHITE(1) ,TANHI(1),  TANLO(1)  ,UMAX(1)  ,
     1R1(1)     ,CORRAD(1) ,TCONT(1)  ,TLINC(65)
C...
      DIMENSION SINL(1), COSL(1), TLLDAT(1), PSSAV(9), AB(2)
C...
      EQUIVALENCE(SINL(1),TANHI(1)), (COSL(1),TANLO(1)), (TLLDAT(1),
     1TCONT(1))
C...
      COMMON/A2FPC / Q15X01,QP9X01    ,QP6X01    ,QP5X01    ,QP4X01    ,
     1QP0001    ,QP001     ,QP01      ,QP1       ,Q1P       ,Q10P      ,
     2Q1000P    ,Q1PE5     ,Q1PE6     ,Q1PE10    ,Q1PE20    ,Q1PE30    ,
     3Q1PE36    ,Q1PE38    ,QP8X01    ,QP7X01    ,
     4QP4X09    ,QP9       ,QP99      ,QP995     ,QP997     ,QP999     ,
     5QP9999    ,QP4X95    ,QP5X95    ,QP6X9     ,QP7X9     ,
     6QP6X05    ,QP5X05    ,QP4X05    ,QP0005    ,QP005     ,QP05      ,
     7QP5       ,Q5P       ,                                 Q4X045    ,
     8QP0002    ,QP0047    ,QP017     ,Q1RAD     ,QP0349    ,QP125     ,
     9QP6       ,QP2       ,QP2499    ,QP25      ,QP3
      COMMON/A2FPC / QP7   ,QP75      ,QP8       ,QP866     ,Q1P01     ,
     1Q1P1      ,Q1P2      ,Q1P25     ,Q1P5      ,Q2P       ,Q2P5      ,
     2Q3P       ,Q3P5      ,Q4P       ,Q8P       ,Q11P      ,Q45P      ,
     3Q90P      ,Q130P     ,Q4500P    ,Q9000P    ,QP02      ,QNUL      ,
     4QPIE       ,QFIL(9)
C...
C...  I ... INDEX USED TO SELECT SURFACES DURING  STEP ONE AND TWO.
C...  IA ... INTERNAL COUNTER ... USED TO PROCESS INDIR(IF ANY).DURING
C...  STEP ONE, IA IS INCREMENTED BY ONE EACH TIME A SURFACE WITH AN
C...  INDIR IS ENCOUNTERED. DURING THE STEP TWO, IT IS DECREMENTED BY
C...  ONE EACH TIME AN INDIR SURFACE IS PROCESSED.
C...  IB ... INTERNAL BRANCHING INDICATOR
C...       =1 DURING STEP ONE
C...       =2 DURING STEP TWO
C...       =3 DURING STEP THREE ... SPECIAL CASE WHEN INDIR VECTOR DOES
C...          NOT PIERCE THE SURFACE.
C...  TEMPRY ... USED TO STORE THE LARGEST NORMAL DISTANCE YET
C...             ENCOUNTERED. USED WHEN AN INDIR VECTOR DOES NOT
C...             PIERCE ITS ASSOCIATED SURFACE.
C...
C...
      DATA AB(1),AB(2)/4HASTR,4HUP  /
      DIMENSION SPEXEY(3), TPEXEY(3), TNEXEY(3)
      DIMENSION  SNEXEY(3)
C...
C...  *************************************************  ASTRUPTP  ****
      CALL ADYNDP (AB(1),1,111100)
C...
      MISIND = 0
      IPSFL = 0
      CALL AVSTO(TE,TEK)
      NOTAN(IICS) = 0
C...
C...  NUMAX=5 WHEN TLAXIS/NORMPS,NORMDS
C...               TLAXIS/ATANGL,K,ANG1,SVECT(CUTANG,ANG2)
C...               TLAXIS/PARLEL,K
C...  FOR TLAXIS/SVECT, NUMAX=3
C...
      IF(NUMAX.EQ.5) GO TO 5000
C...
C...  STATEMENT 9000 IS AERR(603) .. ILLEGAL PROTAP RECORD FOR STARTUP.
C...  IF ONE-SURFACE STARTUP (GO/S1) AND NO NOPS, NUMSUR = 2.
C...  IF ONE-SURFACE STARTUP(GO/S1) AND NOPS AND AUTOPS, NUMSUR = 2.
C...  AFTER ASTRUP, ASTUP2, AND AOFSET OPERATION, IAUTPS=0,  INOPS=0.
C...  BUT THESE TWO FLAGS ARE MAINTAINED AFTER ARLM3 AND ARLM2.
C...
 1000 IF(INOPS)9000,1075,1010
 1075 IF(NUMSUR-1)1070,1060,1070
 1010 IF (NUMSUR-1) 9000,1030,1020
C...  NOPS IN EFFECT, BUT STARTUP NUMBER OF SURFACES NOT = 1  ** 601 **
 1020 CALL AERR (601)
C...
C...
 1030 IF(IAUTPS)9000,1070,1060
 1060 NUMSUR = NUMSUR+1
C...
C...                     *** STEP ONE ***
C...
C...  EXAMINE ALL SURFACES IN THE ORDER DS, PS, CS.  DEFER ANY SURFACE
C...  FOR WHICH INDIR VECTOR HAS BEEN GIVEN UNTIL STEP TWO.
 1070 I = 0
      IA = 1
      IB = 1
      TEMPRY = QNUL
C...
 1080 I = I+1
 1090 IF (NUMSUR-I) 1300,1100,1100
 1100 IF (I-2) 1110,1120,1130
C...
 1110 IS = IDS
      IIS = IIDS
      GO TO 1140
C...
 1120 IS = IPS
      IIS = IIPS
      GO TO 1140
C...
 1130 IS = ICS
      IIS = IICS
C...
C...  IF INDIR GIVEN DEFER EXAMINATION TILL STEP TWO
C...  FOR SURFACES WITHOUT INDIR, DETERMINE THE SURFACE SIDE THE CUTTER
C...  IS TO POSITION TO. -- TWO WAYS TO DO -- IF SFVCT GIVEN , ** A **
C...                                          IF NO SFVCT    , ** B **
 1140 IF (INDIR(IIS)) 9000,1160,1150
 1150 IA = IA+1
      GO TO 1080
C...
C...
C...
 1160 CONTINUE
 1161 IF(ISVFL(IIS))9000,1180,1170
C...  ** A **       SET TI=SFVCT AND CALL ACHECK
C...           SFVCT CONTROLS SETTING OF Z WHICH WILL CONTROL THE SIDE
C...           OF SURFACE THE SN POINTS TO, WHICH WILL CONTROL THE SIDE
C...           OF SURFACE CUTTER WILL POSITION TO.  SFVCT POINTS FROM
C...           TO SIDE OF THE SURFACE IN THE DIRECTION OF PAST SIDE
C...
 1170 CALL AVSTO(SFVCT(IS),TI)
      CALL AVSTO(SFVCT(IS),TN(IS))
      J20(IIS) = 0
      J23(IIS)=1
      CALL ACHECK
      IF(CSD(IS))1240,1210,1240
C...
C...  ** B **       CALL AMIND, WHICH SETS A VALUE OF Z BASED ON TM.
C...           THE VALUE OF Z WHICH WILL CONTROL THE SIDE OF SURFACE
C...           THE SN POINTS TO, WHICH WILL CONTROL THE SIDE OF SURFACE
C...           CUTTER WILL POSITION TO.  TO SIDE OF SURFACE IS TO BE
C...           THE SIDE TM IS INITIALLY ON, PAST SIDE IS THE OPPOSITE
C...           SIDE.
C...
 1180 CALL AVSTO(EX,TN(IS))
      KBOTH = 0
      IEXEY = 0
      SEXEY = Q1PE38
      IF(((INDIR(IIS) + ISVFL(IIS)) .EQ. 0) .AND. ((J24(IIS) .EQ. 7) .OR
     1. (J24(IIS) .EQ. 8))) KBOTH = 1
 1190 JMINR = 1
      IOPSET(IIS) = 0
      JENT(IIS) = 1
      JTN(IIS) = 0
      JU1(IIS) = 1
      JIOPS(IIS) = 0
 1200 CALL AMIND
      IF((IS .EQ. MISIND) .AND. (JMIN .EQ. 0)) MISIND = - IS
      IF((KBOTH .EQ. 0) .AND. (JMIN .NE. 0)) GO TO 3150
      IF(KBOTH .EQ. 0) GO TO 1210
      IEXEY = IEXEY + 1
      IF(IEXEY .GE. 2) GO TO 77777
      IF(JMIN .NE. 0) GO TO 77776
      SEXEY = S(IS)
      ZEXEY = Z(IS)
      CALL AVSTO(SN(IS),SNEXEY)
      CALL AVSTO(TN(IS),TNEXEY)
      CALL AVSTO(TP(IS),TPEXEY)
      CALL AVSTO(SP(IS),SPEXEY)
77776 CALL AVSTO(EY,TN(IS))
      GO TO 1190
C...
77777 IF((JMIN .NE. 0) .AND. (SEXEY .EQ. Q1PE38)) GO TO 3150
      IF(JMIN .NE. 0) GO TO 77775
      IF(SEXEY .EQ. Q1PE38) GO TO 1210
      IF(DABS(SEXEY) .GE. DABS(S(IS))) GO TO 1210
77775 CALL AVSTO(TNEXEY,TN(IS))
      CALL AVSTO(TPEXEY,TP(IS))
      CALL AVSTO(SPEXEY,SP(IS))
      S(IS) = SEXEY
      Z(IS) = ZEXEY
      CALL AVSTO(SNEXEY,SN(IS))
      JMINR = 0
 1210 CSD(IS) = DABS(S(IS))
 1240 IF(TEMPRY - DABS(S(IS)))1250,1250,1260
 1250 TEMPRY = DABS(S(IS))
 1260 GO TO (1080,1310,1270), IB
 1270 IB = 2
      GO TO 1500
C...                    *** STEP TWO ***
C...           AGAIN EXAMINE EACH SURFACE (DS,PS,CS) -- THIS TIME
C...           PROCESSING ONLY THOSE SURFACES WHICH HAVE INDIR VECTORS.
 1300 I = 0
      IB = 2
 1310 IA=IA-1
 1320 IF (IA) 9000,2000,1330
 1330 I = I+1
 1340 IF (NUMSUR-I) 9000,1350,1350
 1350 IF (I-2) 1360,1370,1380
C...
 1360 IS = IDS
      IIS = IIDS
      GO TO 1390
C...
 1370 IS = IPS
      IIS = IIPS
      GO TO 1390
C...
 1380 IS = ICS
      IIS =  IICS
C...
 1390 IF (INDIR(IIS)) 9000,1330,1400
C...
C...  FOR EACH SURFACE WHICH HAS INDIR, PIERCE SURFACE WITH INDIR
C...  VECTOR FROM TM (ADJUST FOR THICK)
C...
 1400 TEMP(1) = QP5 * CUTDAT(7)
      VTEM(1) = DMIN1(TEMP(1),CUTDAT(1))
      IF((J24(IIS) .NE. 4) .OR. (RC(IS) .GE. QNUL)) VTEM(1) = TEMP(1)
       IF(JTLFLG(IIS).EQ.1) VTEM(1) = TLHITE(65)
      CALL AVMULT(TA,VTEM(1),TP(IS))
      CALLAVADD(TP(IS),TE,TP(IS))
      CALL AVMULT (VNDIR(IS),TH(IS),VTEM)
      CALL AVADD (VTEM,TP(IS),TP(IS))
      CALL AVSTO(VNDIR(IS),TN(IS))
      IOP(IIS) = 1
      CALL ADDST
      IF(IER .NE. 0) MISIND = IS
      IF(IER) 1410,1430,1410
C...
C...
C...  SORRY, INDIR VECTOR DOES NOT PIERCE THE SURFACE
C...  MOVE CUTTER EXACTLY ALONG INDIR VECTOR BY LARGEST |S| YET COMPUTED
 1410 IB = 3
      GO TO 1160
C...
C...
C...  ADDST SUCCESSFUL ---
C...      MOVE THE CUTTER (TE) EXACTLY ALONG INDIR VECTOR BY AMOUNT
C...      EQUAL TO      (1) DISTANCE TO PIERCE POINT IF ON CONDITION
C...                   (2) ADJUSTED DISTANCE BY CUTDAT(1) FOR TO, PAST
 1430 TEMP(2) = S(IS)
      IF(ISFTYP(IIS)-3)1445,1440,1445
 1445 TEMP(2)=TEMP(2)-CUTDAT(1)
 1440 TEMP(5)=TEMP(2)-TAU(IS)
      IF((IPL(IIPS)+IPL(IIDS)+IPL(IICS)).EQ.3)TEMP(5)=TEMP(5)*QP75
      IF(IABS(MISIND) .NE. IS) GO TO 87878
      TEMP(5) = DABS(S(IS)) * QP75
87878 MISIND = 0
      CALL AVMULT(VNDIR(IS),TEMP(5),VTEM)
      CALL AVADD(TE,VTEM,TE)
      GOTO 1160
C...
 1500 IF(CSD(IS)-TEMPRY)1510,1510,1520
 1510 TEMP(2)=TEMPRY
      GO TO 1440
C...
 1520 IF(CSD(IS) - Q10P)1530,1510,1510
 1530 TEMP(2) = CSD(IS)
      GO TO 1440
C...                    *** STEP THREE ***
C...
C...  ** ACENTR WILL BE USED TO MOVE THE CUTTER INTO PROPER POSITION
C...     WITH RESPECT TO THE SURFACE(S).
C...  -- THERE ARE 3 MAJOR CASES -- NUMSUR = 1, 2, OR 3
C...     IF NUMSUR = 3, SET J50,J51=1 , CALL ACENTR AND DO 3 SURF ITER
C...************************************
 2000 IF (NUMSUR-2) 2010,3000,3120
C...                               *** ONE-SURFACE STARTUP ***
C...     SET UP PSEUDO PS AND CS , CALL ACENTR TO DO 3 SURF. ITERATION
C...  SET DIR = VINDIR(IDS) (IF GIVEN)  OR TN(IDS)
C...  EXAMINE DIR. ASSUME ITS COMPONENTS ARE DX,DY,DZ
C...   (1) IF DX COMPONENT NOT ZERO (|DX| > .0001)
C...       PLNV(ICS)=(DY,-DX,0) NORMALIZED
C...       PLNV(IPS)=(DZ,0,-DX) NORMALIZED
C...   (2) IF DX IS ZERO BUT DY IS NOT ZERO.
C...       PLNV(ICS)=(DY,-DX,0) NORMALIZED
C...       PLNV(IPS)=(0,DZ,-DY) NORMALIZED
C...   (3) IF DX AND DY ARE BOTH ZERO.
C...       PLNV(ICS)=(DZ,0,-DX) NORMALIZED
C...       PLNV(IPS)=(0,DZ,-DY) NORMALIZED
C...  AFTER THE PLANE VECTORS HAVE BEEN SETUP, THE D VALUES ARE
C...  CALCULATED SO THE PLANES PASS THROUGH THE TEK LOCATION, AND THE
C...  CANONICAL FORMS ARE STORED IN THE CANSTO ARRAY. SAVE AND RESET
C...  FLAGS AND SWITCHES AND CALL ACENTR TO DO THREE SURF ITERATION.
C...
 2010 IF(INDIR(IIDS))9000,2030,2020
 2020 CALL AVSTO(VNDIR(IDS),DIR)
      GO TO 2040
C...
 2030 CALL AVSTO(TN(IDS),DIR)
 2040 IF(DABS(DIR(1)) - QP0001) 2050,2050,2080
 2050 IF(DABS(DIR(2)) - QP0001) 2170,2170,2130
 2080 PLNV(ICS)   = DIR(2)
      PLNV(ICS+1) = -DIR(1)
      PLNV(ICS+2) = QNUL
      CALL AVNORM(PLNV(ICS),PLNV(ICS),IER)
      GO TO 2150
C...
 2100 PLNV(IPS) = QNUL
      PLNV(IPS+1) = DIR(3)
      PLNV(IPS+2) = -DIR(2)
      CALL AVNORM(PLNV(IPS),PLNV(IPS),IER)
C...
C...
 2110 CALL AVDOT(PLNV(IPS),TEK,PLND(IPS))
      CALL AVDOT(PLNV(ICS),TEK,PLND(ICS))
 2120 IC = IPONTR(IIPS)
      DO 2121 IKK=1,9
 2121 PSSAV(IKK) = CANSTO(IKK)
      IUNFLS = IUNFL(IIPS)
      IPLS = IPL(IIPS)
      ISFTPS = ISFTYP(IIPS)
      ITLONS = ITLON(IIPS)
      J24S = J24(IIPS)
      IPSFL = 1
      CALL ASTOR(3,4,CANSTO(IC),8)
      CALL AVSTO(PLNV(IPS),CANSTO(IC+4))
      CANSTO(IC+7) = PLND(IPS)
      ATHSAV = TH(IPS)
      TH(IPS) = 0.D0
      IUNFL(IIPS) = 1
      IPL(IIPS) = 1
      ISFTYP(IIPS) = 3
      ITLON(IIPS) = 0
      JENT(IIPS) = 1
      JTN(IIPS) = 0
      IOPSET(IIPS) = 0
      JU1(IIPS) = 1
      JIOPS(IIPS)=0
      CALL AVSTO(PLNV(IPS),TN(IPS))
      PAST(IPS) = Q1P
      J24(IIPS) = 1
      GO TO 3110
C...
C...
 2130 PLNV(ICS)   = DIR(2)
      PLNV(ICS+1) = -DIR(1)
      PLNV(ICS+2) = QNUL
      CALL AVNORM(PLNV(ICS),PLNV(ICS),IER)
      GO TO 2100
C...
 2150 PLNV(IPS)   = DIR(3)
      PLNV(IPS+1) = QNUL
      PLNV(IPS+2) = -DIR(1)
      CALL AVNORM(PLNV(IPS),PLNV(IPS),IER)
      GO TO 2110
C...
 2170 PLNV(ICS)  = DIR(3)
      PLNV(ICS+1) = QNUL
      PLNV(ICS+2) = -DIR(1)
      CALL AVNORM(PLNV(ICS),PLNV(ICS),IER)
C...
 2190 PLNV(IPS) = QNUL
      PLNV(IPS+1) = DIR(3)
      PLNV(IPS+2) = -DIR(2)
      CALL AVNORM(PLNV(IPS),PLNV(IPS),IER)
      GO TO 2110
C...
C...                               *** TWO-SURFACE STARTUP ***
C...     IF EITHER NO INDIR VECTORS OR TWO INDIR VECTORS GIVEN , SET
C...     J50,J51=0 AND CALL ACENTR TO DO TWO-SURFACE ITERATION
C...     IF ONLY ONE INDIR GIVEN, SET UP A PSEUDO CS AND TEST IT. IF IT
C...     LOOKS GOOD, DO 3-SURF. ITERATION , IF IT DOES NOT LOOK GOOD,
C...     DO TWO-SURFACE ITERATION.
C...  THE THIRD SURFACE IN A TWO-SURF STARTUP IS SETUP AS FOLLOWS.
C...      DIR = VINDIR(IS)
C...      PLNV(ICS) = TN(IPS) X TN(IDS)
C...      PLNV(ICS) = PLNV(ICS) X DIR   .... PLNV(ICS) IS NOW NORMAL
C...          TO A PLANE WHICH CONTAINS THE TANGENT VECTOR TO THE PS
C...          AND DS AND THE DIR VECTOR.
C...  NORMALIZE PLNV(ICS). IF NORMALIZATION FAILURE OCCURS, GO DO THE
C...  TWO-SURFACE ITERATION.  NOW, HAVING SETUP THIS PLANE, EXAMINE THE
C...  PS AND DS. IF NEITHER IS A PLANE, IGNORE THE SPECIAL PLANE AND DO
C...  A TWO-SURFACE ITERATION. IF EITHER OR BOTH ARE PLANES, EXAMINE
C...  THE PLANE VECTOR AND THE PSEUDO PLANE VECTOR. IF THEIR DOT PRODUCT
C...  IS LESS THAN .9999 (WHICH MEANS THAT THE TWO PLANES ARE NOT
C...  PARALLEL) STORE THE THIRD PLANE AS THE CS AND DO THE THREE-SURF
C...  ITERATION. THE D VALUE OF THE PLANE IS SETUP SO IT PASSES THROUGH
C...  THE TEK LOCATION, WHICH IS THE CUTTER LOCATION BEFORE ANY OF THE
C...  INTERIM INDIR MOVES. SET FLAGS FOR THE THIRD SURFACE AND GO DO
C...  THREE SURFACE ITERATION.
C...
 3000 IF(INDIR(IIDS))9000,3030,3010
 3010 IF(INDIR(IIPS))9000,3050,3020
C...
 3020 J50(IICS) = 0
      J51(IICS) = 0
      IS=ICS
      IIS=IICS
C...
      CALL ACENTR
C...
C...  JCR=0 INDICATES SUCCESSFUL ACENTR TWO-SURFACE ITERATION
      IF(JCR)3150,9999,3150
C...
 3030 IF (INDIR(IIPS)) 9000,3020,3040
 3040 IS = IPS
      IIS= IIPS
      GO TO 3060
C...
 3050 IS = IDS
      IIS = IIDS
 3060 CALL AVSTO(VNDIR(IS),DIR)
      CALL AVCROS (TN(IPS),TN(IDS),PLNV(ICS))
      CALL AVNORM(PLNV(ICS),PLNV(ICS),IER)
      IF (IER) 3020,3065,3020
 3065 CALL AVCROS(PLNV(ICS),DIR,PLNV(ICS))
      CALL AVNORM(PLNV(ICS),PLNV(ICS),IER)
      IF(IER) 3020,3070,3020
 3070 CALL AVCROS(PLNV(ICS),DIR,PLNV(ICS))
 3080 CALL AVNORM(PLNV(ICS),PLNV(ICS),IER)
 3090 IF(IER)3020,4100,3020
 4100 IF(IPL(IIPS))4107,4105,4107
 4105 IF(IPL(IIDS))4108,3020,4108
 4107 K=IPS
      KK=IIPS
      GO TO 4109
C...
 4108 K=IDS
      KK=IIDS
 4109 IC = IPONTR(KK)
      CALL AVDOT(PLNV(K),CANSTO(IC+4),ANS)
      IF(DABS(ANS).LE.QP9999) GO TO 3020
 3100 CALL AVDOT(PLNV(ICS),TEK,PLND(ICS))
 3110 IC = IPONTR(IICS)
      CALL ASTOR(3,4,CANSTO(IC),8)
      CALL ASTOR(6,4,CANSTO(IC+1),8)
      CALL AVSTO(PLNV(ICS),CANSTO(IC+4))
      CANSTO(IC+7)=PLND(ICS)
      J24(IICS) = 1
      IUNFL(IICS) = 1
      IPL(IICS) = 1
      JENT(IICS) = 1
      JTN(IICS) = 0
      IOPSET(IICS) = 0
      JU1(IICS) = 1
      JIOPS(IICS)=0
      CALL AVSTO(PLNV(ICS),TN(ICS))
      PAST(ICS) = Q1P
      ITLON(IICS)=0
      ISFTYP(IICS)=3
      IAFL(IICS)=-1
C...
C.......................*** 3-SURF STARTUP ***...............
 3120 J50(IICS) = 1
      J51(IICS) = 1
      DP=QNUL
 3130 IS = ICS
      IIS = IICS
      ICSCNT=1
C...
 3140 CALL ACENTR
C...
C...  JCR=1 INDICATES SUCCESSFUL ACENTR THREE SURFACE ITERATION
C...
      IF(JCR-1)3150,9999,3150
C...
C...  CENTR ITERATION FAILS TO CONVERGE FOR STARTUP           ** 602 **
 3150 CALL AERR(602)
C...
C...
 9999 ICL=5
      CALL ASTOS
      CALL ATAPE
      NW = 0
 9998 CONTINUE
      IF(IPSFL.EQ.1) GO TO 5030
C...  *************************************************  ASTRUPEX  ****
C...
C...
      RETURN
C...
 5000 CONTINUE
C      LOOK AHEAD ON PROTAPE FOR NEXT GOXXX TO GIVE MEANING TO LEAD ANG
C...  IF FINI IS ENCOUNTERED BEFORE GOXXX, ASSUME GORGT(IGO=2),
C...  RE-POSITION PROTAP AND RETURN TO NORMAL FLOW.
C...  (MAJOR 8000 = MOTION COMMANDS ....(1)GOLFT, (2)GORGT, (3)GOFWD,
C...  (4)GOBACK, (5)GOUP, (6)GODWN)
      INOSAV = NREC + 1
 5001 CALL ATAPRD(PROTAP,IER,NWDS,4,NRC1,1,INSTR1,1,INSTR2,1,PROBUF,0)
      IF(INSTR1.EQ.14000) GO TO 5010
      IF(INSTR1.NE.8000) GO TO 5001
      IGO = INSTR2
      GO TO 5020
 5010 IGO = 2
C...                                                          ** -10 **
      CALL AERR(-10)
C...
C...  POSITION PROTAP TO (NREC + 1) BEFORE RETURNING TO NORMAL FLOW.
 5020 CALL ASERCH(PROTAP,INOSAV,IER)
      GO TO 1000
C...
C...
 5030 DO 5031 IKK=1,9
 5031 CANSTO(IKK) = PSSAV(IKK)
      IUNFL(IIPS) = IUNFLS
      IPL(IIPS) = IPLS
      ISFTYP(IIPS) = ISFTPS
      ITLON(IIPS) = ITLONS
      J24(IIPS) = J24S
      IPSFL = 0
      TH(IPS) = ATHSAV
      GO TO 9998
C...
C...  ILLEGAL PROTAP DATASET RECORD FOR STARTUP        *** 603 ***
 9000 CALL AERR(603)
      STOP
      END

