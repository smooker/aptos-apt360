      SUBROUTINE APTPUT
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
      IMPLICIT REAL*8(A-H,O-Z)
      REAL*8 INWORD,NEWONE,NAME,IDIS,MACNAM,KRFSYS
       INTEGER DEBUG,SUM,PUNTAP
       INTEGER*2 KNDX(2)
      COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1
     1 ,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
      EQUIVALENCE(POCTAP,PTPTAP)
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
      COMMON/AMXTAB/MAXTAB,MAXVS1,MAXVS2,MAXPTP,MAXSCL,MAXVS,
     1MAXVST,MXPTPP,MXCAN,MXSRCN,MAXSLR,MAXELM,MAXPOT
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
      COMMON/AKLAS7/PPSEQ1,PPSEQ2,IDIS,IISN,IDVST,KFK
      COMMON/AVST/VST(7200)
       DIMENSION PTPP(7200),IPTPP(14400),IVST(14400)
       DIMENSION IPT(600)
       EQUIVALENCE (NDX,KNDX(1))
       EQUIVALENCE (VST(1),PTPP(1),IPTPP(1),IVST(1))
       EQUIVALENCE (PT(1),IPT(1))
      DATA FLAG/8HIOFLAG  /
C..                                                                  D39
C     NW CONTAINS TOTOAL NO. OF WPRDS IN PTPP CLASS (JMODE=3)
C     IT IS SET TO ZERO AFTER PROCESSING JMODE=3,4,OR 5
C     INPTP CONTAINS NO. OF ITEMS TO BE MOVED TO PTPP
C     NPT AND NPR CONTAIN INFORMATION FOR SECOND ENTRY IN PTPP CLASS
C     JMODE=1 - BEGINNING CLASS OF DATA
C          =2 - CONTINUATION OF CLASS
C          =3 - TERMINATION OF CLASS
C          =4 - ERASE PTPP CLASS
C          =5 - COMPLETE CLASS OF DATA
C          =6 - FLUSH PTPP BUFFER
C
      NOGO = 0
            IF(JMODE.EQ.6) GO TO 60
            IF(JMODE.NE.4) GO TO 10
C
C     RESET INDXPT
 5    INDXPT=INDXS
      GOTO 80
C
C     IS NO. OF ENTRIES = 0
   10       IF(INPTP.EQ.0) GO TO 50
C     SET BLOCK SIZE FOR NON-LOOP MODE
      MAX = MAXVST + 256
C     SET MAXIMUM PTPP SIZE
      IF(LOOP.NE.0) MAX = MXPTPP + MAXVST
C     WILL DATA FIT
 12   IF(INDXPT+INPTP.LE.MXPTPP+MAXVST) GO TO 20
C
C...  LOOP TOO LARGE - CAN PART OF IT BE OUTPUT
      IF(NOGO.NE.0) GO TO 19
C
C...  RESET POINTERS TO OUTPUT PORTION OF LOOP
      WRITE (IOUTAP,333)  IISN
      NOGO = INDXPT
 333  FORMAT(' *** PTPP SEGMENTATION OCCURED JUST PRIOR TO ISN   ',I6)
      INDXPT = INDXS
C...  GO WRITE IT OUT
      GO TO 65
C
 15   IN = MAXVST + 2
C...  ANY RISIDUAL PART OF CURRENT PTPP CLASS TO MOVE
      IF(INDXPT.EQ.NOGO) GO TO 18
C...  YES - MOVE TO START OF PTPP
      DO 17 I = INDXPT,NOGO
      PTPP(IN) = PTPP(I)
 17   IN = IN + 1
C...  RESET POINTER
 18   INDXPT = IN
C...  GO CHECK IF THERE IS ROOM FOR THIS PTPP CLASS BY ITSELF
      GO TO 12
C
C...  NOT ENOUGH ROOM FOR A SINGLE PTPP CLASS
 19   JSUBER = 12
      JSAV = 12
      GO TO 70
C
 20   IN=INDXPT
C...  WAS THERE SEGMENTATION THIS GO AROUND
      IF(NOGO.EQ.0) GO TO 25
C...  YES - - CHECK FOR A CLASS SEVEN PTPP RECORD
            IF(IPT(1).NE.7) GO TO 25
C
C...  CLASS SEVEN FOUND....WAS THERE AN ID INVOLVED
      IF(IDVST .EQ. 0) GO TO 25
C...  YES - - UPDATE THE VST POINTER FOR THE ID TO REFLECT NEW RECORD
       KNDX(2) = INDXPT - MAXVST
       KNDX(1) = IRECN + 1
       JTEMP1 = 2*IDVST - 1
       IVST(JTEMP1+2) = 3
       IVST(JTEMP1+3) = NDX
   25  DO 30  I = 1,INPTP
       PTPP(IN) = PT(I)
   30  IN = IN + 1
            IF(DEBUG.EQ.0) GO TO 35
       JTEMP1 = IN - 1
       DO 32  K = INDXPT,JTEMP1,4
       IPTPP1 = 2*K - 1
       IPTPP2 = IPTPP1 + 7
            IF(IPTPP2.GT.2*JTEMP1) IPTPP2 = 2*JTEMP1
       WRITE (IOUTAP,34) K,(IPTPP(J),J=IPTPP1,IPTPP2)
   34  FORMAT (6H PTPP(,I5,1H),4(Z9,Z10,7X))
   32  CONTINUE
   35  GO TO (40,50,50,5,45),JMODE
C
C...     NEW OR COMPLETE CLASS - SAVE INDXPT
   40  INDXS = INDXPT
       GO TO 50
C
 45   INDXS=IN
C     UPDATE INDXPT
C
 50   INDXPT=IN
C     IS THIS END OF CLASS
            IF(JMODE.LT.3) RETURN
            IF(JMODE.NE.3) GO TO 55
C
C     SET NO. OF WORDS IN PTPP CLASS
       JTEMP1 = 2*INDXS - 1
       IPTPP(JTEMP1+1) = NW
C     IF NPT IS NON-ZERO, SET SECOND ENTRY IN PTPP
            IF(NPT.EQ.0) GO TO 52
       IPTPP(JTEMP1+2) = NPT
       IPTPP(JTEMP1+3) = NPR
   52  NPT = 0
      INDXS=IN
C
C     YES - CHECK PTPP FOR OUTPUT
   55 IF(INDXPT.LE.MAX) GO TO 80
C     FLUSH PTPP - IF ANYTHING
   60       IF(INDXPT.EQ.2+MAXVST) RETURN
 65   IRECN = IRECN + 1
C     SET PTPP CLASS 0
      IPTPP1 = 0
      IPTPP2 = INDXPT-2-MAXVST
      CALL ATAPWT(PTPTAP,IOFLAG,4,IRECN,1,IPTPP1,1,IPTPP2,1,PTPP(MAXVST+
     12),IPTPP2)
C...                                                                 D39
C..   IOFLAG  .LT.0--O.K.,.GE.0--IO ERROR, OUTPUT ERROR MESSAGE      D39
      IF (IOFLAG.GE.0) GOTO 302
C     DO WE UPDATE MAXPTP
   66 IF(INDXPT.GE.MAXPTP+MAXVST) MAXPTP = INDXPT-MAXVST
C...  ARE WE IN THE PTPP SEGMENTATION MODE
      IF(NOGO.NE.0) GO TO 15
C     RESET INDXPT
   70 INDXPT = MAXVST+2
      INDXS = INDXPT
   80  NW = 0
      RETURN
C..
C..   I/O ERROR WHILE WRITING A PTPP RECORD
C..      OUTPUT THE VALUE OF IOFLAG AS THE SUBS. VAL OF V.S. IOFLAG  D39
C..   I.E.   CARD NO. XXX ISN XXX ERROR NO. XX  IOFLAG ( VAL )
  302 JSUBER = 302
      NAME = FLAG
      PT(7) = IOFLAG
      SUM = 9
      CALL ADIAGP
C...  CONTINUE PROCESSING
      JSUBER = 0
      GOTO 66
      END

