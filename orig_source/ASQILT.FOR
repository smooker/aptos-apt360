      SUBROUTINE ASQILT(NMOVD)
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
      IMPLICIT REAL*8(A-H,O-Z)
       REAL*8 NAME,KRFSYS
       INTEGER DEBUG,SUM
       LOGICAL*1 LCLAS1(2400)
       INTEGER LCLAS2*2(1200),LMENT4*4(1200)
       INTEGER*2 NAT1,NAT2,LPREN2
       LOGICAL*1 NATT(4),LPREN1(4)
C...  THIS PROGRAM REMOVES EXPRESSIONS FROM THE LMENT TABLE AND SQEEZES
C...  THE REMAINING TABLE
      COMMON/AVST/VST(2750),PTPP(2225),CANON(2225)
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
      COMMON/AILMTB/ELMENT(600),ICLASS(600),JLMENT
       EQUIVALENCE (ICLASS(1),LCLAS2(1),LCLAS1(1)),
     1 (ELMENT(1),LMENT4(1))
      COMMON/APRTAB/ISTARP,IENDP,NMOVE,NL,ITSQ,LINDX
      COMMON/ADATA1/ANODEF,BLANX,BLANKS,SYN,TLAXIS,DUMMY,PLENT,LOOPST
     1 ,LOOPND,MACRO,NTRMAC,NCALL,LAPTH,JAPTH,IPLUS,NCOMMA,IFF,IC(10),
     2 LLASS
       EQUIVALENCE ( LAPTH,LPREN1(1)),(LPREN1(3),LPREN2)
       EQUIVALENCE (NAT,NATT(1),NAT1),(NATT(3),NAT2)
C
C...     GET INDEX TO FIRST WORD FOLLOWING NEST TO BE REMOVED
       NFM = IENDP + 1
C...     GET INDEX TO FIRST WORD FOLLOWING CODE WHICH REPLACES NEST
       NFIN = ISTARP + 1
C
       JLMEN2 = JLMENT*2 - 1
       ICL2 = ISTARP*2 - 1
       ICL1 = ISTARP*4 - 3
       NAT = 0
C
C...     BRANCH ON NEST TYPE
      GOTO(100,200,300),ITSQ
C
C...     COMPUTING EXPRESSION - DETERMINE WHETHER OR NOT IT IS
C...     USED AS A SUBSCRIPT
  100  NATT(2) = LCLAS1(ICL1-1)
            IF(NAT1.EQ.1) GO TO 105
C
C...     NOT SUBSCRIPT - PUT CODE IN ICLASS FOR SCALAR IN WORK STORAGE
       ICLASS(ISTARP) = 5
       GO TO 215
C
C...     SUBSCRIPT - TEST FOR EXPRESSION
  105       IF(IENDP.GT.ISTARP+2) GO TO 110
C...     NO - IS IT A VARIABLE
       NATT(2) = LCLAS1(ICL1+7)
            IF(NAT1.EQ.1) GO TO 250
C...     NO - IS IT A SCALAR IN WORKING STORAGE
            IF(NAT1.EQ.5) GO TO 270
C...     NO - NUMBER
       GO TO 260
C
C...     SUBSCRIPT IS AN EXPRESSION
  110  ICLASS(ISTARP) = 9
       GO TO 218
C
C...     ARGUMENT LIST - DETERMINE WHETHER OR NOT IT IS
C...     USED AS A SUBSCRIPT
  200  NATT(2) = LCLAS1(ICL1-1)
            IF(NAT1.NE.1) GO TO 205
C
C...     SUBSCRIPT - PUT CODE IN ICLASS FOR ARGUMENT LIST TYPE
       ICLASS(ISTARP) = 10
       GO TO 218
C
C...     NOT SUBSCRIPT - PUT CODE IN ICLASS FOR ARGUMENT LIST NEST
  205  ICLASS(ISTARP) = 11
C
C...     GET INDEX TO FIRST WORD FOLLOWING CODE(S) WHICH REPLACE NEST
C...  THE FOLLOWING CODE HANDLES THE IMPLICIT COMMA - IF A COMMA IS
C...  REQUIRED IT IS ENTERED IN THE ELMENT TABLE. LEADING COMMA IS
C...  PUT IN UNLESS PREVIOUS ENTRY IS VOCAB. WORD 'IF' OR PUNCTUATION
C.... OTHER THAN A RIGHT PARENTHESIS
C...  TRAILING COMMA PUT IN IF NEXT ENTRY IS A LEFT PARENTHESIS
C...     IF SUBSCRIPT BEING REMOVED, SKIP TESTS FOR LEADING COMMA
  215  NATT(2) = LCLAS1(ICL1-1)
       NATT(4) = LCLAS1(ICL1-2)
C..IF PREVIOUS CODE IS VOC. WORD 'IF' OR AN ARITH. FUNCTION NO COMMAS
            IF(NAT1.NE.2) GO TO 216
      IF(NAT2.EQ.19) GO TO 218
            IF(NAT2.EQ.9) GO TO 220
C...     IF PREVIOUS CODE IS ANY PUNCTUATION EXCEPT A RIGHT PAREN-
C...     THESIS, NO LEADING COMMA NEEDED FOR ENTRY REPLACING NEST
  216       IF(NAT1.NE.4) GO TO 217
            IF(NAT2.NE.7) GO TO 218
C...     MOVE FIRST 2 WORDS OF NEST (WHICH NOW CONTAIN CODE(S) RE-
C...     PLACING NEST) UP 1 WORD, AND INSERT A COMMA
  217  ELMENT(ISTARP+2) = ELMENT(ISTARP+1)
      ELMENT(ISTARP+1) = ELMENT(ISTARP)
      ICLASS(ISTARP+2) = ICLASS(ISTARP+1)
      ICLASS(ISTARP+1) = ICLASS(ISTARP)
      ICLASS(ISTARP) = NCOMMA
       NFIN = NFIN + 1
C
C...     IF FIRST WORD FOLLOWING NEST IS BEYOND END OF
C...     STATEMENT, NO DATA TO BE MOVED
  218       IF(NFM.GT.JLMENT) GO TO 225
C...     IF ANOTHER NEST STARTS IMMEDIATELY FOLLOWING ONE BEING
C...     REMOVED, MUST INSERT A COMMA PRECEDING IT
       NFM1 = 4*NFM - 3
       NATT(2) = LCLAS1(NFM1+3)
            IF(NAT1.NE.4) GO TO 219
       NATT(4) = LCLAS1(NFM1+2)
            IF(NAT2.NE.6) GO TO 220
  219  ICLASS(IENDP) = NCOMMA
       NFM = NFM - 1
C
C...     MOVE PORTION OF STATEMENT FOLLOWING NEST DOWN TO
C...     SQUEEZE OUT NEST
  220  DO 222  I = NFM,JLMENT
      ELMENT(NFIN)=ELMENT(I)
      ICLASS(NFIN)=ICLASS(I)
  222  NFIN = NFIN + 1
C
C...     COMPUTE DECREASE IN LENGTH OF STATEMENT
  225  NMOVE = JLMENT - NFIN + 1
      NMOVD = NMOVE
C...     ADJUST POINTER TO END OF STATEMENT
       JLMENT = NFIN - 1
C...     ADJUST POINTERS FOR NEW LOCATIONS OF PARENTHESES
       DO 240  I = 1,JLMEN2,2
C...     TEST FOR LEFT PARENTHESIS
            IF(LCLAS2(I+1).NE.LPREN2) GO TO 240
C...     YES - IS ITS RIGHT PAREN BEYOND NEST JUST REMOVED
            IF(LMENT4(I).LT.NFM) GO TO 240
C...     YES - REDUCE POINTER TO RIGHT PAREN BY NMOVE
       LMENT4(I) = LMENT4(I) - NMOVE
 240  CONTINUE
      IENDP=IENDP-NMOVE
      RETURN
C
C...  SUBSCRIPT IS A VARIABLE
C...     SET VARIABLE AS SUBSCRIPT CODE FOR ICLASS
  250  ICLASS(ISTARP) = 7
      NAME = ELMENT(ISTARP+1)
      CALL AVS1CK(J)
C
C...     PUT POINTER TO VST LOCATION OF VARIABLE IN WORD TO BE
C...     STORED IN ELMENT
  255  LMENT4(ICL2) = 0
       LMENT4(ICL2+1) = NAMSUB
       GO TO 218
C
C...  SUBSCRIPT IS A NUMBER
C...     SET NUMERIC SUBSCRIPT CODE FOR ICLASS
  260  ICLASS(ISTARP) = 8
       GO TO 280
C
C...     SUBSCRIPT IS A SCALAR IN WORKING STORAGE
C...     SET EXPRESSION SUBSCRIPT CODE FOR ICLASS
  270  ICLASS(ISTARP) = 9
C
C...     PUT DATA FOR SUBSCRIPT IN WORD TO BE STORED IN ELMENT
  280  ELMENT(ISTARP) = ELMENT(ISTARP+1)
       GO TO 218
C
C...     NESTED GEOMETRIC DEFINITION OR SCALAR ASSIGNMENT
  300  NATT(2) = LCLAS1(ICL1+6)
            IF(NAT1.NE.24) GO TO 320
C...     UNNAMED NESTED SURFACE DEFINITION
       ICLASS(ISTARP) = 6
      GOTO 215
C
C...     NAMED SURFACE OR SCALAR DEFINITION
 320  ELMENT(ISTARP)=ELMENT(ISTARP+1)
       ICLASS(ISTARP) = 0
       LCLAS1(ICL1+3) = LCLAS1(ICL1+7)
C...     TEST FOR SUBSCRIPT
       NATT(2) = LCLAS1(ICL1+11)
            IF(NAT1.EQ.7) GO TO 330
            IF(NAT1.EQ.8) GO TO 330
            IF(NAT1.NE.9) GO TO 215
C...     SUBSCRIPTED SURFACE OR SCALAR
 330  ELMENT(ISTARP+1)=ELMENT(ISTARP+2)
      ICLASS(ISTARP+1)=ICLASS(ISTARP+2)
C...     GET INDEX TO FIRST WORD FOLLOWING CODES WHICH REPLACE NEST
       NFIN = ISTARP + 2
      GOTO 215
C
      END

