      SUBROUTINE ARITAP
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4,MODIFICATION 4 ***
C**** THIS ROUTINE WRITES A RECORD ON THE PROTAP. THE PROTP TABLE
C     CONTAINS THE DATA TO BE WRITTEN.
C     PROTP(1) CONTAINS NUMBER OF PARAMETERS TO BE WRITTEN.
C**** IRECN CONTAINS RECORD NO.
      IMPLICIT REAL*8(A-H,O-Z)
       COMMON/A1COM/REFSYS,NAME,NAME1,JSUBER,JSV,NAMSUB,KDBUG,INDXPT,
     1 LOOP,IFINI
       REAL*8 PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,TAPES2,
     1 TAPES3,TAPES4,PPNAME
      EQUIVALENCE(TAPES4,ERRTAP)
       INTEGER PUNTAP
       COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,
     1 TAPES1,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
       COMMON/ASISTM/IPTNLY,ITRCUT,IWAVEN,KFLAG1,LTVMIT,NCLREC,NOPOST,
     1 NOPLOT,NUMPST,NUMPTR,ICLPRT,INDEXX,IPLOTR,KFLAGS(9)
      COMMON/A1PAS2/I,J,K,L,MOVLGE,KANMAX,ICANST,IOVREC,KANPTR,MDFTAB,
     1KANCNT,KAUX,KDFCNT,IDEFP,KPRCNT,MDFPRE,IPREP,KOVFLP,KSRFCT,KOVCNT,
     2LSCAN,IOVFLO,MAXCAN,IREF,ICANSC,NAMSTA,KANGO,LASPTP,ISUB,
     3LCOMP,LGEREC,IRECN,JREC,JNUM,KANCUR,KANCOT,KDFENT,KANPAR,LGELOC,
     4IDTMOV,ISPPRG,INDEXS,KPTP,KPTPCT,KLASTP,KLASCT,KPRNT
       COMMON/APROTP/PROTP(102),PROSAV(102),NOWCLT,LSTPSV,INCORE
     1 ,JGORIT,SAVMOT
       DIMENSION JPROTP(200),JPROSV(200)
       EQUIVALENCE (PROTP(1),JPROTP(1)),(PROSAV(1),JPROSV(1))
      DATA I379/0/
C
C...     SEE IF RECORD IS TO BE WRITTEN ON PROTAP NOW
            IF(JGORIT)  2, 2, 4
C
C...     YES - OUTPUT IT
    2  CALL ATAPWT(PROTAP,IRET,4,IRECN,1,JPROTP(3),1,JPROTP(4),1,
     1 PROTP(3),JPROTP(2)-1)
C...     UPDATE PROTAP RECORD NUMBER
       IRECN = IRECN + 1
C...     WAS THERE AN I/O ERROR
            IF(IRET.GE.0) GO TO 150
            IF(JGORIT)  60, 200, 200
C
C...     NO - STORING RECORDS UNTIL IMPLICIT CHECK SURFACE
C...     FOUND - INCREMENT COUNT OF RECORDS SAVED
    4  NOWCLT = NOWCLT + 1
C
C...     TEST FOR STORING RECORDS IN CORE
   6  IF(INCORE .NE. 0) GO TO 30
C
C...     YES - TEST FOR ENOUGH SPACE FOR THIS RECORD
       N = JPROTP(2) + 2
      IF(LSTPSV + N .GT. 100) GO TO 25
C
C...     YES - STORE IT AWAY
       JPROTP(1) = N
      DO 20 I = 1,N
       LSTPSV = LSTPSV + 1
   20  PROSAV(LSTPSV) = PROTP(I)
       GO TO 200
C
C...  NO MORE ROOM TO STORE RECORDS IN CORE - USE ERRTAP
   25 INCORE = 1
      INHERE = 1
            IF(IWAVEN.NE.0) GO TO 200
       CALL ATAPOP(ERRTAP,1,IRET)
            IF(IRET.GE.0) GO TO 150
      K = NOWCLT - 1
C...     WRITE OUT RECORDS SAVED IN CORE ONTO ERRTAP
      DO 27 I = 1,K
       INHER2 = 2*INHERE - 1
       N = JPROSV(INHER2)
       CALL ATAPWT(ERRTAP,IRET,4,I,1,JPROSV(INHER2+2),1,
     1 JPROSV(INHER2+3),1,PROSAV(INHERE+2),JPROSV(INHER2+1)-1)
            IF(IRET.GE.0) GO TO 150
   27 INHERE = INHERE + N
C...     NOW GO TO SAVE LATEST RECORD
C
C...     WRITE LATEST RECORD TO BE SAVED ON ERRTAP
   30       IF(IWAVEN.NE.0) GO TO 200
       CALL ATAPWT(ERRTAP,IRET,4,NOWCLT,1,JPROTP(3),1,JPROTP(4),1,
     1 PROTP(3),JPROTP(2)-1)
C     WAS THERE AN ERROR
   40       IF(IRET.GE.0) GO TO 150
       GO TO 200
C
C...     NO - RETRIEVE SAVED PROTAP RECORDS, WRITE THEM OUT
C
C...     ARE THEY ON THE ERROR FILE
   60       IF(INCORE.NE.0) GO TO 80
C
C...     NO - WRITE THEM OUT FROM CORE AREA
       INHERE = 1
       DO 70  I = 1,NOWCLT
       INHER2 = 2*INHERE - 1
       N = JPROSV(INHER2)
       CALL ATAPWT(PROTAP,IRET,4,IRECN,1,JPROSV(INHER2+2),1,
     1 JPROSV(INHER2+3),1,PROSAV(INHERE+2),JPROSV(INHER2+1)-1)
       IRECN = IRECN + 1
            IF(IRET.GE.0) GO TO 150
   70  INHERE = INHERE + N
       LSTPSV = 0
       GO TO 200
C
C...     SAVED PROTAP RECORDS SUPPOSED TO BE ON ERROR FILE
C...     HAVE THERE BEEN ANY ERRORS
   80       IF(IWAVEN.NE.0) GO TO 200
C
C...     NO - REWIND FILE, RETRIEVE RECORDS, WRITE ON PROTAP
       CALL ATAPOP(ERRTAP,1,IRET)
            IF(IRET.GE.0) GO TO 150
C
       DO 100  I = 1,NOWCLT
       CALL ATAPRD(ERRTAP,IRET,NWDS,4,IJ,1,IK,1,IL,1,PROTP,0)
            IF(IRET.GE.0) GO TO 150
       CALL ATAPWT(PROTAP,IRET,4,IRECN,1,IK,1,IL,1,PROTP,NWDS)
       IRECN = IRECN + 1
            IF(IRET.GE.0) GO TO 150
  100  CONTINUE
       GO TO 200
C
  150  JSUBER = 302
  200 IF(I379.NE.0) RETURN
      IF(IRECN.LE.65365) RETURN
      JSUBER=379
      I379=1
      RETURN
       END

