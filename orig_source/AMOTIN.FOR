      SUBROUTINE AMOTIN
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4,MODIFICATION 4 ***
C
      IMPLICIT REAL*8(A-H,O-Z)
       INTEGER ISLASH/Z00000304/
       INTEGER MINMOD(10)/69,1,70,2,71,3,27,4,146,8/
       REAL*8 NAME,KRFSYS
       INTEGER DEBUG,SUM
       COMMON/APRTAB/ISTARP,IENDP,NMOVE,NL,ITSQ,LINDX
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
      COMMON/AVST/VST(2750),PTPP(2225),CANON(2225)
       COMMON/AILMTB/ELMENT(600),ICLASS(600),JLMENT
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
      COMMON/AMOTCM/PINT(30),IFURST,JPTIND,NOW,JSUB,KRESLT,KRSLT2,NWDS
     1 ,ITS,NEXT,MULTAX
      COMMON/ADATA1/ANODEF,BLANX,BLANKS,SYN,TLAXIS,DUMMY,PLENT,LOOPST
     1 ,LOOPND,MACRO,NTRMAC,NCALL,LAPTH,JAPTH,IPLUS,NCOMMA,IFF,IC(10),
     2 LLASS
       DIMENSION IPT(600),IVST(5500)
       EQUIVALENCE (PT(1),IPT(1)),(VST(1),IVST(1))
C
C...     JTEMP3 IS A NUMBER COUNTER
   10 JTEMP3=0
C...     INITIALIZE FLAG TO CHECK NUMBER OF SCALARS IN STATEMENT
       IPAT = 1
       JTOOL = 0
       IPT(1) = 6
       INPTP = 4
       NPT = 0
      JMODE=5
C
C...     PICK UP A PTPP ENTRY AND EVALUATE
   20  CALL APTLOD
C...     RESET PTPP STORING INDEX TO START
       INPTP = 4
C...     0=MINOR MODIFIER, 1=VOCABULARY,
C...     2=NUMBER, 3=SCALAR VARIABLE, 4=SURFACE, 5=STATEMENT I.D.
C...     6=UNDEFINED(MAY BE I.D.), 7=SUBSCRIPTED VARIABLE, 8=ERROR
            IF(JPTIND.EQ.1) GO TO 70
            IF(JPTIND-8)  110, 5000, 110
C...     CONVERT VOCABULARY CODE FOR BRANCHING
   70 JTEMP1=KRESLT/1000
       MAJOR = KRESLT
       ISUBST = KRSLT2
       IPT(5) = KRESLT
       IPT(6) = ISUBST
C...     TEST BRANCH SWITCH RANGE
            IF(JTEMP1.LE.0) GO TO 110
            IF(JTEMP1.GE.9) GO TO 110
C...     TEST FOR TOOL POSITION INDICATOR
            IF(JTEMP1.EQ.4) GO TO 260
C...     NO - TEST FOR FURTHER DATA - ERROR IF NONE
            IF(ISTARP+1.GT.JLMENT) GO TO 3000
C...     TEST FOR SLASH FOLLOWING MAJOR WORD
            IF(ICLASS(ISTARP).NE.ISLASH) GO TO 4040
C...     YES - MOVE SCANNING INDEX PAST IT
       ISTARP = ISTARP + 1
C
C...     BRANCH ON PROTAP THOUSAND CODE (4 THROUGH 9, 1-3 ILLEGAL HERE)
  100  GO TO (110,110,1600,260,330,110,1650,1645),JTEMP1
  110 JSUBER=133
  120 GO TO  5000
C
C...     4000 CODE FOUND
C
C...     PUT 4000 CODE INTO PROTAP RECORD BLOCK
  260       IF(JTOOL.EQ.1) GO TO 4000
       IPT(2) = 2
       PT(2) = 0.0D0
       INPTP = 3
       CALL APTPUT
       JTOOL = 1
       ITSQ = 4
            IF(ISTARP-JLMENT)  20, 20, 5000
C...
C...     5000 CODE FOUND
C...
  330  ITSQ = 0
  340  NUMCOM = 1
  345       IF(ISTARP.GT.JLMENT) GO TO 560
C
C...     PICK UP NEXT PARAMETER
       CALL APTLOD
C...     TEST FOR PUNCTUATION
            IF(JPTIND.NE.9) GO TO 390
C...     YES - ONLY COMMA ACCEPTABLE
            IF(KRSLT2-9)  4000, 755, 4000
C
C...     IF OUTPUTTING PATTERN, SKIP INSERTION AND SURFACE TYPE TESTS
  390       IF(IPAT.EQ.0) GO TO 555
C...     CHECK FOR INSERTING IDUMMY OR ZERO
            IF(JPTIND.EQ.4) GO TO 490
C...     IF MODIFIER WORD FOUND, ASSUMED TO BE OUTPUTTING PATTERN
            IF(JPTIND.EQ.0) GO TO 515
      IF(JTEMP3.EQ.0) GOTO 410
      IF(JTEMP3.NE.3) GOTO 405
            IF(ISUBST.LT.3) GO TO 410
            IF(ISUBST.GT.5) GO TO 410
      GO TO 490
  405       IF(JTEMP3.NE.6) GO TO 490
C...     MUST MOVE PARAMETER UP AND INSERT ZEROS IN LOCATIONS FOR
C...     SURFACE NAME AND SUBSCRIPT PRECEDING IT...
  410  DO 430  J = NOW,INPTP
  430  PT(J+4) = PT(J)
       JTEMP1 = 2*NOW - 1
       IPT(JTEMP1) = 1
       IPT(JTEMP1+1) = 0
       PT(NOW+1) = 0.0D0
       PT(NOW+2) = PT(NOW)
       PT(NOW+3) = 0.0D0
      INPTP=INPTP+4
       NOW = NOW + 4
      NPT=NPT+2
  490 CONTINUE
C
C...     ONLY A NUMBER OR A SURFACE IS ALLOWED(JPTIND=2,3,4)
       GO TO (4020,500,500,520,4000,4000,4000,5000),JPTIND
C
  500 JTEMP3=JTEMP3+1
       GO TO 555
C
C...     VOCAB. FOUND IN GOTO/ - SET FLAG TO BLOCK CHECK ON
C...     NUMBER OF SCALARS IN STATEMENT - PATTERN OUTPUT MAY INCLUDE
C...     INDEFINITE NUMBER OF POINT NUMBER REFERENCES
  515  IPAT = 0
       GO TO 555
C
  520 JTEMP3=JTEMP3+3
      IT=11
C...     CHECK IF POINT OR VECTOR
            IF(ISUBST/2*2.EQ.ISUBST) GO TO 550
            IF(ISUBST.EQ.1) GO TO 540
      IF(JTEMP3.GE.6) GO TO 550
  540  IT = 1
C...     PACK A DATA TYPE CODE INTO PTPP ENTRY
  550  CALL ASWICH(IT)
  555  NPT = NPT + 1
C...     IF PREVIOUS ELEMENT PICKED UP WAS NOT COMMA, ERROR
            IF(NUMCOM.NE.1) GO TO 4030
C...     IT WAS COMMA - CLEAR FLAG FOR IT
       NUMCOM = 0
C...     BACK FOR NEXT PARAMETER
       GO TO 345
C
C...     CHECK NUMBER OF SCALARS IN STATEMENT IF NO VOCABULARY
C...     WORDS WERE FOUND, INDICATING PATTERN OUTPUT
  560       IF(IPAT.EQ.0) GO TO 4990
            IF(JTEMP3.LE.0) GO TO 3000
            IF(JTEMP3.GT.10) GO TO 3000
            IF(ISUBST.LT.3) GO TO 570
            IF(ISUBST.GT.5) GO TO 570
      IF(JTEMP3.GT.7) GOTO 3000
  570  CONTINUE
       GO TO (650,680,750,600,3000,750,600,3000,750,600),JTEMP3
C
C...     FEED RATE INDICATED
C...     SAVE 5000 PT RECORD
  600  DO 610  K = 1,30
  610 PINT(K)=PT(K)
C
C...     STORE 2000 CODE
       IPT(3) = 1
       IPT(4) = 1
       IPT(5) = 2000
       IPT(6) = 1009
       JTEMP1 = NOW
       JTEMP2 = INPTP - NOW
       DO 615  K = 1,JTEMP2
       PT(K+3) = PT(JTEMP1)
  615  JTEMP1 = JTEMP1 + 1
       IPT(2) = JTEMP2 + 2
       INPTP = JTEMP2 + 3
      CALL APTPUT
C...  BRING BACK 5000 RECORD
       INPTP = NOW
      DO 620 K=1,30
  620 PT(K)=PINT(K)
C
C...     CHECK FOR GODLTA/I,FDR
            IF(ISUBST.NE.4) GO TO 720
            IF(JTEMP3.NE.2) GO TO 720
C... ONE SCALAR PARAMETER GIVEN...MUST BE GODLTA
  650 IF(ISUBST.NE.4) GO TO 3000
C...     SPECIAL GODLTA/I - CONSTRUCT RECORD FOR IT
      NPT = 3
       PT(5) = TLAXIS
       GO TO 4980
C
C...     TWO SCALAR PARAMETERS GIVEN...
C...     TEST FOR GODLTA/I,FDR
  680       IF(ISUBST.EQ.4) GO TO 600
C...     NO - TEST FOR FROM AND GOTO
            IF(ISUBST.EQ.3) GO TO 750
            IF(ISUBST-5)  3000, 750, 3000
C
C...     STATEMENT ENDED IN FEED RATE, THOUGH NOT GODLTA/I,FDR...
C...     DECREMENT SCALAR AND PARAMETER COUNTERS TO DROP FEED RATE
  720  NPT = NPT - 1
       JTEMP3 = JTEMP3 - 1
C
C...     FILL UP WITH ZEROS IF NEEDED, INDIRP, INDIRV, SRFVCT
  750       IF(ISUBST.LE.2) GO TO 760
            IF(ISUBST.EQ.8) GO TO 760
       GO TO 4980
C
C...     TEST FOR FOLLOWING ANOTHER COMMA
  755       IF(NUMCOM.GT.0) GO TO 758
C...     FIRST ONE - ONLY COUNT IT, UNLESS IT IS RIGHT AFTER SLASH
            IF(JTEMP3.EQ.0) GO TO 758
       NUMCOM = 1
       GO TO 345
C
C...     SECOND (OR LATER) COMMA - CHECK FOR INDIRV, INDIRP, SRFVCT
  758       IF(ISUBST.LE.2) GO TO 760
            IF(ISUBST.NE.8) GO TO 3000
C
  760 IF(JTEMP3.GT.9) JSUBER=129
            IF(JTEMP3.GE.9) GO TO 4980
       JTEMP1 = 2*INPTP - 1
       IPT(JTEMP1) = 1
       IPT(JTEMP1+1) = 0
      PT(INPTP+1)=DUMMY
      PT(INPTP+2)=PT(INPTP)
      PT(INPTP+3) = 0.0D0
      INPTP=INPTP+4
      DO 765 I=1,6,2
       PT(INPTP) = PT(INPTP-2)
       PT(INPTP+1) = 0.0D0
  765  INPTP = INPTP + 2
       NPT = NPT + 5
       JTEMP3 = JTEMP3 + 3
            IF(JPTIND.EQ.9) GO TO 345
       GO TO 760
C
C...     PSIS STATEMENT...
C...     VERIFY SUBTYPE
 1600       IF(KRSLT2.NE.4) GO TO 4000
C...     SET USAGE FLAGS
       MINOR = 0
       IUSE = 4
C...     GET PARAMETER
       INPTP = 6
       CALL APTLOD
C...     MAKE SURE IT IS A SURFACE
            IF(JPTIND.EQ.4) GO TO 1780
C...     IT IS NOT - ERROR
            IF(JPTIND.EQ.8) GO TO 5000
       JSUBER = 576
       GO TO 5000
C
C...     7000 OR 8000 CODE FOUND
C...
 1645 MINOR = 0
      GO TO 1655
 1650  MINOR = 1
 1655  ITSQ = 4
       IPT(1) = 18
       IPT(2) = 1
       PT(2) = PT(3)
       INPTP = 2
       CALL APTPUT
       IPT(1) = 6
       INPTP = 6
       CALL APTLOD
      IF(JPTIND.EQ.4) GOTO 1680
            IF(JPTIND.NE.0) GO TO 4000
C
C...     MINOR MODIFIER
 1660       IF(MAJOR.EQ.7000) GO TO 1670
      JSUBER=135
      GOTO 9999
C
 1670  DO 1672  K = 1,9,2
            IF(KRESLT.EQ.MINMOD(K)) GO TO 1675
 1672  CONTINUE
       GO TO 4000
 1675  MINOR = MINMOD(K+1)
       INPTP = 6
       CALL APTLOD
            IF(JPTIND.NE.4) GO TO 4000
C...     FIRST SURFACE
 1680 NUMSRF=1
C
C...     OUTPUT 3000 CODE NEW
 1700  IPT(7) = 1
       IPT(8) = 0
       IPT(9) = 0
       IPT(10) = MINOR
       CALL ASWICH(100)
       IPT(5) = 3000
       IPT(6) = 2
       IPT(3) = 2
       IPT(4) = 0
       IPT(2) = INPTP - 2
      INPTP=INPTP-1
      CALL APTPUT
C
C...     CHECK OFFSET/, GO/, GO.../
            IF(MAJOR.EQ.8000) GO TO 1800
C
      NTSURF = 3
            IF(ISUBST.EQ.1) GO TO 1740
C
C...     OFFSET
      NTSURF = 2
      GO TO 1740
C
C...     FEED RATE GIVEN
 1710  DO 1715  K = NOW,INPTP
 1715  PT(K-2) = PT(K)
       IPT(2) = INPTP - 4
       IPT(3) = 1
       IPT(4) = 0
       IPT(5) = 2000
       IPT(6) = 1009
       INPTP = INPTP - 3
      CALL APTPUT
C
C...     OUTPUT 7000 CODE
 1730  IPT(2) = 4
       IPT(3) = 1
       IPT(4) = 0
       IPT(5) = 7000
       IPT(6) = ISUBST
       IPT(7) = 1
       IPT(8) = 0
       IPT(9) = 0
       IPT(10) = NUMSRF
      INPTP=5
      GOTO 4999
C
C...     GO/STATEMENT
 1740       IF(ISTARP.GT.JLMENT) GO TO 1730
      MINOR=1
       INPTP = 6
       CALL APTLOD
      IF(JPTIND.EQ.0) GOTO 1760
      IF(JPTIND.EQ.4) GOTO 1770
      IF(JPTIND.EQ.2) GOTO 1750
            IF(JPTIND.NE.3) GO TO 4000
C
C...     FEED RATE GIVEN
 1750       IF(ISTARP.GT.JLMENT) GO TO 1710
      JSUBER=129
      GOTO 1710
C
C...     MINOR MODIFIER
 1760  DO 1762  K = 1,9,2
            IF(KRESLT.EQ.MINMOD(K)) GO TO 1765
 1762  CONTINUE
       GO TO 4000
 1765  MINOR = MINMOD(K+1)
       INPTP = 6
       CALL APTLOD
            IF(JPTIND.NE.4) GO TO 4000
C...     SURFACE
 1770 NUMSRF=NUMSRF+1
            IF(NUMSRF.LE.NTSURF) GO TO 1775
      JSUBER=129
      GOTO 1730
C
C...     OUTPUT 3000 CODE
 1775       IF(NUMSRF.EQ.2) IUSE = 1
            IF(NUMSRF.EQ.3) IUSE = 3
C...     CHECK SURFACE USE
C...     OUTPUT 3000 CODE
 1780  IPT(7) = 1
       IPT(8) = 0
       IPT(9) = 0
       IPT(10) = MINOR
       CALL ASWICH(100)
       IPT(5) = 3000
       IPT(6) = IUSE
       IPT(3) = 2
       IPT(4) = 0
       IPT(2) = INPTP - 2
      INPTP=INPTP-1
      CALL APTPUT
            IF(IUSE.NE.4) GO TO 1740
C...     PSIS - MAKE SURE THERE ARE NO MORE PARAMETERS
            IF(ISTARP-JLMENT)  4000, 4000, 5000
C
 1800       IF(ISTARP.GT.JLMENT) GO TO 2000
       IDCNT = 0
 1805  MINOR = 1
       INPTP = 6
       CALL APTLOD
            IF(JPTIND.EQ.4) GO TO 1900
      IF(JPTIND.EQ.2) GOTO 1830
            IF(JPTIND.EQ.3) GO TO 1830
            IF(JPTIND.NE.0) GO TO 4000
       DO 1812  K = 1,9,2
            IF(KRESLT.EQ.MINMOD(K)) GO TO 1815
 1812  CONTINUE
       GO TO 4000
 1815  MINOR = MINMOD(K+1)
       INPTP = 6
       CALL APTLOD
C
 1820       IF(JPTIND.EQ.4) GO TO 1900
            IF(JPTIND.EQ.2) GO TO 1830
            IF(JPTIND.NE.3) GO TO 4000
C
C...     NUMBER FOUND
 1830  DO 1835  K = NOW,INPTP
 1835  PT(K-2) = PT(K)
       IPT(2) = INPTP - 4
            IF(ISTARP.LT.JLMENT) GO TO 1860
       INPTP = INPTP - 3
C
C...     OUTPUT FEED RATE RECORD
 1840  IPT(3) = 1
       IPT(4) = 0
       IPT(5) = 2000
       IPT(6) = 1009
      CALL APTPUT
      IF(NUMSRF.GE.2) GOTO 2010
      GOTO 2000
C
C...     IS IT INTOF
 1860  CALL APTLOD
            IF(JPTIND.NE.0) GO TO 4000
            IF(KRESLT.NE.5) GO TO 4000
C
C...     OUTPUT 6000 RECORD FOR INTOF COUNT
       IPT(3) = 1
       IPT(4) = 0
       IPT(5) = 6000
       IPT(6) = 3
       INPTP = INPTP - 5
      CALL APTPUT
       INPTP = 6
       CALL APTLOD
            IF(JPTIND.NE.4) GO TO 4000
C
C...     SURFACE FOUND
 1900 NUMSRF=NUMSRF+1
C
C...     OUTPUT 3000 CODE
       IPT(7) = 1
       IPT(8) = 0
       IPT(9) = 0
       IPT(10) = MINOR
       CALL ASWICH(100)
       IPT(5) = 3000
       IPT(6) = 3
       IPT(3) = 2
       IPT(4) = 0
       IPT(2) = INPTP - 2
      INPTP=INPTP-1
      CALL APTPUT
            IF(ISTARP.LE.JLMENT) GO TO 1910
      IF(NUMSRF.LT.3) GOTO 2010
      JSUBER=129
      GOTO 2010
C
C...  STATEMENT ID OR FEEDRATE
 1910  INPTP = 4
       CALL APTLOD
            IF(JPTIND.EQ.2) GO TO 1915
            IF(JPTIND.EQ.3) GO TO 1913
       JTEMP1 = IPT(10)
       NAME = VST(JTEMP1)
      IF(JPTIND.EQ.5) GOTO 1920
      IF(JPTIND.EQ.6) GOTO 1920
C...     IF ERROR FLAG SET IN APTLOD, SIMPLY EXIT
            IF(JPTIND.EQ.8) GO TO 2010
       JSUBER = 132
      GOTO 2010
C
 1913       IF(ISTARP-JLMENT)  1920, 4000, 1914
 1914       IF(NUMSRF.LE.2) GO TO 1916
            IF(IDCNT-NUMSRF+1)  1920, 1916, 1916
C
C...     NUMBER
 1915       IF(ISTARP.LT.JLMENT) GO TO 1918
            IF(NUMSRF.EQ.3) GO TO 1918
 1916  IPT(2) = INPTP - 2
       INPTP = INPTP - 1
      GOTO 1840
C
C...     MAKE SURE AN EXPRESSION IS NOT BEING USED AS AN I.D.
 1918       IF(IPT(7).NE.3) GO TO 1919
       JSUBER = 453
       GO TO 5000
C
C...     CONVERT NUMBER TO I.D. SYMBOL
 1919  CALL AIFUN8(PT(5),NAME)
C
 1920 CALL AVS1CK(JVS)
       JTEMP1 = 2*NAMSUB - 1
       GO TO (1930,4000,1940,1950,4000,4000,4000,4000,4000),JVS
 1930 CALL AVS1PT(JVS)
      JTEMP1=2*NAMSUB-1
      IF(JVS.EQ.1) GOTO 1935
      JSUBER=15
      SUM = 1
      GOTO 9999
C
 1935  IVST(JTEMP1+2) = 8
       IVST(JTEMP1+3) = 0
 1940 CONTINUE
 1950 KLASS = 20
      IZW = 1
C...  SET TO FORWARD TRANSFER FOR PASS TWO IF SUCH IS THE CASE
            IF(IVST(JTEMP1+3).EQ.0) IZW = 0
C...     OUTPUT 6000 CODE TRANTO
 1960  IPT(7) = 7
       IPT(8) = 0
       IPT(9) = IZW
       IPT(10) = NAMSUB
       IPT(5) = 6000
       IPT(6) = 8
       IPT(3) = 1
       IPT(4) = 0
       IPT(2) = 5
      PT(6) = VST(NAMSUB)
      INPTP = 6
      CALL APTPUT
C...     COUNT STATEMENT ID
       IDCNT = IDCNT + 1
 1990       IF(ISTARP.LE.JLMENT) GO TO 1805
      IF(NUMSRF.LE.2) JSUBER=129
      GOTO 2010
C
C...     8000 RECORD
 2000  IPT(1) = 18
       IPT(2) = 0
      INPTP=1
      CALL APTPUT
       IPT(1) = 6
C...     SAVE 8000 RECORD
 2010  IPT(5) = MAJOR
       IPT(6) = ISUBST
       PT(2) = 0.0D0
       IPT(2) = 2
      INPTP=3
 2020 GOTO 4999
C
C...     ERROR MESSAGES
C
 3000 JSUBER=129
      GOTO 5000
C...     ILLEGAL FORMAT
C...     IF ERROR FLAG SET IN APTLOD, SIMPLY EXIT
 4000       IF(JPTIND.EQ.8) GO TO 5000
       JSUBER = 132
 4010 GO TO 5000
C...     IMPROPER VOCABULARY CODE
 4020 JSUBER=133
       GO TO 5000
C...     IMPROPER PUNCTUATION (NOT A COMMA) BETWEEN PARAMETERS
 4030  JSUBER = 7
       GO TO 5000
C...     MISSING SLASH
 4040  JSUBER = 155
       GO TO 5000
C
 4980  IPT(5) = MAJOR
       IPT(6) = ISUBST
 4990  IPT(3) = NPT
       IPT(4) = 0
       IPT(2) = INPTP - 2
 4995 INPTP=INPTP-1
 4999 JMODE=5
      CALL APTPUT
 5000 CONTINUE
 9999 RETURN
      END

