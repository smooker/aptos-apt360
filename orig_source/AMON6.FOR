      SUBROUTINE AMON6
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4,MODIFICATION 4 ***
      IMPLICIT REAL*8(A-H,O-Z)
       REAL*8 INWORD,NAME,MACNAM,KRFSYS
       INTEGER*2 KAT/0/,KEQAL(2)/0,Z0804/,KCOMMA(2)/0,Z0904/
       INTEGER*2 KSLASH(2)/0,Z0304/
       LOGICAL*1 LCLAS1(2400),GAT(2)
       INTEGER DEBUG,SUM
C     THIS PROGRAM PROCESSES THE FIRST STATEMENT OF A MACRO DEFINITION
C        MAC1 = MACRO/A=1,B=ON,C,D
C     THE MACRO VARIABLES AND STANDARD VALUES, IF ANY, ARE PUT IN CANON.
C     SUBSEQUENTLY, THE SQUEEZED MACRO WILL BE PUT IN CANON FOLLOWING
C     THE MACRO VARIABLE INFORMATION
C          COMMON  STORAGE
C               *          *          *          *          *
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
      COMMON/AMXTAB/MAXTAB,MAXVS1,MAXVS2,MAXPTP,MAXSCL,MAXVS,MAXVST,MXPT
     1PP,MXCAN,MXSRCN,MAXSLR,MAXELM,MAXPOT
      COMMON/AILMTB/ELMENT(600),ICLASS(600),JLMENT
      COMMON/AINPOT/INWORD(14),MORE,IFIRST
       EQUIVALENCE (JSLASH,KSLASH(1)),(ICLASS(1),LCLAS1(1))
       EQUIVALENCE (KAT,GAT(1)),(IEQUAL,KEQAL(1)),(JCOMMA,KCOMMA(1))
      COMMON/ASCALR/SCALR(180),ISCWS,NSURF,LOCTEM,IARGTP
      COMMON/AVST/VST(7200)
       DIMENSION PTPP(7200),CANON(7200),IVST(14400),ICANON(14400)
       EQUIVALENCE (VST(1),IVST(1),CANON(1),ICANON(1),PTPP(1))
      COMMON/ABREAK/NEXTNW,NRELCN,KANLCN,LOCSEQ,NEXTCN,NWONRD,LPLOCN,
     1 JSW4,ISN,K,MXLOOP,JSW2,JSAV,JSW1,MAXMV,MXNEST,INILL,KF
       COMMON/AMACRO/LIMCAN,LMDW,NITEMS,JWHAT,MACREC,MACVST,MACERR
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
      COMMON/AMCSTF/MACNAM(5),MACCUR,MACLCN(5),MACRD,MACSTR(5),NMACVR
     1 ,NUMIDS,IDLOCN,MACIDS(5),ISVID
      COMMON/ADATA1/ANODEF,BLANX,BLANKS,SYN,TLAXIS,DUMMY,PLENT,LOOPST
     1 ,LOOPND,MACRO,NTRMAC,NCALL,LAPTH,JAPTH,IPLUS,NCOMMA,IFF,IC(10),
     2 LLASS
      COMMON/ALIBRY/AMACVR(50),AMACVL(50),MACICL(50),DEFNAM,SEGNAM
     1 ,IVARCT,ISYSMC,IRDMOD,LUUP,NWUNRD,NOLIBR
C
      JSAV = 0
       MACERR = 0
       JMODE = 6
      INPTP = 0
C...  MOVE PT DATA TO PTPP TABLE AREA
      CALL APTPUT
C... BRANCH IF NOT IN MACRO OR LOOP MODE
      IF ( NWONRD.EQ.0 ) GOTO 1080
C... LOOP MODE IS ON- ILLEGAL TO DEFINE A MACRO AT THIS TIME
      JSUBER = 201
C... * * *
C... FOR THIS ERROR EXIT TURN OFF MACRO AND LOOP MODE FLAGS
      NWONRD = 0
      LOOP = 0
C... * * *
      GO TO 998
 1080       IF(ICLASS(K+1).EQ.IEQUAL) GO TO 1110
C...  MUST BE AN = SIGN AFTER MACRO NAME
 1100 JSUBER=203
      GO TO 998
C... IS MACRO NAME A VARIABLE SYMBOL
 1110       IF(ICLASS(K).EQ.1) GO TO 1130
C...  MACRO NAME MUST BE A VARIABLE SYMBOL
 1120 JSUBER=204
      GO TO 998
 1130 NAME=ELMENT(K)
C... MOVE MACRO NAME INTO VST TABLE
      CALL AVS1PT(J)
C... TEST  IF MACRO NAME WAS PLACED SUCCESSFULLY INTO VST
      IF (J.EQ.1) GOTO 1150
C...  MACRO NAME NOT UNIQUE
 1140 JSUBER=202
      SUM = 1
      GO TO 998
 1150 MACVST = NAMSUB
       JTEMP1 = 2*MACVST - 1
       IVST(JTEMP1+2) = 8
       IVST(JTEMP1+3) = 0
       DEFNAM = NAME
      IDLOCN = MAXVS1 + 2
      NUMIDS = 0
C...  CHECK FOR MACRO VARIABLES
      M = LIMCAN + 4
      IF(K+3.GE.JLMENT) GO TO 1210
C
      L = K+3
            IF(ICLASS(L).NE.JSLASH) GO TO 1100
      IF(L .EQ. JLMENT)  GO TO 1190
      ICOMMA = 1
C
      DO 1175 KL=L,JLMENT
            IF(ICLASS(KL).NE.JCOMMA) GO TO 1175
       ICOMMA = ICOMMA + 1
C
 1175 CONTINUE
      LMDW = 5*ICOMMA
      IF(LIMCAN + 3 + LMDW  .LT. MAXTAB) GO TO 1180
C...  NOT ENOUGH ROOM IN CANON TO STORE MACRO VARIABLES.
      JWHAT = 1
      CALL AMATMV
      M = LIMCAN + 4
C
C...  ROOM IN CANON FOR MACRO VARAIBLES
 1180 IF(L.LT.JLMENT)GO TO 1220
 1190 IF(MACRD.EQ.0)  GO TO 1210
C...  CANNOT NEST MACRO DEFINITIONS - ONLY THE CALLS
 1200 JSUBER=201
      SUM = 1
      GO TO 998
C
C...     SET FLAGS FOR DEFINING A MACRO
 1210  MACRD = -1
      LOOP = 1
      LMDW = M-LIMCAN-4
      CALL APRINT(6)
      GO TO 998
C
C...  PROCESS MACRO VARIABLES
 1220       IF(ICLASS(L+1).EQ.1) GO TO 1240
 1230 JSUBER=207
      GO TO 998
C...     PUT MACRO VARIABLE SYMBOL INTO MACRO HEADING
 1240 CANON(M)=ELMENT(L+ 1)
C...     IF SYMBOL IS LAST ENTRY IN STATEMENT, NO NORMAL VALUE
      IF(JLMENT.EQ.(L+1))  GO TO 1280
C...     NOT LAST ENTRY - NEXT MUST BE EITHER COMMA OR = SIGN
            IF(ICLASS(L+2).EQ.JCOMMA) GO TO 1280
C...     NOT COMMA - TRY = SIGN - IF NOT, ERROR
            IF(ICLASS(L+2).NE.IEQUAL) GO TO 1230
C...     = SIGN FOUND...
       JTEMP1 = 4*L - 3
C...     TEST ENTRY FOLLOWING = FOR PUNCTUATION
       GAT(2) = LCLAS1(JTEMP1+15)
            IF(KAT-4)  1260, 1250, 1230
C...     PUNCTUATION FOUND - ONLY SIGN OF FOLLOWING NUMBER
C...     ACCEPTABLE - TEST FOR NUMBER
 1250  GAT(2) = LCLAS1(JTEMP1+19)
            IF(KAT.NE.3) GO TO 1230
C...     NUMBER FOUND - TEST FOR SIGN - IF MINUS, NEGATE NUMBER
       GAT(2) = LCLAS1(JTEMP1+14)
            IF(KAT-2)  1255, 1252, 1275
 1252  ELMENT(L+4) = -ELMENT(L+4)
 1255  L = L + 1
C...     STORE NORMAL VALUE FOR MACRO VARIABLE
 1260 CANON(M+ 1)=ELMENT(L+ 3)
       JTEMP1 = 2*M - 1
       ICANON(JTEMP1+5) = ICLASS(L+3)
       L = L + 4
      GO TO 1290
C
C...     ILLEGAL PUNCTUATION IN MACRO VARIABLE NORMAL ASSIGNMENT
 1275  JSUBER = 214
       GO TO 998
C
C...     NO NORMAL VALUE GIVEN - ENTER NODEFX
 1280 CANON(M+1) = ANODEF
      L = L+2
 1290 M = M+5
            IF(M-LIMCAN-4.LE.5*MAXMV) GO TO 1180
C... MACRO CALL STATEMENT EXCEEDS LIMIT OF 50 VARIABLES
 1300 JSUBER=205
  998  RETURN
      END

