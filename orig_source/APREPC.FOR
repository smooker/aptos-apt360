      SUBROUTINE APREPC
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 2, MODIFICATION 0 ***
C
      IMPLICIT REAL*8(A-H,O-Z)
       INTEGER PUNTAP
       COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,
     1 TAPES1,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
       COMMON/A1COM/REFSYS,NAME,NAME1,JSUBER,JSV,NAMSUB,KDBUG,INDXPT,
     1 LOOP,IFINI
      COMMON/AVST/VST(7200)
      DIMENSION DEFTAB(1000)
      EQUIVALENCE(VST(7200),DEFTAB(1000))
      DIMENSION D(1000)
      EQUIVALENCE (DEFTAB(1),D(1))
C               *          *          *          *          *
      DIMENSION           FMT(106),TABLX(8),M(7),MM(7),FOR(12),
     1XL(139),TH(139),CA(139)
      DIMENSION S(4),T(4),U(4),CB(4),SQ(4),V(4)
         DIMENSION FILL (7)
      DIMENSION SMAT(12)
      INTEGER*4 AEXTRA
      DATA FOR/'(I4,F1  0.6,    4X,     1HX     1H*     1H+     1H0
     11H$     1H=     1H.     1H      1H.)    '  /
      COMMON/A2CLS7/PPSEQ1,PPSEQ2,ENAME,EINAME,IEREC,ISN
C***********************************************************************
C     DEFINE FUNCTIONS
      CRV(Q000FL)=50.0*(Q000FL-CENTER)/CURVRG+51.50001
      CRVA(Q001FL,Q002FL,Q003FL)=-(4.0*Q001FL+2.0*Q002FL)/(Q003FL*DSQRT(
     1(1.0+Q001FL**2)**3))
      SMAL(Q004FL)=DSIGN( DMAX1(DABS(Q004FL),1.D-9),Q004FL)
      TAN1(Q005FL,Q006FL)=(Q005FL-Q006FL)/(1.0+Q005FL*Q006FL)
      TAN2(Q007FL,Q008FL)=(Q007FL+Q008FL)/SMAL(1.0-Q007FL*Q008FL)
      DERV(Q009FL)=DSQRT((1.0+Q009FL*Q009FL)*(1.0+Q009FL*Q009FL)*(1.0+Q0
     109FL*Q009FL))
      CURV(Q010FL,Q011FL,Q012FL,Q013FL,Q014FL,Q015FL)=-(4.0*Q012FL+2.0*Q
     1013FL)/(Q015FL*                 DERV(Q012FL))-(2.0*Q010FL+4.0*Q011
     2FL)/(Q014FL*DERV(Q011FL))
      SLOPE(Q016FL,Q017FL,Q018FL,Q019FL,Q020FL,Q021FL)=(((Q018FL-Q016FL)
     1**2+(Q019FL-Q017FL)**2)                *(Q021FL-Q017FL)-((Q020FL-Q
     2016FL)**2+(Q021FL-Q017FL)**2)*(Q019FL-Q017FL))/SMAL(((Q018FL-Q016F
     3L)**2+      (Q019FL-Q017FL)**2)*(Q020FL-Q016FL)-((Q020FL-Q016FL)**
     42+(Q021FL-Q017FL)**2)*(Q018FL-Q016FL))
      SQRT(Q050FL) = DSQRT(Q050FL)
      ATAN(Q050FL) = DATAN(Q050FL)
C
C...  DEFINE TANF SO THAT ITS MAXIMUM MAGNITUDE IS 10**9
C
      TAN(Q022FL)=DSIN(Q022FL)/(DSIGN( DMAX1(DABS(DCOS(Q022FL)),1.D-9)
     1 ,DCOS(Q022FL)))
C
C
      XA = 0.
      GA = 0.
 9986 CONV=57.295779513082321
      KK=IDEFTB(11)-1
      DO 184 J=1,KK
      K=7*J+13
      A=D(K)
      B=D(K+1)
      R=SQRT(A*A+B*B)
      TH(J)=ATAN(B/SMAL(A))*CONV
      XL(J)=SQRT((D(K+7)-D(K))**2+(D(K+8)-D(K+1))**2)
      GA1=GA
      GA=ATAN(D(K+3))*CONV
      IF(J-1)175,176,175
  175 IF(J-KK)179,176,179
  176 XA=0.0
      GO TO 182
  179 XA=GA-GA1
  182 IF(KDBUG)183,184,183
  183 IF(J-1)186,185,186
  185 WRITE(IOUTAP,1102)EINAME,NAMSUB
      WRITE (IOUTAP,1109)
  186 WRITE (IOUTAP,1110)J,TH(J),R,A,B,D(K+4),GA,XA
  184 CONTINUE
C
C...  WRITE OUT RESULTS OF CURVATURE MATCHING
C
      DO 189 J=1,KK
      K=7*J+13
      PHI=ATAN(-1.0/SMAL(D(K+2)))*CONV
      AL=PHI-TH(J)
      IF(J-KK)1861,1862,1861
 1861 TA=(D(K+2)-D(K+3))/(1.0+D(K+2)*D(K+3))
      TB=(D(K+9)-D(K+3))/(1.0+D(K+9)*D(K+3))
      GO TO 1863
 1862 TA=0.0
      TB=0.0
      D(K+5)=0.0
 1863 CA(J)=CRVA(TA,TB,XL(J))
      IF(KDBUG)1864,189,1864
 1864 IF(J-1)188,187,188
  187 WRITE(IOUTAP,1102)EINAME,NAMSUB
      WRITE (IOUTAP,1111)
  188 WRITE (IOUTAP,1112)J,D(K+2),PHI,AL,TA,TB,CA(J),D(K+5)
  189 CONTINUE
C
C...  PLOT THE (MATCHED) CURVATURE AT EACH TABCYL POINT
C
      DO 190 I=1,7
  190 M(I)=0
      TABLX(1)=0.0
      TABLX(2)=0.1
      TABLX(3)=0.2
      TABLX(4)=0.5
      TABLX(5)=1.0
      TABLX(6)=2.0
      TABLX(7)=5.0
      TABLX(8)=10.0
      KL=KK-1
      DO209J=1,KK
      IF(J-1)219,219,223
  219 WRITE(IOUTAP,1102)EINAME,NAMSUB
  112 CMIN=1.E10
      CMAX=-1.E10
      DO105L=1,KL
      CMIN=DMIN1(CMIN,CA(L))
  105 CMAX=DMAX1(CMAX,CA(L))
      CEN2=(CMAX-CMIN)/2.0
      DO107L=1,7
      IF(CEN2-TABLX(L))106,107,107
  107 CONTINUE
      L=8
  106 CURVRG=TABLX(L)
      CEN1=10.0/CURVRG
      CENTER=CEN2+CMIN
      IDOODL = IDINT(CENTER*CEN1 + DSIGN(0.5D+0,CENTER))
      CENTER = IDOODL
      CENTER = CENTER/CEN1
      M(7)=CRV(0.0)
      CURTI1=CENTER-CURVRG
      CURTI2=CENTER-0.5*CURVRG
      CURTI4=CENTER+0.5*CURVRG
      CURTI5=CENTER+CURVRG
      WRITE (IOUTAP,1103)CURTI1,CURTI2,CENTER,CURTI4,CURTI5
      WRITE (IOUTAP,1104)
  223 M(2)=CRV(CA(J))
C
C...  GRAPH SUBROUTINE
C
 7911 DO7901 I=1,3
 7901 FMT(I)=FOR(I)
      FMT(4)=FOR(10)
      DO7902 I=5,105
 7902 FMT(I)=FOR(11)
      FMT(106)=FOR(12)
      DO7903 I=1,7
      IF(M(I))7909,7912,7905
 7909 MM(I)=5
      GO TO 7903
 7912 MM(I)=0
      GO TO 7903
 7905 MM(I)=M(I)
      IF(MM(I).GT.101)MM(I)=101
      MM(I)=MM(I)+4
 7903 CONTINUE
      DO7904 I=1,6
      I1=I+1
      DO 7904 I2=I1,7
      IF(MM(I)-MM(I2))7904,7906,7904
 7906 MM(I2)=0
 7904 CONTINUE
      DO 7907 I=1,7
      IF(MM(I))7907,7907,7908
 7908 J2=MM(I)
      K=I+3
      FMT(J2)=FOR(K)
 7907 CONTINUE
      WRITE (IOUTAP,FMT)J,CA(J)
  209 CONTINUE
      WRITE (IOUTAP,1104)
 1102 FORMAT(22H TABULATED CYLINDER   ,A6,1H(,I5,1H))
 1103 FORMAT(1H016X,F7.4,3(18X,F7.4),14X,F7.4)
 1104 FORMAT(120H    CURVATURE    .+........................+...........
     1.............+........................+........................+.)
 1109 FORMAT(109H0 NUM        THETA        RADIUS          X-C0RD
     1Y-CORD      SEG LENGTH       SEG ANGLE      EXT ANGLE )
 1110 FORMAT(1H I4,F15.4,4F15.6,2F15.4)
 1111 FORMAT(89H0 NUM     SLOPE        NORMAL      ALPHA   TANGENT A   T
     1ANGENT B     CURV A    DELTA CURV)
 1112 FORMAT(1H I4,F12.5,2F12.4,2F12.7,F10.4,F13.4)
      M1=6*IDEFTB(11)+9
 8020 RETURN
      END

