      SUBROUTINE AMON1
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4,MODIFICATION 4 ***
C
      IMPLICIT REAL*8(A-H,O-Z)
      REAL*8 INWORD,NEWONE,NAME,IDIS,MACNAM,KRFSYS
      INTEGER PUNTAP
       INTEGER DEBUG,SUM
C     THIS PROGRAM PUTS ONE CARD INTO THE INWORD ARRAY FOR PROCESSING
C     IF A LOOP IS BEING EXECUTED, THE DATA COMES FROM THE NEWONE ARRAY.
C     IF A MACRO IS BEING EXECUTED, THE DATA COMES FROM CANON
C     OTHERWISE, THE DATA IS READ FROM THE INPUT FILE
C          COMMON  STORAGE
C               *          *          *          *          *
      COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1
     1 ,TAPES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
      EQUIVALENCE(POCTAP,PTPTAP),(TAPES4,ERRTAP)
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
      COMMON/AMCSTF/MACNAM(5),MACCUR,MACLCN(5),MACRD,MACSTR(5),NMACVR
     1 ,NUMIDS,IDLOCN,MACIDS(5),ISVID
      COMMON/AMOTCM/PINT(30),IFURST,JPTIND,NOW,JSUB,KRESLT,KRSLT2
     1,NWDS,ITS,NEXT,MULTAX
      COMMON/A0CON/K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,K10,K11,K12,IBLANK
      COMMON/AMXTAB/MAXTAB,MAXVS1,MAXVS2,MAXPTP,MAXSCL,MAXVS,MAXVST,MXPT
     1PP,MXCAN,MXSRCN,MAXSLR,MAXELM,MAXPOT
      COMMON/AILMTB/ELMENT(600),ICLASS(600),JLMENT
      COMMON/AINPOT/INWORD(14),MORE,IFIRST
       DIMENSION JINWRD(28),IPPSQ2(2)
       EQUIVALENCE (INWORD(1),JINWRD(1))
      COMMON/ASCALR/SCALR(180),ISCWS,NSURF,LOCTEM,IARGTP
      COMMON/AVST/VST(7200)
       DIMENSION CANON(7200),ICANON(14400),IVST(14400),IPT(600)
       EQUIVALENCE (CANON(1),ICANON(1),VST(1),IVST(1))
      COMMON/ABREAK/NEXTNW,NRELCN,KANLCN,LOCSEQ,NEXTCN,NWONRD,LPLOCN,
     1 JSW4,ISN,K,MXLOOP,JSW2,JSAV,JSW1,MAXMV,MXNEST,INILL,KF
      COMMON/AMACRO/LIMCAN,LMDW,NITEMS,JWHAT,MACREC,MACVST,MACERR
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
      COMMON/ADATA1/ANODEF,BLANX,BLANKS,SYN,TLAXIS,DUMMY,PLENT,LOOPST
     1 ,LOOPND,MACRO,NTRMAC,NCALL,LAPTH,JAPTH,IPLUS,NCOMMA,IFF,IC(10),
     2 LLASS
      COMMON/AKLAS7/PPSEQ1,PPSEQ2,IDIS,IISN,IDVST,KFK
      EQUIVALENCE (IPT(1),PT(1))
      COMMON/ALIBRY/AMACVR(50),AMACVL(50),MACICL(50),DEFNAM,SEGNAM
     1 ,IVARCT,ISYSMC,IRDMOD,LUUP,NWUNRD,NOLIBR
       EQUIVALENCE (PPSEQ2,IPPSQ2(1)),(BLANKS,JBLANK)
      DATA FLAG/8HIOFLAG  /
   40 FORMAT(13A6,A2)
C
            IF(MACRD.LE.0) GO TO 110
C...  MACRO BEING EXECUTED - ADJUST POINTERS FROM CANON
   80  JTEMP1 = 2*KANLCN - 1
       NEXTCN = ICANON(JTEMP1+1)
C...  GET LENGTH OF THIS ENTRY
       KANLTH = IABS(NEXTCN) - NRELCN - 1
       J = KANLCN + 1
C...  MOVE DATA
       DO 90  I = 1,KANLTH
      INWORD(I)=CANON(J)
   90  J = J + 1
C...  ADJUST POINTERS FOR NEXT TIME
       KANLCN = KANLCN + KANLTH + 1
       LOCSEQ = KANLTH - 1
      NRELCN=IABS(NEXTCN)
      GO TO 200
C
  110       IF(NWONRD.LE.0) GO TO 180
C...  LOOP BEING EXECUTED
  130 CALL ATAPRD(ERRTAP,IOFLAG,NWRDS,4,IDM,1,IDM,1,LPLNGT,1,INWORD(1),0
     1)
      IF(IOFLAG) 135,1220,1230
  135 IF(LPLOCN.EQ.1) GOTO 160
  150  JSW4 = 0
C...  ADJUST POINTERS FOR NEXT TIME
  160  LPLOCN = 0
       LOCSEQ = LPLNGT - 1
       GO TO 200
C
C...  READ FROM PDS
  165 CALL APREAD (INWORD(1),IRDMOD,SEGNAM,JSUBER)
      IF (JSUBER.EQ.0) GO TO 166
      IF (JSUBER.NE.36) GO TO 998
      MACCUR = 0
      MACRD = 0
      NRELCN = MAXVST+1
      IDLOCN = 0
      IF (NWONRD.NE.0) GO TO 998
      LOOP = 0
      GO TO 998
C...  IF APREAD HAS REACHED END OF MEMBER, READ FROM SYSIN
  166 IF (IRDMOD.EQ.0) GO TO 167
      GO TO 168
C
C...  DATA COMES FROM INPUT FILE
C...  CHECK IF READING FROM PDS
  180 IF (IRDMOD.NE.0) GO TO 165
  167 READ (INTAPE,40,END=1000) (INWORD(I),I=1,14)
C...     TEST FOR CONTINUATION CARD
  168       IF(MORE.GT.0) GO TO 181
C...     NO - SEE IF STATEMENT STARTS WITH FIXED-FIELD WORD
       ENTRY = INWORD(1)
       CALL ATBLKP(ENTRY,N,1)
            IF(N.NE.0) GO TO 182
C...     NOT FIXED-FIELD STATEMENT - TEST ALL CHARACTERS FOR VALID SET
  181  CALL ACHEDT (INWORD(1),IIER)
            IF(IIER.NE.0) JSUBER = IIER
  182  LOCSEQ = 13
            IF(MORE.GT.0) GO TO 185
C...  UPDATE COUNTER FOR INTERNAL STATEMENT NUMBER
       ISN = ISN + 1
      IISN=ISN
C
C...     IF DEBUG OUTPUT REQUESTED, WRITE A SOURCE RECORD
  185       IF(DEBUG.EQ.0) GO TO 192
C...     TEST FOR CONTINUATION CARD
            IF(MORE.GT.0) GO TO 190
       WRITE (IOUTAP,188) ISN,(INWORD(KK),KK=1,14)
  188  FORMAT (1H0,I5,2X,13A6,A2//)
       GO TO 192
C...     ISN SAME AS LAST - DO NOT PRINT
  190  WRITE (IOUTAP,191) (INWORD(KK),KK=1,14)
  191  FORMAT (1H0,7X,13A6,A2//)
C
C...     OUTPUT A CLASS ONE PTPP RECORD
  192  DO 193  I = 2,15
  193  PT(I) = INWORD(I-1)
       IPT(1) = 1
       IPT(2) = ISN
      IF(MACRD.GE.0) GO TO 195
      IPTP1 = 0
      IPTP2 = 15
      IRECN = IRECN + 1
      CALL ATAPWT(PTPTAP,IOFLAG,4,IRECN,1,IPTP1,1,IPTP2,1,PT(1),15)
      IF(IOFLAG.LT.0) GOTO 199
C... TAPE WRITING ERROR, OUTPUT THE  ER. VALUE IN THE IOFLAG
      GOTO 1250
C
  195 INPTP = 15
       JMODE = 5
      CALL APTPUT
      IF(JSUBER.EQ.12) GO TO 998
  199  JTEMP1 = 2*LOCSEQ - 1
       JINWRD(JTEMP1+3) = IISN
C
C...  STORE SEQUENCE NUMBERS AND INTERNAL STATEMENT NUMBERS
  200       IF(MORE.NE.0) GO TO 998
  210 PPSEQ1=INWORD(LOCSEQ)
      PPSEQ2 = INWORD(LOCSEQ+1)
       IPPSQ2(2) = JBLANK
       JTEMP1 = 2*LOCSEQ - 1
       IISN = JINWRD(JTEMP1+3)
  998 RETURN
C..
C..  DID  FINI  TERMINATE PREVIOUS PART PARGOGRAM
 1000 IF (ISN.NE.0) GO TO 1200
 1010 WRITE (IOUTAP,1100)
 1100 FORMAT(//// '  * * * END OF APT PROCESSING * * * * * *  ' )
      CALL APTOUT
C...
C..  IMPROPER TERMINATION OF PREVIOUS PART PROGR. MAYBE NO FINI FOUND
C... OUTPUT A CLASS 2 PTPP  ERROR DIAGNOSTIC RECORD
 1200 JSUBER = 23
      CALL AFINI
      GOTO 998
C
C..  LOOPND  MISSING -- THE EOF READ ON ERRTAP
 1220 JSUBER = 212
      SUM = 0
      GOTO 1240
C
C..   I/O ERROR WHILE READING LOOP FROM STORAGE FILE --LOOP EXEC. MODE
C.
 1230 JSUBER = 181
C
C..   OUTPUT THE VAL. OF THE IOFLAG AND THE  INDICATOR IN THE
C.. COMMON VAR. SYM. 'NAME'  -- THE CLASS TWO PTPP PRINT OUT WILL BE
C..          CARD NO. XXXX   ISN XXX  ERROR NO.    IOFLAG ( VAL )
 1235 NAME = FLAG
      PT(7) = IOFLAG
      SUM = 9
C.  IF DEFINING A MACRO RETURN TO CALLING PROGRAM--OTHERWISE TURN
C..  OFF THE LOOP MODE AND OUTPUT THE PTPP CLASS 19 REC. FOR PASS TWO
      IF(MACRD.NE.0) RETURN
 1240 CALL ADIAGP
C...    TURN OFF THE LOOP EXECUTION MODE --OUTPUT CLASS 19 FOR PASS 2
      LOOP = 0
      NWONRD = 0
      JSW4 = 1
C...   REWIND THE LOOP STORAGE FILE
      CALL ATAPOP(ERRTAP,1,IOFLAG)
      IPT(1) = 19
      IPT(2) = 1
      PT(2) = 0.0D0
      INPTP = 2
      JMODE = 5
      CALL APTPUT
      RETURN
C
C..   I/O ERROR WRITING MACRO CLASS 1 RECORDS ONTO THE PTPTAP
C    MACRO DEFINITION MODE
 1250  JSUBER = 302
      GOTO 1235
      END

