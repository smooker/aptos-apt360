      SUBROUTINE AMON4
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
      IMPLICIT REAL*8(A-H,O-Z)
       LOGICAL*1 LCLAS1(2400),GCL(2)
       REAL*8 INWORD,NAME,IDIS,MACNAM,KRFSYS
       INTEGER DEBUG,SUM
      INTEGER CHAR
       INTEGER*2 KCL/0/,KLOOPC(4)/1,Z0B02,2,Z0B02/
C...     THIS ROUTINE STORES STATEMENTS OF LOOP AND MACRO DEFINITIONS.
C...     BLANKS ARE REMOVED FROM THE DATA IN INWORD, WHICH IS THEN
C...     STORED ON AN EXTERNAL FILE IF PART OF A LOOP, AND IN PTPP IF
C...     PART OF A MACRO. (MACROS ARE MOVED TO CANON WHEN TERMAC FOUND)
C          COMMON  STORAGE
C               *          *          *          *          *
      COMMON/A0CON/K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,K10,K11,K12,IBLANK
      COMMON/ATAPTB/PROTAP,CANTAP,CLTAPE,POCTAP,PLOTAP,SRFTAP,TAPES1,TAP
     1ES2,TAPES3,TAPES4,INTAPE,IOUTAP,PUNTAP
      EQUIVALENCE(TAPES4,ERRTAP)
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
      COMMON/AMXTAB/MAXTAB,MAXVS1,MAXVS2,MAXPTP,MAXSCL,MAXVS,MAXVST,MXPT
     1PP,MXCAN,MXSRCN,MAXSLR,MAXELM,MAXPOT
      COMMON/AILMTB/ELMENT(600),ICLASS(600),JLMENT
       EQUIVALENCE (ICLASS(1),LCLAS1(1))
      COMMON/AINPOT/INWORD(14),MORE,IFIRST
      COMMON/ASCALR/SCALR(180),ISCWS,NSURF,LOCTEM,IARGTP
      COMMON/AVST/VST(7200)
       DIMENSION PTPP(7200),IPTPP(14400)
       EQUIVALENCE (PTPP(1),IPTPP(1),VST(1))
      COMMON/ABREAK/NEXTNW,NRELCN,KANLCN,LOCSEQ,NEXTCN,NWONRD,LPLOCN,
     1 JSW4,ISN,K,MXLOOP,JSW2,JSAV,JSW1,MAXMV,MXNEST,INILL,KF
       COMMON/AMACRO/LIMCAN,LMDW,NITEMS,JWHAT,MACREC,MACVST,MACERR
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
       DIMENSION JINWRD(28)
       EQUIVALENCE (INWORD(1),JINWRD(1))
      COMMON/AMCSTF/MACNAM(5),MACCUR,MACLCN(5),MACRD,MACSTR(5),NMACVR
     1 ,NUMIDS,IDLOCN,MACIDS(5),ISVID
      COMMON/ADATA1/ANODEF,BLANX,BLANKS,SYN,TLAXIS,DUMMY,PLENT,LOOPST
     1 ,LOOPND,MACRO,NTRMAC,NCALL,LAPTH,JAPTH,IPLUS,NCOMMA,IFF,IC(10),
     2 LLASS
      COMMON/ASCANC/CHAR,N72,NF,ICHAR,NUMCOL,MDOLAR,JSKIP
      COMMON/AKLAS7/PPSEQ1,PPSEQ2,IDIS,IISN,IDVST,KFK
       EQUIVALENCE (KCL,GCL(1)),(KLOOPC(1),LOOPBG),(KLOOPC(3),LOOPTM)
C
C...    IS MACRO TOO LARGE - YES, SUPRESS ERROR PRINT THIS TIME
      IF(JSAV.EQ.1) GO TO 665
  630  N = 0
C
C...     SET WORD COUNT FOR STORAGE OF SOURCE TEXT
      N = 14
C...     WORD COUNT INITIALIZED FOR FIXED-FIELD - SEE IF IT IS
       GCL(2) = LCLAS1(3)
            IF(KCL.EQ.1) GO TO 635
       N = NUMCOL/8 + 2
       NOTQT = 8*N - 16
      IF(NOTQT.NE.NUMCOL) GOTO 633
       N = N - 1
  633 INWORD(N)=INWORD(13)
       N = N + 1
       INWORD(N) = INWORD(14)
C
C...     DETERMINE WHETHER STATEMENT IS IN A LOOP OR A MACRO
  635 IF (MACRD.GE.0) GO TO 650
      J = NEXTNW + N
  639 IF(J.LE.MXPTPP+MAXVST) GO TO 662
      JSAV = 1
       JSUBER = 18
C...     SET FLAG TO CANCEL STORAGE OF MACRO
       MACERR = 1
      GO TO 998
C
C...     STORE STATEMENT OF LOOP AREA ON EXTERNAL FILE
  650  JTEMP1 = 2*N - 1
       JINWRD(JTEMP1+1) = IISN
       CALL ATAPWT(ERRTAP,IOFLAG,4,IDM,1,IDM,1,N,1,INWORD(1),N)
C...     CHECK FOR ID - (THE POINTER K IS SET TO FIRST ENTRY IN ELMENT
C...     TABLE EXCLUSIVE OF ID)
       GO TO 665
C
C...     STORE STATEMENT OF MACRO IN PTPP
  662  JTEMP1 = 2*NEXTNW - 1
       IPTPP(JTEMP1) = 0
       IPTPP(JTEMP1+1) = J + 1
       DO 663  I = 1,N
       NEXTPI = NEXTNW + I
  663  PTPP(NEXTPI) = INWORD(I)
       NEXTNW = J + 1
       JTEMP1 = 2*J - 1
       IPTPP(JTEMP1+1) = IISN
C
  665       IF(JLMENT.LE.2) GO TO 690
C...     TEST 2ND STATEMENT ELEMENT FOR RIGHT PAREN TERMINATING AN ID
       GCL(2) = LCLAS1(8)
            IF(KCL.NE.4) GO TO 690
       GCL(2) = LCLAS1(7)
            IF(KCL.NE.7) GO TO 690
  680  K = 3
      GO TO 700
  690  K = 1
C
C...     TEST FOR LOOPST IN A MACRO DEFINITION - ERROR
  700       IF(ICLASS(K).NE.LOOPBG) GO TO 702
            IF(MACRD.LT.0) GO TO 704
C
C...     TEST FOR LOOPND
  702       IF(ICLASS(K).NE.LOOPTM) GO TO 720
C...     LOOPND FOUND - IF THIS IS MACRO MODE, ERROR
            IF(MACRD.EQ.0) GO TO 706
  704  JSUBER = 210
       GO TO 998
  706  NITEMS = J
       LPLOCN = 1
            IF(JSAV.EQ.0) GO TO 715
C...  LOOP TOO LARGE
       NWONRD = 0
       LOOP = 0
      JSUBER = JSAV
       JSAV = 0
      GO TO 998
C
C...  SET FLAGS TO EXECUTE THE LOOP
  715  NWONRD = 1
      CALL ATAPOP(ERRTAP,2,IOFLAG)
      CALL ATAPOP (ERRTAP,1,IOFLAG)
       JMODE = 6
      CALL APTPUT
            IF(JSUBER.NE.0) GO TO 998
C
  720       IF(JSW2.EQ.0) GO TO 998
C...  MACRO WAS BEING PROCESSED
      NEXTNW = MAXVST + 1
       JSW2 = 0
      MACRD = 0
      LOOP = 0
C...     IF ERROR IN MACRO DEFINITION, DO NOT STORE IN CANON
            IF(MACERR.NE.0) GO TO 998
  725 NITEMS = J - MAXVST
  730  CALL APRINT(2)
       JWHAT = 2
C...  MOVE MACRO TO CANON
      CALL AMATMV
            IF(JSUBER.NE.0) GO TO 998
       CALL APRINT(3)
  998 RETURN
      END

