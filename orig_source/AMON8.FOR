      SUBROUTINE AMON8
C     *** THIS PROGRAM LAST MODIFIED FOR VERSION 4, MODIFICATION 3 ***
      IMPLICIT REAL*8(A-H,O-Z)
       REAL*8 INWORD,NAME,KRFSYS
       INTEGER DEBUG,SUM
       INTEGER LCLAS2*2(1200),LMENT4*4(1200)
       LOGICAL*1 LCLAS1(2400),ITYPE1(8)
C     THIS PROGRAM REMOVES NESTED COMPUTING AND/OR GEOMETRIC DEFINITIONS
C      IT VERIFIES THEIR EXISTANCE, PROCESSES THEM, THEN REMOVES THEM
C     FROM THE ELMENT TABLE, LEAVING A POINTER TO WORKING STORAGE IN THE
C     ELMENT TABLE ENTRY FOR THE LEFT PARENTHESIS OF THE NES
C          COMMON  STORAGE
C               *          *          *          *          *
      COMMON/A1COM/NAME,KRFSYS,SUM,JSUBER,NAMSUB,DEBUG,INDXPT,LOOP,IFINI
      COMMON/AMXTAB/MAXTAB,MAXVS1,MAXVS2,MAXPTP,MAXSCL,MAXVS,MAXVST,MXPT
     1PP,MXCAN,MXSRCN,MAXSLR,MAXELM,MAXPOT
      COMMON/AILMTB/ELMENT(600),ICLASS(600),JLMENT
      COMMON/ASCALR/SCALR(180),ISCWS,NSURF,LOCTEM,IARGTP
       COMMON/APARTB/ILPCNT,IRPCNT,LSTNST
      COMMON/APRTAB/ISTARP,IENDP,NMOVE,NL,ITSQ,LINDX
      COMMON/AVST/VST(2750),PTPP(2225),CANON(2225)
      COMMON/ABREAK/NEXTNW,NRELCN,KANLCN,LOCSEQ,NEXTCN,NWONRD,LPLOCN,
     1 JSW4,ISN,K,MXLOOP,JSW2,JSAV,JSW1,MAXMV,MXNEST,INILL,KF
       COMMON/ADATA1/ANODEF,BLANX,BLANKS,SYN,TLAXIS,DUMMY,PLENT,LOOPST
     1 ,LOOPND,MACRO,NTRMAC,NCALL,LAPTH,JAPTH,IPLUS,NCOMMA,IFF,IC(10),
     2 LLASS
      COMMON/APTPP/PT(300),INPTP,NW,JMODE,KLASS,KLASTP,IRECN,NPT,NPR
      DIMENSION IPT(600)
      EQUIVALENCE (PT(1),IPT(1))
       EQUIVALENCE (ICLASS(1),LCLAS2(1),LCLAS1(1)),
     1 (ELMENT(1),LMENT4(1))
       EQUIVALENCE (ITYPE1(1),ITYPE), (ITYPE1(5),IPUNCT)
C
       LISTNO = 1
       ITYPE = 0
       IPUNCT = 0
C
C...     TEST FOR (MORE) NESTS IN THE STATEMENT
   50       IF(LSTNST.NE.0) GO TO 70
C
C...     NO (MORE) NESTS - SET UP INDICES FOR FULL STATEMENT
       INDXY = INILL - 1
       IENDP = JLMENT + 1
       ICLASS(IENDP) = JAPTH
C...     SET INDICATOR TO SHOW STATEMENT BEING PROCESSED
       LSTNST = -1
       GO TO 80
C
C...     THERE ARE MORE NESTS - SET UP INDICES FOR NEXT ONE
   70  INDXY = LSTNST
       INDX2 = 2*INDXY - 1
       IENDP = LMENT4(INDX2)
C...     PUT POINTER TO FOLLOWING NEST (IF ANY) INTO NEST INDICATOR
       LSTNST = LMENT4(INDX2+1)
C
   80  ISTARP = INDXY + 1
       IENTRY = ISTARP
C...     DETERMINE THE TYPE OF THIS NEST
       KEQ = 0
       ILOC = 4*INDXY - 3
C
   90  NXLOC = ILOC
       ITYPE1(4) = LCLAS1(ILOC+7)
C...     IF ICLASS TYPE GREATER THAN 6, IT IS MEANINGLESS
            IF(ITYPE.GT.6) GO TO 1950
C...     BRANCH ON CODE TYPE
       GO TO (100,200,300,400,300,1880),ITYPE
C
C...     VARIABLE SYMBOL - CHECK FOR SUBSCRIPT
  100  ITYPE1(4) = LCLAS1(ILOC+11)
            IF(ITYPE.LT.7) GO TO 110
C...     SUBSCRIPT FOUND - SKIP IT
       NXLOC = NXLOC + 4
       IENTRY = IENTRY + 1
C
C...     IF PUNCTUATION FOUND BEFORE VARIABLE, NOT LOOKING FOR = SIGN
  110       IF(KEQ.NE.0) GO TO 300
C...     = SIGN FOLLOWING VARIABLE ACCEPTABLE - DO WE HAVE ONE
       ITYPE1(4) = LCLAS1(NXLOC+11)
            IF(ITYPE.NE.4) GO TO 1960
       ITYPE1(8) = LCLAS1(NXLOC+10)
            IF(IPUNCT.EQ.8) GO TO 120
C...     NO = SIGN FOUND
C...     IF STATEMENT BEING PROCESSED, MUST HAVE IT HERE, OR ERROR
            IF(LSTNST.LT.0) GO TO 1955
C
C...     SEE IF ONLY ONE PARAMETER IN NEST
            IF(IENDP.GT.IENTRY+1) GO TO 310
C...     SINGLE VARIABLE, POSSIBLY SUBSCRIPTED - DOES NEST
C...     IMMEDIATELY FOLLOW A VARIABLE
       ITYPE1(4) = LCLAS1(ILOC-1)
            IF(ITYPE.EQ.1) GO TO 1850
C...     NO - IF NEST IS FUNCTION ARGUMENT, SET UP PARAMETER RECORD
            IF(ITYPE.NE.2) GO TO 1874
       ITYPE1(4) = LCLAS1(ILOC-2)
            IF(ITYPE-19)  1874, 1880, 1874
C
C...     = SIGN FOUND - TEST FOLLOWING ENTRY FOR SURFACE TYPE
  120  ITYPE1(4) = LCLAS1(NXLOC+14)
            IF(ITYPE.EQ.24) GO TO 1872
C...     NO - SCALAR ASSIGNMENT
       GO TO 1870
C
C...     VOCABULARY - IF PROCESSING A STATEMENT, EXIT
  200       IF(LSTNST.LT.0) GO TO 1920
C...     STARTING A NEST - IS VOCAB. AN ARITHMETIC FUNCTION
       ITYPE1(4) = LCLAS1(NXLOC+6)
            IF(ITYPE.EQ.19) GO TO 1850
C...     NO - IS ANY OTHER VOCAB. ACCEPTABLE
            IF(KEQ.NE.0) GO TO 1850
C...     YES - TEST FOR SURFACE TYPE
            IF(ITYPE.EQ.24) GO TO 1872
C...     NO - PARAMETER LIST
       GO TO 1880
C
C...     NUMBER OR COMPUTED EXPRESSION - TEST FOR COMMA FOLLOWING
  300  ITYPE1(4) = LCLAS1(NXLOC+11)
            IF(ITYPE.NE.4) GO TO 1970
       ITYPE1(8) = LCLAS1(NXLOC+10)
  310       IF(IPUNCT.NE.9) GO TO 1850
C...     YES - PARAMETER LIST
       GO TO 1880
C
C...     FIRST CODE IS PUNCTUATION - SET FLAG TO INDICATE IT
  400  KEQ = 1
C...     INCREMENT PICKUP INDEX TO NEXT ENTRY
       ILOC = ILOC + 4
       GO TO 90
C
C...     NEST IS COMPUTING EXPRESSION OR SINGLE SCALAR
 1850  ISTARP = INDXY
       ITSQ = 1
            IF(IENDP.GT.ISTARP+2) GO TO 1864
C...     SINGLE SCALAR - SUBSCRIPT IF PRECEDED BY VARIABLE SYMBOL
       ITYPE1(4) = LCLAS1(ILOC-1)
            IF(ITYPE.EQ.1) GO TO 1900
C
C...     SET UP PTPP CLASS 12 RECORD HEADER
 1864  IPT(1) = 12
C...     TEST FOR SUFFICIENT ROOM IN SCALAR TABLE FOR NEST RESULT
           IF(ISCWS.LE.180) GO TO 1866
       JSUBER = 62
       GO TO 1920
C
C...     PUT INDEX TO STORAGE FOR NEST RESULT INTO PTPP AND ELMENT
 1866  IPT(3) = ISCWS
       IPT(4) = 0
       LMENT4(INDX2+1) = ISCWS
       LMENT4(INDX2) = 0
       ISCWS = ISCWS + 1
C
C...     PROCESS NEST
       INPTP = 3
      CALL AEXPRS
C...     GO TO SQUEEZE THE ELMENT TABLE
       GO TO 1900
C
C...     SCALAR ASSIGNMENT NEST
 1870 CALL ANEST
       GO TO 1874
C
C...     GEOMETRIC NEST
 1872  ITSQ = 3
       CALL ADFPRO
C
C...     IF STATEMENT JUST PROCESSED, GO TO EXIT
 1874       IF(LSTNST.LT.0) GO TO 1920
C
C...     IT WAS A NEST - SET FLAG TO INDICATE ASSIGNMENT TYPE
       ITSQ = 3
       GO TO 1900
C
C...     NEST IS ARGUMENT LIST
 1880  ISTARP = INDXY
       ITSQ = 2
C
C...     SET UP PTPP CLASS 20 RECORD HEADER
       IPT(1) = 20
C...     TEST FOR SUFFICIENT ROOM IN TABLE FOR DATA BLOCK INDEX
            IF(LISTNO.LE.10) GO TO 1884
       JSUBER = 70
       GO TO 1920
C
C...     PUT INDEX TO DATA BLOCK POINTER LOCATION INTO PTPP
C...     AND ELMENT
 1884  IPT(3) = LISTNO
       IPT(4) = 0
       LMENT4(INDX2+1) = LISTNO
       LMENT4(INDX2) = 0
       LISTNO = LISTNO + 1
C...     PROCESS THE NEST
       INPTP = 3
       CALL AEXPRS
C
 1900       IF(JSUBER.NE.0) GO TO 1920
C...     REMOVE PROCESSED NEST FROM THE ELMENT TABLE
       ISTARP = INDXY
       CALL ASQILT(NMOVE)
       CALL APRINT(5)
       LINDX = LINDX - NMOVE
       GO TO 50
C
C...     ALL NESTS REMOVED
C...     RESET SCALAR TABLE STORING INDEX
 1920 ISCWS = 1
       CALL APRINT(1)
       ISTARP = INILL
      IENDP=JLMENT
  998 RETURN
C
 1950  JSUBER = 6110
       GO TO 1920
C..
C.. VARIABLE SYMBOL IS NOT FOLLOWED BY AN EQUAL SIGN
 1955  SUM = 1
       NAME = ELMENT(INILL)
 1960  JSUBER = 82
      GO TO 1920
C..
C..    PUNCTUATION IS MISSING
 1970 JSUBER = 78
      GO TO 1920
      END

